<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>CSZ CMS 1.2.7 储存型xss</h1><h2>一、漏洞简介</h2><p>拥有访问私有消息的未授权用户可以向管理面板嵌入Javascript代码。</p><h2>二、漏洞影响</h2><p>CSZ CMS 1.2.7</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>查看数据库中的email_logs可知，将访问的user-agent存储到了数据库中<br />1.png</p><p>我们首先观察路由，漏洞点在/member/insertpm页面，查看控制器，找到cszcms/controllers/Member.php</p><p>2.png<br />找到insertpm方法：</p><p>3.png<br />关注点在下半部分：</p><p>$this-&gt;input-&gt;post即是调用的system/core/Input.php的post方法：</p><p>4.png<br />当$xss_clean的参数设置为true，则会进行xss过滤，这也是为什么发送信息处并没有出现xss</p><p>继续看，$this-&gt;Csz_auth_model-&gt;send_pm方法位于cszcms/models/Csz_auth_model.php中的send_pm():</p><p>/**<br />     * Send multiple Private Messages<br />     * Send multiple private messages to another users<br />     * <br />     * @param array $receiver_ids Array of User ids of private message receiver <br />     * @param string $title Title/subject<br />     * @param string $message Message<br />     * @param int $sender_id User id of private message sender<br />     * @param string $re_message Reply the original message<br />     * <br />     * @return array/bool Array with User ID's as key and TRUE or a specific error message OR FALSE if sender doesn't exist<br />     */<br />    public function send_pm($receiver_ids, $title, $message, $sender_id = '', $re_message = '') {<br />        if (!$sender_id) {<br />            $sender_id = $this-&gt;session-&gt;userdata('user_admin_id');<br />        }<br />        if ($sender_id &amp;&amp; (!$this-&gt;is_useractive($sender_id))) {<br />            return FALSE;<br />        }else{<br />            if ($receiver_ids &amp;&amp; is_numeric($receiver_ids) &amp;&amp; $sender_id != $receiver_ids) {<br />                if($re_message){ <br />                    $message = '{[' . str_replace(&quot;\r\n&quot; . &quot;\r\n&quot;, &quot;\r\n&quot;, $re_message) . &quot;]} &quot; . &quot;\r\n&quot; . &quot;\r\n&quot; . $message;<br />                }<br />                $data = array(<br />                    'sender_id' =&gt; $sender_id,<br />                    'receiver_id' =&gt; $receiver_ids,<br />                    'title' =&gt; $title,<br />                    'message' =&gt; $message,<br />                    'date_sent' =&gt; date('Y-m-d H:i:s')<br />                );<br />                $this-&gt;db-&gt;insert('user_pms', $data);<br />                $sender_user = $this-&gt;Csz_admin_model-&gt;getUser($sender_id);<br />                $receive_user = $this-&gt;Csz_admin_model-&gt;getUser($receiver_ids);<br />                if($receive_user-&gt;pm_sendmail == '1'){<br />                    $config = $this-&gt;Csz_model-&gt;load_config();<br />                    $message_html = 'Dear ' . $receive_user-&gt;name . ',&lt;br&gt;&lt;br&gt;' . $message . '&lt;br&gt;&lt;br&gt;Best Regards,&lt;br&gt;'.$sender_user-&gt;name;<br />                    @$this-&gt;Csz_model-&gt;sendEmail($receive_user-&gt;email, '[PM] ' . $title . ' ('.$config-&gt;site_name.')', $message_html, $sender_user-&gt;email, $sender_user-&gt;name);<br />                }<br />                return TRUE;<br />            }else{<br />                return FALSE;<br />            }<br />        }<br />    }</p><p>调用了@$this-&gt;Csz_model-&gt;sendEmail方法，位于cszcms/models/Csz_model.php，我们继续跟进：</p><p>public function sendEmail($to_email, $subject, $message, $from_email, $from_name = '', $bcc = '', $reply_to = '', $alt_message = '', $attach_file = array(), $save_log = TRUE) {<br />        $this-&gt;load-&gt;library('email');<br />        $load_conf = $this-&gt;load_config();<br />        $protocal = $load_conf-&gt;email_protocal;<br />        if (!$protocal) {<br />            $protocal = 'mail';<br />        }<br />        $config = array();<br />        $config['useragent'] = $this-&gt;Csz_admin_model-&gt;cszGenerateMeta();<br />        $config['protocol'] = $protocal;  /* mail, sendmail, smtp */<br />        if ($protocal == 'smtp') {<br />            $config['smtp_host'] = $load_conf-&gt;smtp_host;<br />            $config['smtp_user'] = $load_conf-&gt;smtp_user;<br />            $config['smtp_pass'] = $load_conf-&gt;smtp_pass;<br />            $config['smtp_port'] = $load_conf-&gt;smtp_port;<br />        } else if ($protocal == 'sendmail' &amp;&amp; $load_conf-&gt;sendmail_path) {<br />            $config['mailpath'] = $load_conf-&gt;sendmail_path;<br />        }<br />        $config['mailtype'] = 'html';<br />        $config['charset'] = 'utf-8';<br />        $config['wordwrap'] = TRUE;<br />        $this-&gt;email-&gt;initialize($config);<br />        $this-&gt;email-&gt;set_newline("\r\n");<br />        $this-&gt;email-&gt;from($from_email, $from_name); // change it to yours<br />        $this-&gt;email-&gt;to($to_email); // change it to yours<br />        $this-&gt;email-&gt;subject($subject);<br />        $this-&gt;email-&gt;message($message);<br />        if ($bcc) {<br />            $this-&gt;email-&gt;bcc($bcc);<br />        }<br />        if($reply_to){<br />            $this-&gt;email-&gt;reply_to($reply_to);<br />        }<br />        if ($alt_message) {<br />            $this-&gt;email-&gt;set_alt_message($alt_message);<br />        }<br />        if (is_array($attach_file) &amp;&amp; !empty($attach_file)) {<br />            foreach ($attach_file as $value) {<br />                $this-&gt;email-&gt;attach($value, 'attachment');<br />            }<br />        }<br />        if ($this-&gt;email-&gt;send()) {<br />            $result = 'success';<br />        } else {<br />            $result = $this-&gt;email-&gt;print_debugger(FALSE);<br />        }<br />        if($save_log === TRUE &amp;&amp; $load_conf-&gt;email_logs == 1){<br />            $data = array(<br />                'to_email' =&gt; $to_email,<br />                'from_email' =&gt; $from_email,<br />                'from_name' =&gt; $from_name,<br />                'subject' =&gt; $subject,<br />                'message' =&gt; $message,<br />                'email_result' =&gt; $result,<br />            );<br />            $this-&gt;db-&gt;set('user_agent', $this-&gt;input-&gt;user_agent(), TRUE);<br />            $this-&gt;db-&gt;set('ip_address', $this-&gt;input-&gt;ip_address(), TRUE);<br />            $this-&gt;db-&gt;set('timestamp_create', $this-&gt;timeNow(), TRUE);<br />            $this-&gt;db-&gt;insert('email_logs', $data);<br />            $this-&gt;db-&gt;cache_delete_all();<br />            unset($data);<br />        }<br />        unset($to_email, $subject, $message, $from_email, $from_name, $bcc, $reply_to, $alt_message, $attach_file, $save_log, $config, $load_conf, $protocal);<br />        return $result;<br />    }</p><p>关键就在于后面的数据库操作：</p><p>$this-&gt;db-&gt;set('user_agent', $this-&gt;input-&gt;user_agent(), TRUE);<br />        $this-&gt;db-&gt;set('ip_address', $this-&gt;input-&gt;ip_address(), TRUE);<br />        $this-&gt;db-&gt;set('timestamp_create', $this-&gt;timeNow(), TRUE);<br />        $this-&gt;db-&gt;insert('email_logs', $data);<br />        $this-&gt;db-&gt;cache_delete_all();</p><p>$this-&gt;db-&gt;set方法位于：system/database/DB_query_builder.php：</p><p>/**<br /> * The "set" function.<br /> *<br /> * Allows key/value pairs to be set for inserting or updating<br /> *<br /> * @param   mixed<br /> * @param   string<br /> * @param   bool<br /> * @return  CI_DB_query_builder<br /> */<br />public function set($key, $value = '', $escape = NULL)<br />{<br />    $key = $this-&gt;_object_to_array($key);<br /><br />    if ( ! is_array($key))<br />    {<br />        $key = array($key =&gt; $value);<br />    }<br /><br />    is_bool($escape) OR $escape = $this-&gt;_protect_identifiers;<br /><br />    foreach ($key as $k =&gt; $v)<br />    {<br />        $this-&gt;qb_set[$this-&gt;protect_identifiers($k, FALSE, $escape)] = ($escape)<br />            ? $this-&gt;escape($v) : $v;<br />    }<br /><br />    return $this;<br />}</p><p>简单理解即为插入或更新值作初始化</p><p>继续，$this-&gt;input-&gt;user_agent()位于：system/core/Input.php，其具体实现如下：</p><p>/**<br /> * Fetch User Agent string<br /> *<br /> * @return  string|null User Agent string or NULL if it doesn't exist<br /> */<br />public function user_agent($xss_clean = NULL)<br />{<br />    return $this-&gt;_fetch_from_array($_SERVER, 'HTTP_USER_AGENT', $xss_clean);<br />}</p><p>这里的xss过滤操作默认是null，也就是没有过滤</p><p>这就是问题所在，我们即可以通过篡改user_agent的值实现xss，往下看，$this-&gt;db-&gt;insert('email_logs', $data)即向emali_logs表插入数据，$this-&gt;db-&gt;insert实现如下（system/core/Input.php）：</p><p>/**<br />     * Insert<br />     *<br />     * Compiles an insert string and runs the query<br />     *<br />     * @param   string  the table to insert data into<br />     * @param   array   an associative array of insert values<br />     * @param   bool    $escape Whether to escape values and identifiers<br />     * @return  bool    TRUE on success, FALSE on failure<br />     */<br />    public function insert($table = '', $set = NULL, $escape = NULL)<br />    {<br />        if ($set !== NULL)<br />        {<br />            $this-&gt;set($set, '', $escape);<br />        }<br /><br />        if ($this-&gt;_validate_insert($table) === FALSE)<br />        {<br />            return FALSE;<br />        }<br /><br />        $sql = $this-&gt;_insert(<br />            $this-&gt;protect_identifiers(<br />                $this-&gt;qb_from[0], TRUE, $escape, FALSE<br />            ),<br />            array_keys($this-&gt;qb_set),<br />            array_values($this-&gt;qb_set)<br />        );<br /><br />        $this-&gt;_reset_write();<br />        return $this-&gt;query($sql);<br />    }</p><p>依然没有任何过滤</p><p>然而，关于为什么登入后台即会弹窗，搜索一番后发现，开发者直接将其echo出来（cszcms/views/admin/home.php）：</p><p>5.png</p><p>6.png</p><h3>漏洞复现</h3><p>新建一个用户<br />1.png</p><p>点击inbox发送私信，选定管理员用户</p><p>2.png<br />修改User-Agent为alert(1)<br />3.png</p><p>管理员登陆后台即触发xss<br />4.png</p><h2>参考链接</h2><p>https://xz.aliyun.com/t/7730#toc-6</p></body></html>