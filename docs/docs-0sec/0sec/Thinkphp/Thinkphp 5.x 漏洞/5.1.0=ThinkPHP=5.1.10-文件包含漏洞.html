<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>5.0.0 &lt;= Thinkphp &lt;= 5.0.18 &amp; 5.1.0 &lt;= ThinkPHP &lt;= 5.1.10 文件包含漏洞</h1><h2>一、漏洞简介</h2><p>本次漏洞存在于 <strong>ThinkPHP</strong> 模板引擎中，在加载模版解析变量时存在变量覆盖问题，而且程序没有对数据进行很好的过滤，最终导致 <strong>文件包含漏洞</strong> 的产生。</p><h2>二、漏洞影响</h2><p>5.0.0 &lt;= Thinkphp &lt;= 5.0.18</p><p>5.1.0 &lt;= ThinkPHP &lt;= 5.1.10</p><h2>三、复现过程</h2><h3>漏洞环境</h3><p>通过以下命令获取测试环境代码：</p><p>composer create-project --prefer-dist topthink/think=5.0.18 tpdemo</p><p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p><p>"require": {<br />    "php": "&gt;=5.6.0",<br />    "topthink/framework": "5.0.18"<br />},</p><p>然后执行 composer update ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p><p>&lt;?php<br />namespace app\index\controller;<br />use think\Controller;<br />class Index extends Controller<br />{<br />    public function index()<br />    {<br />        $this-&gt;assign(request()-&gt;get());<br />        return $this-&gt;fetch(); // 当前模块/默认视图目录/当前控制器（小写）/当前操作（小写）.html<br />    }<br />}</p><p>创建 <strong>application/index/view/index/index.html</strong> 文件，内容随意（没有这个模板文件的话，在渲染时程序会报错），并将图片马 <strong>1.jpg</strong> 放至 <strong>public</strong> 目录下（模拟上传图片操作）。</p><h3>poc</h3><p>http://0-sec.org:8000/index/index/index?cacheFile=demo.php</p><p>接着访问链接，即可触发 <strong>文件包含漏洞</strong> 。</p><p>1.png</p><h3>漏洞分析</h3><p>首先在官方发布的 <strong>5.0.19</strong> 版本更新说明中，发现其中提到该版本包含了一个安全更新。</p><p>2.png</p><p>我们可以查阅其 <strong>commit</strong> 记录，发现其改进了模板引擎，其中存在危险函数 <strong>extract</strong> ，有可能引发变量覆盖漏洞。接下来，我们直接跟进代码一探究竟。</p><p>3.png</p><p>首先，用户可控数据未经过滤，直接通过 <strong>Controller</strong> 类的 <strong>assign</strong> 方法进行模板变量赋值，并将可控数据存在 <strong>think\View</strong> 类的 <strong>data</strong> 属性中。</p><p>4.png</p><p>接着，程序开始调用 <strong>fetch</strong> 方法加载模板输出。这里如果我们没有指定模板名称，其会使用默认的文件作为模板，模板路径类似 <strong>当前模块/默认视图目录/当前控制器（小写）/当前操作（小写）.html</strong> ，如果默认路径模板不存在，程序就会报错。</p><p>5.png</p><p>我们跟进到 <strong>Template</strong> 类的 <strong>fetch</strong> 方法，可以发现可控变量 <strong>$vars</strong> 赋值给 <strong>$this-&gt;data</strong> 并最终传入 <strong>File</strong> 类的 <strong>read</strong> 方法。而 <strong>read</strong> 方法中在使用了 <strong>extract</strong> 函数后，直接包含了 <strong>$cacheFile</strong> 变量。这里就是漏洞发生的关键原因（可以通过 <strong>extract</strong> 函数，直接覆盖 <strong>$cacheFile</strong> 变量，因为 <strong>extract</strong> 函数中的参数 <strong>$vars</strong> 可以由用户控制）。</p><p>6.png</p><h3>漏洞修复</h3><p>官方的修复方法是：先将 <strong>$cacheFile</strong> 变量存储在 <strong>$this-&gt;cacheFile</strong> 中，在使用 <strong>extract</strong> 函数后，最终 <strong>include</strong> 的变量是 <strong>$this-&gt;cacheFile</strong> ，这样也就避免了 <strong>include</strong> 被覆盖后的变量值。</p><p>3.png</p><h3>攻击总结</h3><p>最后，再通过一张攻击流程图来回顾整个攻击过程。</p><p>7.png</p><h2>参考链接</h2><p>https://github.com/Mochazz/ThinkPHP-Vuln</p></body></html>