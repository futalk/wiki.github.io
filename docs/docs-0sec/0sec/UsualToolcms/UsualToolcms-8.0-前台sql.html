<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>UsualToolcms 8.0 前台sql</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h3>漏洞分析</h3><p>search.php</p><p>$key=UsualToolCMS::sqlcheck($_GET["key"]);<br />$navname="search";<br />require_once(dirname(__FILE__).'/'.'mytop.php');<br />//搜索记录<br />if(!empty($key)):<br />$asql=&quot;SELECT * FROM `cms_search` WHERE keyword ='$key'&quot;;<br />$adata=mysqli_query($mysqli,$asql);<br />if(mysqli_num_rows($adata)&gt;0):<br />$mysqli-&gt;query(&quot;UPDATE `cms_search` SET `hit`=hit+1 WHERE keyword ='$key' and lang='$language'&quot;);<br />else:<br />$mysqli-&gt;query(&quot;INSERT INTO `cms_search` (`lang`,`keyword`) VALUES ('$language','$key')&quot;);</p><p>$key被sqlcheck函数过滤了，让我们看下这个函数</p><p>function sqlchecks($StrPost){<br />$StrPost=str_replace(&quot;'&quot;,&quot;’&quot;,$StrPost);<br />$StrPost=str_replace('&quot;','“',$StrPost);<br />$StrPost=str_replace("(","（",$StrPost);<br />$StrPost=str_replace(")","）",$StrPost);<br />$StrPost=str_replace("@","#",$StrPost);<br />$StrPost=str_replace("/*","",$StrPost);<br />$StrPost=str_replace("*/","",$StrPost);<br />return $StrPost;<br />}</p><p>如果没有Url编码的话这里应该是不存在漏洞的了，仔细看上面的代码，数据库操作中还有一个$language,我们追踪下$language吧</p><p>全局查找，直接找到其定义的地方</p><p>conn.php</p><p>if(!empty($_COOKIE['UTCMSLanguage'])):$language=$_COOKIE['UTCMSLanguage'];else:$language=$indexlanguage;endif;</p><p>$language没有经过任何过滤就从Cookie传了进来</p><p>这就简单咯</p><h3>复现</h3><p>image</p></body></html>