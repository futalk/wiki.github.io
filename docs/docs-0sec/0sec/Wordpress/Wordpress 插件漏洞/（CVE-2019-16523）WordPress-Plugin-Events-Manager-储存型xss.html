<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-16523）WordPress Plugin - Events Manager 储存型xss</h1><h2>一、漏洞简介</h2><p>WordPress的5.9.5版以上的事件管理器插件（又名“事件管理器”）容易受到存储的XSS的影响，这是由于编码不正确和插入提供给该插件提供的短码属性map_style（locations_map和events_map）的数据所致。</p><h2>二、漏洞影响</h2><p>wordpress &lt;= 5.9.5</p><h2>三、复现过程</h2><h3>1、利用过程</h3><p>要利用此漏洞，攻击者需要创建或编辑帖子并插入上面提到的短代码之一。在此示例中，我们使用locations_map简码并将属性设置 map_style为的base64编码值</p><p>{"a":"test\"&lt;/script&gt;&lt;script&gt;alert(1)&lt;/script&gt;"}。</p><p>这将导致以下简码：</p><p>[locations_map test="" map_style="eyJhIjoidGVzdFwiPC9zY3JpcHQ+PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0PiJ9Cg=="]</p><p>然后可以将该短代码插入到帖子中，然后由恶意用户发布。任何访问该职位的人都会受到有效载荷的影响，因此是XSS攻击的受害者。</p><h3>2、详细分析</h3><p>Events Manager插件提供了用于创建地图小部件的短代码，例如用于显示事件的位置。通过map_style使用简码中的属性提供自定义样式，可以直观地调整这些地图。为了防止XSS ，在shortcode属性内使用HTML 受到限制。但是，在这种情况下，可以注入任意HTML和JavaScript，因为该 map_style属性需要一个以base64编码的JSON对象。这允许绕过消毒。简码locations_map和events_map受此问题影响：</p><p>在em-shortcode.php（第43-56行），我们可以看到该属性是经过base64解码的，然后使用json_decode进行了解析。如果JSON语法有效，则将删除空格并将对象作为map_json_style变量传递到模板。请参见下面的代码段：</p><p>//add JSON style to map<br />$style = '';<br />if( !empty($args['map_style']) ){<br />    $style= base64_decode($args['map_style']);<br />    $style_json= json_decode($style);<br />    if( is_array($style_json) || is_object($style_json) ){<br />        $style = preg_replace('/[\r\n\t\s]/', '', $style);<br />    }else{<br />        $style = '';<br />    }<br />    unset($args['map_style']);<br />}<br />ob_start();<br />em_locate_template('templates/map-global.php',true, array('args'=&gt;$args, 'map_json_style' =&gt; $style));</p><p>在templates/templates/map-global.php（第16-21行）中，变量无需进一步编码即可插入脚本标签内：</p><p>&lt;script type="text/javascript"&gt;<br />    if( typeof EM == 'object'){<br />        if( typeof EM.google_map_id_styles != 'object' ) EM.google_map_id_styles = [];<br />        EM.google_map_id_styles['&lt;?php echo $args['random_id']; ?&gt;'] = &lt;?php echo $map_json_style; ?&gt;;<br />    }<br />&lt;/script&gt;</p><p>这样就完美的构成了x</p></body></html>